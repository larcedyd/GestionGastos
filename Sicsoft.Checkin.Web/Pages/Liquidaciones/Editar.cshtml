@page "{id}"
@model InversionGloblalWeb.Pages.Liquidaciones.EditarModel
@{
    ViewData["Title"] = "Liquidaciones";
}
@section Title{
    <h2><i></i> @ViewData["Title"]</h2>
}
@section breadcrumb{
    <li class="breadcrumb-item">
        <a asp-page="./Index">Liquidaciones</a>
    </li>

    <li class="breadcrumb-item active">
        <strong>Editar </strong>
    </li>
}
@section TitleAction{
    <a asp-page="./Index" class="nav-link text-dark"><i class="fa fa-arrow-circle-o-left "></i>  Regresar</a>
}
@section styles{
    <link rel="stylesheet" href="~/lib/summernote/summernote-bs4.css" />
    <link rel="stylesheet" href="~/lib/select2/css/select2.min.css" />
    <link rel="stylesheet" href="~/lib/select2/css/select2-bootstrap4.min.css" />
    <link href="~/lib/dropzone/basic.css" rel="stylesheet" />
    <link href="~/lib/dropzone/dropzone.css" rel="stylesheet" />
    <link href="~/lib/iCheck/skins/square/green.css" rel="stylesheet" />
    <link href="~/lib/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jasny-bootstrap/4.0.0/css/jasny-bootstrap.min.css">
    <style>
        /*     .tableFixHead th {
                position: sticky;
                top: 0;
                background: white;
            }*/
        td {
            border-bottom-style: solid !important;
            border-bottom-width: 1px !important;
            border-bottom-color: #dec2e6 !important;
        }

        h3 {
            font-size: 13px !important;
        }

        th {
            background-color: transparent !important;
        }

        td p {
            font-weight: 300 !important;
        }

        .lab {
            font-weight: 400;
            font-size: 13px;
        }

        .lab2 {
            font-weight: 400;
            font-size: 13px;
        }

        .label {
            color: #fff !important;
            background-color: #57b846 !important;
            cursor: pointer;
            text-decoration: underline;
            background: none;
            font-size: 17px;
            padding: 8px 18px !important;
        }

        .label-submit {
            color: #fff !important;
            background-color: #57b846 !important;
            cursor: pointer;
            background: none;
            font-size: 13px;
            padding: 8px 18px !important;
        }
        /*label
        {
            font-size: 15px;
        }*/

        #imgGalerias {
            display: none;
        }
    </style>
}
@section scripts{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/lib/summernote/summernote-bs4.min.js"></script>
    <script src="~/lib/select2/js/select2.min.js"></script>
    <script src="~/lib/dropzone/dropzone.js"></script>
    <script src="~/lib/iCheck/icheck.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[type=number]').forEach(node => node.addEventListener('keypress', e => {
                if (e.keyCode == 13) {
                    onChangeProducto();
                }
            }))
        });
    </script>
    <script>

        $(document).ready(function () {

        jQuery(document).ready(function ($) {
            $(document).ready(function () {
                $("#FecFactura").val($("#FechaI").val());
                $("#FecFactura").attr({
                    "max": $("#FechaFinal").val(),
                    "min": $("#FechaI").val()
                });
                //Este metodo le define un maximo y un minimo a la fecha a la hora de editar una fm
                $("#FecFacturaE").attr({
                    "max": $("#FechaFinal").val(),
                    "min": $("#FechaI").val()
                });
                Date.prototype.addDays = function (days) {
                    var date = new Date(this.valueOf());
                    date.setDate(date.getDate() + days);
                    return date;
                }


            });
        });


            $(":input").inputmask();
            $('.mi-selector').select2();

            $("#NomPro").val("");

            $("#PrecUniI").val(0);
            $("#descI").val(0);
            $("#TipoImpuesto").val("0").trigger('change');
            $("#idTipoGasto").val("NULL").trigger('change');
            $("#ImpuestoMonto").val(0);

            $("input:radio[name=idProveedor]:checked").val("01");
            $(".js-example-responsive").select2({
                width: 'resolve',// need to override the changed default
                height: 'resolve'
            });



            Recuperar();








        });
        var ProdCadena = [];
        var bandera = false;
        var idP = 0;
        var subtotal = 0;
        var impuestos = 0;
        var descuentos = 0;
        var totalComprobante = 0;
        var Pais = '@Model.Pais';
        var impuesto1 = 0;
        var impuesto2 = 0;
        var impuesto4 = 0;
        var impuesto8 = 0;
        var impuesto13 = 0;
        var oCargos = 0;


        function Recuperar() {
            try {



                var det = JSON.parse($("#Liquidacion").val());

                var idDelCierre = "@Model.Liquidacion.EncCierre.idCierre";
                $("#idCierre").val(idDelCierre);


            var Estado = "@Model.Liquidacion.EncCierre.Estado";
            $("#CodMoneda").val("@Model.Liquidacion.EncCierre.CodMoneda");
            console.log("Estado " + Estado);


            for (var i = 0; i < det.length; i++)
            {


                var detalle = {
                    id: det[i].id,
                    Proveedor: (det[i].NomProveedor.length > 40 ? det[i].NomProveedor.substr(0, 40) : det[i].NomProveedor),
                    CodProveedor: det[i].CodProveedor,
                    CHacienda: det[i].ConsecutivoHacienda,
                //    idTipoGasto: $("#idTipoGasto").val(),
                    Fecha: det[i].FecFactura.substr(8, 2) + "/" + det[i].FecFactura.substr(5, 2) + "/" + det[i].FecFactura.substr(0, 4),
                    SubTotal: det[i].TotalVenta,
                    Descuento: det[i].TotalDescuentos,
                    Impuesto: det[i].TotalImpuesto,
                    Total: 0,
                    TotalOtrosCargos : det[i].TotalOtrosCargos,
                    Impuesto1: det[i].Impuesto1,
                    Impuesto2: det[i].Impuesto2,
                    Impuesto4: det[i].Impuesto4,
                    Impuesto8: det[i].Impuesto8,
                    Impuesto13: det[i].Impuesto13,
                    idTipoGasto: det[i].idTipoGasto,
                    Comentario: det[i].Comentario
            };


            var subtotalT = 0;
            var descuentoT = 0;
            var impuestoT = 0;
            var totalT = 0;
                var oCargosT = 0;
                if (Pais == "P" || Pais == "N") {
                    detalle.SubTotal = parseFloat(det[i].TotalComprobante) - parseFloat(detalle.Impuesto);
                }

            subtotalT = parseFloat(detalle.SubTotal);
            descuentoT = parseFloat(detalle.Descuento);
            impuestoT = parseFloat(detalle.Impuesto);
                oCargosT = parseFloat(detalle.TotalOtrosCargos);

                    detalle.Total = (subtotalT - descuentoT) + impuestoT + oCargosT;


            ProdCadena.push(detalle);
            totalT = parseFloat(detalle.Total);
            var impuesto1T = parseFloat(detalle.Impuesto1);
            var impuesto2T = parseFloat(detalle.Impuesto2);
            var impuesto4T = parseFloat(detalle.Impuesto4);
            var impuesto8T = parseFloat(detalle.Impuesto8);
            var impuesto13T = parseFloat(detalle.Impuesto13);



            subtotal += subtotalT;
            descuentos += descuentoT;
            impuestos += impuestoT;
            oCargos += oCargosT;
            totalComprobante += totalT;
            impuesto1 += impuesto1T;
            impuesto2 += impuesto2T;
            impuesto4 += impuesto4T;
            impuesto8 += impuesto8T;
            impuesto13 += impuesto13T;

            $("#subtotal").text(formatoDecimal(parseFloat(subtotal).toFixed(2)));
            $("#descuento").text(formatoDecimal(parseFloat(descuentos).toFixed(2)));
            $("#impuesto").text(formatoDecimal(parseFloat(impuestos).toFixed(2)));
            $("#total").text(formatoDecimal(parseFloat(totalComprobante).toFixed(2)));
            $("#tOCargos").text(formatoDecimal(parseFloat(oCargos).toFixed(2)));
            $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
            $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));
            $("#impuesto4").text(formatoDecimal(parseFloat(impuesto4).toFixed(2)));
            $("#impuesto8").text(formatoDecimal(parseFloat(impuesto8).toFixed(2)));
            $("#impuesto13").text(formatoDecimal(parseFloat(impuesto13).toFixed(2)));
            }

            if (ProdCadena.length > 0) {
                $("#CodMoneda").select2({ disabled: true });
            } else {
                $("#CodMoneda").select2({ disabled: false });
            }
            LimpiarDatos();

                RellenaTabla();

            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: error

                });

            }


        }


          ///Costa Rica
        function onChangeProveedorCR(bit) {

            var ruc = $("#CodProveedor").val();
            var dv = 0;
            var nombre = $("#NomProveedor").val();

            if (bit == 1) {

                $("#CodProveedor").val("");


            } else {
                $("#NomProveedor").val("");
            }

            $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '@Url.Page("Editar", "BuscarProveedor")',
                data: { ids: $("#CodProveedor").val(), dv: "0", nombre: $("#NomProveedor").val(), CR: true  },
            success: function (result) {

                console.log(result);

                if (result != null) {

                   // if ($("#NomProveedorP").val() == "") {
                    $("#NomProveedor").val(result.nombre);
                     //   $("#DVP").val(result.dv);
                    $("#CodProveedor").val(result.ruc);
                        switch (result.ruc.replace("-", "").replace("-", "").length) {

                            case 9:
                                {
                                    $("#idProveedor1").prop('checked', true)
                                    mask2();
                                    break;
                                }
                            case 10:

                                {

                                    $("#idProveedor2").prop('checked', true)


                                    mask2();
                                    break;
                                }

                            default:
                                {
                                    $("#idProveedor3").prop('checked', true)
                                    mask2();
                                    break;
                                }


                        }


                } else {

                    $("#CodProveedor").val(ruc);

                    $("#NomProveedor").val(nombre);



                }

            },
            beforeSend: function () {

            },
            complete: function () {

            }
        });
        }


        function onChangeFecFactura() {
            if (new Date($("#FechaFinal").val()).addDays(1) < new Date($("#FecFactura").val()).addDays(1) || new Date($("#FechaI").val()).addDays(1) > new Date($("#FecFactura").val()).addDays(1)) {
                $("#FecFactura").val($("#FechaI").val());

                alert("La fecha de la factura manual no puede ser menor o mayor que la del periodo");
            }
        }
        function onChangeFecFacturaP() {
            if (new Date($("#FechaFinal").val()).addDays(1) < new Date($("#FecFacturaP").val()).addDays(1) || new Date($("#FechaI").val()).addDays(1) > new Date($("#FecFacturaP").val()).addDays(1)) {
                $("#FecFacturaP").val($("#FechaI").val());

                alert("La fecha de la factura manual no puede ser menor o mayor que la del periodo");
            }
        }

        function onChangeFecFacturaN() {
            if (new Date($("#FechaFinal").val()).addDays(1) < new Date($("#FecFacturaN").val()).addDays(1) || new Date($("#FechaI").val()).addDays(1) > new Date($("#FecFacturaN").val()).addDays(1)) {
                $("#FecFacturaN").val($("#FechaI").val());

                alert("La fecha de la factura manual no puede ser menor o mayor que la del periodo");
            }
        }

    function onChangeProducto() {


        $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '@Url.Page("Editar", "Buscar")',
            data: { idB: $("#Busqueda").val(), cierre: $("#idCierre").val() },
            success: function (result) {


                $("#Existencia").text("");
                if (result != null) {

                    if (result.nomProveedor.length > 40) {
                        $("#Proveedor").text(result.nomProveedor.substr(0, 40));
                    } else {
                        $("#Proveedor").text(result.nomProveedor);
                    }
                    $("#id").val(result.id);
                    $("#CHacienda").text(result.consecutivoHacienda);
                    $("#FechaFac").text(result.fecFactura.substr(8, 2) + "/" + result.fecFactura.substr(5, 2) + "/" + result.fecFactura.substr(0, 4));


                    $("#SubTotal").text(formatoDecimal(parseFloat(result.totalVenta)));

                    $("#Impuesto").text(formatoDecimal(parseFloat(result.totalImpuesto)));
                    $("#Descuento").text(formatoDecimal(parseFloat(result.totalDescuentos)));
                    //  $("#idTipoGasto").val(result.idTipoGasto).trigger('change.select2');;

                    $("#sub").val(result.totalVenta);
                    $("#desc").val(result.totalDescuentos);
                    $("#imp").val(result.totalImpuesto);
                    $("#otrosCargos").val(result.totalOtrosCargos);

                    $("#imp1").val(result.impuesto1);
                    $("#imp2").val(result.impuesto2);
                    $("#imp4").val(result.impuesto4);
                    $("#imp8").val(result.impuesto8);
                    $("#imp13").val(result.impuesto13);
                    $("#otrosCargos").val(result.totalOtrosCargos);
                    $("#idTipoGastoEditar").val(result.idTipoGasto).trigger('change.select2');
                    $("#tipoGasto").text(result.tipoGasto);
                    $("#TotalComp").text(formatoDecimal(result.totalComprobante));


                    $("#adjunto").attr('href', result.pdfFactura);
                    var detalle = {
                        id: $("#id").val(),
                        Proveedor: $("#Proveedor").text(),
                        CHacienda: $("#CHacienda").text(),
                        //    idTipoGasto: $("#idTipoGasto").val(),
                        Fecha: $("#FechaFac").text(),
                        SubTotal: $("#sub").val(),
                        Descuento: $("#desc").val(),
                        Impuesto: $("#imp").val(),
                        Total: 0,
                        Impuesto1: $("#imp1").val(),
                        Impuesto2: $("#imp2").val(),
                        Impuesto4: $("#imp4").val(),
                        Impuesto8: $("#imp8").val(),
                        Impuesto13: $("#imp13").val(),
                        TotalOtrosCargos: $("#otrosCargos").val()
                    };
                    $("#monedaFactura").val(result.codMoneda);
                    console.log("Ya esta asignada: " + result.idCierre);
                    if (ProdCadena.find(a => a.id == parseInt(detalle.id)) != undefined) {
                        var str = "Ya esta asignada";
                        $("#Existencia").text(str);
                        LimpiarDatos();
                    } else if ((result.idCierre != 0 && result.idCierre != parseInt($("#idCierre").val()))) {
                        var str = "La Factura: No ha llegado al correo, No existe, No es de este periodo o Ya está asignada. Puedes intentar colocando más dígitos del consecutivo de hacienda o esperar unos minutos mientras llega.";
                        $("#Existencia").text(str);
                        LimpiarDatos();
                    }

                } else {

                    var str = "La Factura: No ha llegado al correo, No existe, No es de este periodo o Ya está asignada. Puedes intentar colocando más dígitos del consecutivo de hacienda o esperar unos minutos mientras llega.";
                    $("#Existencia").text(str);
                    LimpiarDatos();



                }

            },
            beforeSend: function () {

            },
            complete: function () {

            }
        });

        }

        function ValidarAntesTabla() {
            if ($("#Proveedor").text() == "") {
                return false;
            } else if ($("#idTipoGastoEditar").val() == "0" || $("#idTipoGastoEditar").val() == null) {
                return false;
            }

            else {
                return true;
            }
        }

        function validarMoneda() {
            if ($("#CodMoneda").val() != $("#monedaFactura").val()) {
                return false;
            }
            else {
                return true;
            }
        }
       function InsertarProductoTabla() {



           if (ValidarAntesTabla()) {
               if (validarMoneda()) {



                   var detalle = {
                       id: $("#id").val(),
                       Proveedor: $("#Proveedor").text(),
                       CHacienda: $("#CHacienda").text(),
                       CodProveedor: $("#Proveedor").text(),
                       //    idTipoGasto: $("#idTipoGasto").val(),
                       Fecha: $("#FechaFac").text(),
                       SubTotal: $("#sub").val(),
                       Descuento: $("#desc").val(),
                       Impuesto: $("#imp").val(),
                       Total: 0,
                       Impuesto1: $("#imp1").val(),
                       Impuesto2: $("#imp2").val(),
                       Impuesto4: $("#imp4").val(),
                       Impuesto8: $("#imp8").val(),
                       Impuesto13: $("#imp13").val(),
                       idTipoGasto: $("#idTipoGastoEditar").val(),
                       TotalOtrosCargos: $("#otrosCargos").val(),
                       Comentario: $("#ComenFac").val()
                   };


                   var subtotalT = 0;
                   var descuentoT = 0;
                   var impuestoT = 0;
                   var totalT = 0;
                   var oCargosT = 0;
                   subtotalT = parseFloat(detalle.SubTotal);
                   descuentoT = parseFloat(detalle.Descuento);
                   impuestoT = parseFloat(detalle.Impuesto);
                   oCargosT = parseFloat(detalle.TotalOtrosCargos);
                   detalle.Total = (subtotalT - descuentoT) + impuestoT + oCargosT;
                   ProdCadena.push(detalle);
                   totalT = parseFloat(detalle.Total);
                   var impuesto1T = parseFloat(detalle.Impuesto1);
                   var impuesto2T = parseFloat(detalle.Impuesto2);
                   var impuesto4T = parseFloat(detalle.Impuesto4);
                   var impuesto8T = parseFloat(detalle.Impuesto8);
                   var impuesto13T = parseFloat(detalle.Impuesto13);


                   subtotal += subtotalT;
                   descuentos += descuentoT;
                   impuestos += impuestoT;

                   totalComprobante += totalT;
                   impuesto1 += impuesto1T;
                   impuesto2 += impuesto2T;
                   impuesto4 += impuesto4T;
                   impuesto8 += impuesto8T;
                   impuesto13 += impuesto13T;
                   oCargos += oCargosT;
                   $("#subtotal").text(formatoDecimal(parseFloat(subtotal).toFixed(2)));
                   $("#descuento").text(formatoDecimal(parseFloat(descuentos).toFixed(2)));
                   $("#impuesto").text(formatoDecimal(parseFloat(impuestos).toFixed(2)));
                   $("#total").text(formatoDecimal(parseFloat(totalComprobante).toFixed(2)));
                   $("#tOCargos").text(formatoDecimal(parseFloat(oCargos).toFixed(2)));
                   $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
                   $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));
                   $("#impuesto4").text(formatoDecimal(parseFloat(impuesto4).toFixed(2)));
                   $("#impuesto8").text(formatoDecimal(parseFloat(impuesto8).toFixed(2)));
                   $("#impuesto13").text(formatoDecimal(parseFloat(impuesto13).toFixed(2)));

                   if (ProdCadena.length > 0) {
                       $("#CodMoneda").select2({ disabled: true });
                   } else {
                       $("#CodMoneda").select2({ disabled: false });
                   }
                   LimpiarDatos();

                   RellenaTabla();
               } else {
                   Swal.fire({
                       icon: 'error',
                       title: 'Oops...',
                       text: 'Pareciera que la moneda especificada no es la misma que la factura.'

                   });
               }
           }
           else {
               Swal.fire({
                   icon: 'error',
                   title: 'Oops...',
                   text: 'Pareciera que aún falta un campo por llenar'

               });
           }
        }
        function LimpiarDatos() {
            $("#Proveedor").text("");
            $("#monedaFactura").val("");

            $("#CHacienda").text("");
            $("#FechaFac").text("");


            $("#SubTotal").text("");

            $("#Impuesto").text("");
            $("#Descuento").text("");
            //$("#idTipoGasto").val("");
            $("#TotalComp").text("");
            $("#imp1").val(0);
            $("#imp2").val(0);
            $("#imp4").val(0);
            $("#imp8").val(0);
            $("#imp13").val(0);
            $("#otrosCargos").val(0);
            $("#Busqueda").val("")
            $("#adjunto").attr('href', '');
            $("#tipoGasto").text("");
           // $("#Busqueda").val("NULL").trigger('change.select2');
            $("#ComenFac").val("");
            $("#idTipoGastoEditar").val("NULL").trigger('change.select2');
        }

        function RellenaTabla() {
            var sOptions = '';

            $("#tbody").html('');

            for (var i = 0; i < ProdCadena.length; i++) {
                sOptions += '<tr>';

                sOptions += '<td align="center" style="padding-top:13px;">    <a style="margin-left: -1%; position: inherit !important;" onclick = "javascript: EliminaProducto(' + i + ')" title="Eliminar" class="fa fa-trash icono"></a> ';
                if (ProdCadena[i].CHacienda.trim().length < 20) {
                    sOptions += '<td align="center" style="padding-top:15px;">  <a style="font-size:13px; color: blue; text-decoration: underline;" onclick="javascript: AbrirModalEdicion(' + ProdCadena[i].id + ')">' + ProdCadena[i].CHacienda + '</a></td>';
                } else {
                    sOptions += '<td align="center" style="padding-top:15px;">  <p style="font-size:13px;" >' + ProdCadena[i].CHacienda + '</p></td>';
                }
                sOptions += '<td align="center" style="padding-top:15px;">  <p style="font-size:13px;">' + ProdCadena[i].Fecha + '</p></td>';
                sOptions += '<td align="left" style="padding-top:15px;">  <p style="font-size:13px;">' + ProdCadena[i].Proveedor + '</p></td>';
                sOptions += '<td align="right" style="padding-top:13px;">  <p style="font-size:13px;">' + formatoDecimal(ProdCadena[i].Total) + '</p></td>';





                sOptions += '</tr>'
            }
            $("#tbody").html(sOptions);
        }
        function EliminaProducto(campo) {
            console.log("campo: " + campo);
            Swal.fire({
                title: '¿Desea eliminar esta factura?',
                showDenyButton: true,
                showCancelButton: false,
                confirmButtonText: `Aceptar`,
                denyButtonText: `Cancelar`,
                customClass: {
                    confirmButton: 'swalBtnColor',
                    denyButton: 'swalDeny'
                },
            }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {
                    console.log(ProdCadena[campo]);
                    var subtotalT = 0;
                    var descuentoT = 0;
                    var impuestoT = 0;
                    var oCargosT = 0;
                    subtotalT = parseFloat(ProdCadena[campo].SubTotal);
                    descuentoT = parseFloat(ProdCadena[campo].Descuento);
                    impuestoT = parseFloat(ProdCadena[campo].Impuesto);
                    oCargosT = parseFloat(ProdCadena[campo].TotalOtrosCargos);
                    totalT = parseFloat(ProdCadena[campo].Total);

                    subtotal -= subtotalT;
                    descuentos -= descuentoT;
                    impuestos -= impuestoT;
                    oCargos -= oCargosT;
                    totalComprobante -= totalT;
                    var impuesto1T = parseFloat(ProdCadena[campo].Impuesto1);
                    var impuesto2T = parseFloat(ProdCadena[campo].Impuesto2);
                    var impuesto4T = parseFloat(ProdCadena[campo].Impuesto4);
                    var impuesto8T = parseFloat(ProdCadena[campo].Impuesto8);
                    var impuesto13T = parseFloat(ProdCadena[campo].Impuesto13);


                    impuesto1 -= impuesto1T;
                    impuesto2 -= impuesto2T;
                    impuesto4 -= impuesto4T;
                    impuesto8 -= impuesto8T;
                    impuesto13 -= impuesto13T;

                    $("#subtotal").text(formatoDecimal(subtotal.toFixed(2)));
                    $("#descuento").text(formatoDecimal(descuentos.toFixed(2)));
                    $("#impuesto").text(formatoDecimal(impuestos.toFixed(2)));
                    $("#total").text(formatoDecimal(totalComprobante.toFixed(2)));
                    $("#tOCargos").text(formatoDecimal(parseFloat(oCargos).toFixed(2)));
                    $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
                    $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));
                    $("#impuesto4").text(formatoDecimal(parseFloat(impuesto4).toFixed(2)));
                    $("#impuesto8").text(formatoDecimal(parseFloat(impuesto8).toFixed(2)));
                    $("#impuesto13").text(formatoDecimal(parseFloat(impuesto13).toFixed(2)));

                    ProdCadena.splice(campo, 1);
                    if (ProdCadena.length > 0) {
                        $("#CodMoneda").select2({ disabled: true });
                    } else {
                        $("#CodMoneda").select2({ disabled: false });
                    }
                    RellenaTabla();

                }
            })

        }



        function validar(enc) {
            console.log(enc);
            if (enc.SubTotal == "" || enc.SubTotal == null) {

                return false;
            } else if (enc.FechaInicial == "" || enc.FechaInicial == null) {
                return false;
            } else if (ProdCadena.length == 0)
            {
                return false;
            } else if (enc.CodMoneda == "NULL") {
                return false;
            }
            else {
                return true;
            }
        }


        function Generar() {

            var EncCompras =
            {
                idCierre: $("#idCierre").val(),
                Periodo: $("#Periodo").val(),
                CodMoneda: $("#CodMoneda").val(),
                FechaInicial: $("#FechaI").val(),
                FechaFinal: $("#FechaFinal").val(),
                SubTotal: $("#subtotal").text(),
                CodMoneda: $("#CodMoneda").val(),
                Impuestos: $("#impuesto").text(),
                Descuento: $("#descuento").text(),
                Impuesto1: $("#impuesto1").text() ,
                Impuesto2: $("#impuesto2").text()  ,
                Impuesto4: $("#impuesto4").text(),
                Impuesto8: $("#impuesto8").text(),
                Impuesto13: $("#impuesto13").text(),
                TotalOtrosCargos: $("#tOCargos").text(),
                Total: $("#total").text(),
                Observacion: $("#Comentario").val()
            };



            var Cadena = [];

            if (EncCompras.Impuesto4 == "") {
                EncCompras.Impuesto4 = "0";
            }
            if (EncCompras.Impuesto8 == "") {
                EncCompras.Impuesto8 = "0";
            }
            if (EncCompras.Impuesto13 == "") {
                EncCompras.Impuesto13 = "0";
            }

            if (EncCompras.TotalOtrosCargos == "") {
                EncCompras.TotalOtrosCargos = "0";
            }

            for (var i = 0; i < ProdCadena.length; i++) {
                var det = {
                    idFactura: ProdCadena[i].id,
                    idTipoGasto: ProdCadena[i].idTipoGasto,
                    Comentario: ProdCadena[i].Comentario
                };
                Cadena.push(det);
            }


            var DetCompras = Cadena;


            var recibido = {
                EncCompras,
                DetCompras
            }


            console.log(JSON.stringify(recibido));

            if (validar(EncCompras)) {

                Swal.fire({
                    title: '¿Desea guardar los cambios de esta liquidación?',
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: `Aceptar`,
                    denyButtonText: `Cancelar`,
                    customClass: {
                        confirmButton: 'swalBtnColor',
                        denyButton: 'swalDeny'
                    },
                }).then((result) => {
                    if (result.isConfirmed) {
                        var recibidos = JSON.stringify(recibido);

                        $.ajax({
                            type: 'POST',

                            url: '@Url.Page("Editar", "Generar")',
                            dataType: 'json',
                            data: { recibidos: recibidos.toString() },
                            headers: {
                                RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                            },
                            success: function (json) {

                                $("#divProcesando").hide();

                                if ($('.modal-backdrop').is(':visible')) {

                                    $('body').removeClass('modal-open');
                                    $('.modal-backdrop').hide();
                                }
                                console.log("resultado " + json.mensaje);
                                if (json.success == true) {
                                    Swal.fire({
                                        title: "Ha sido generado con éxito",

                                        icon: 'success',
                                        showCancelButton: false,

                                        confirmButtonText: 'OK',
                                        customClass: {
                                            confirmButton: 'swalBtnColor',

                                        },
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            location.reload();
                                        }
                                    })

                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: 'Ha ocurrido un error al intentar guardar '

                                    })
                                }
                            },

                            beforeSend: function (xhr) {

                                $("#divProcesando").modal("show");
                            },
                            complete: function () {

                            },
                            error: function (error) {

                            }
                        });
                    }
                }
               )

            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Pareciera que aún falta un campo por llenar'

                });
            }

        }


        function EnviarRevision() {
            Swal.fire({
                title: '¿Desea enviar a revisión esta liquidación?',
                showDenyButton: true,
                showCancelButton: false,
                confirmButtonText: `Aceptar`,
                denyButtonText: `Cancelar`,
                customClass: {
                    confirmButton: 'swalBtnColor',
                    denyButton: 'swalDeny'
                },
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: 'GET',

                        url: '@Url.Page("Editar", "Estado")',
                        dataType: 'text',
                        data: { idB: $("#idCierre").val() },
                        headers: {
                            RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                        },
                        success: function (json) {

                            $("#divProcesando").hide();

                            if ($('.modal-backdrop').is(':visible')) {

                                $('body').removeClass('modal-open');
                                $('.modal-backdrop').hide();
                            }
                            console.log("resultado " + json);
                            if (json == "true") {
                                Swal.fire({
                                    title: "Ha sido enviado con éxito",

                                    icon: 'success',
                                    showCancelButton: false,

                                    confirmButtonText: 'OK',
                                    customClass: {
                                        confirmButton: 'swalBtnColor',

                                    },
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = window.location.href.split("/Editar")[0];
                                    }
                                })

                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: 'Ha ocurrido un error al intentar enviar'

                                })
                            }
                        },

                        beforeSend: function (xhr) {

                            $("#divProcesando").modal("show");
                        },
                        complete: function () {

                        },
                        error: function (error) {

                        }
                    });
                }
            })

        }


        //Generar y Enviar
         function GeneraryEnviar() {

            var EncCompras =
            {
                idCierre: $("#idCierre").val(),
                Periodo: $("#Periodo").val(),

                FechaInicial: $("#FechaI").val(),
                FechaFinal: $("#FechaFinal").val(),
                SubTotal: $("#subtotal").text(),
                CodMoneda: $("#CodMoneda").val(),
                Impuestos: $("#impuesto").text(),
                Descuento: $("#descuento").text(),
                Impuesto1: $("#impuesto1").text() ,
                Impuesto2: $("#impuesto2").text()  ,
                Impuesto4: $("#impuesto4").text(),
                Impuesto8: $("#impuesto8").text(),
                Impuesto13: $("#impuesto13").text(),
                TotalOtrosCargos: $("#tOCargos").text(),
                Total: $("#total").text(),
                Observacion: $("#Comentario").val()
            };

            var Cadena = [];

             if (EncCompras.Impuesto4 == "") {
                 EncCompras.Impuesto4 = "0";
             }
             if (EncCompras.Impuesto8 == "") {
                 EncCompras.Impuesto8 = "0";
             }
             if (EncCompras.Impuesto13 == "") {
                 EncCompras.Impuesto13 = "0";
             }

             if (EncCompras.TotalOtrosCargos == "") {
                 EncCompras.TotalOtrosCargos = "0";
             }

            for (var i = 0; i < ProdCadena.length; i++) {
                var det = {
                    idFactura: ProdCadena[i].id,
                    idTipoGasto: ProdCadena[i].idTipoGasto,
                    Comentario: ProdCadena[i].Comentario
                };
                Cadena.push(det);
            }


            var DetCompras = Cadena;


            var recibido = {
                EncCompras,
                DetCompras
            }


            console.log(JSON.stringify(recibido));

            if (validar(EncCompras)) {

                Swal.fire({
                    title: '¿Desea guardar y enviar a revisión esta liquidación?',
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: `Aceptar`,
                    denyButtonText: `Cancelar`,
                    customClass: {
                        confirmButton: 'swalBtnColor',
                        denyButton: 'swalDeny'
                    },
                }).then((result) => {
                    if (result.isConfirmed) {
                        var recibidos = JSON.stringify(recibido);

                        $.ajax({
                            type: 'POST',

                            url: '@Url.Page("Editar", "GeneraryEnviar")',
                            dataType: 'json',
                            data: { recibidos: recibidos.toString() },
                            headers: {
                                RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                            },
                            success: function (json) {

                                $("#divProcesando").hide();

                                if ($('.modal-backdrop').is(':visible')) {

                                    $('body').removeClass('modal-open');
                                    $('.modal-backdrop').hide();
                                }
                                console.log("resultado " + json);
                                if (json.success == true) {
                                    Swal.fire({
                                        title: "Ha sido generado con éxito",

                                        icon: 'success',
                                        showCancelButton: false,

                                        confirmButtonText: 'OK',
                                        customClass: {
                                            confirmButton: 'swalBtnColor',

                                        },
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            window.location.href = window.location.href.split("/Editar")[0];
                                        }
                                    })

                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: 'Ha ocurrido un error al intentar guardar'

                                    })
                                }
                            },

                            beforeSend: function (xhr) {

                                $("#divProcesando").modal("show");
                            },
                            complete: function () {

                            },
                            error: function (error) {

                            }
                        });
                    }
                }
               )

            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Pareciera que aún falta un campo por llenar'

                });
            }

        }


        const formatter = new Intl.NumberFormat('es-CR', {
            style: 'currency',
            currency: 'CRC',
            minimumFractionDigits: 0
        })
    </script>

}
@using Newtonsoft.Json;

<div class="row">
    <div class="col-sm-6">
        <div class="ibox ">
            <input hidden id="Liquidacion" value="@JsonConvert.SerializeObject(Model.Objeto)" />
            <div class="ibox-content">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input id="idCierre" hidden />
                <div class="row">
                    <div class="col-sm-6">

                        <label class="col-form-label">Periodo:</label>
                        <div class="form-group row">
                            <div class="col-sm-8">

                                <input type="text" readonly value="@Model.Periodo" id="Periodo" class="form-control">
                            </div>
                        </div>

                        <label class="col-form-label">Fecha Inicial:</label>
                        <div class="form-group row">
                            <div class="col-sm-12">
                                <input type="date" readonly disabled="disabled" asp-for="filtro.FechaInicio" id="FechaI" class="form-control">

                            </div>
                        </div>
                        <label class="col-form-label">Moneda:</label>
                        <div class="form-group row">
                            <div class="col-sm-12">

                                <select id="CodMoneda" class="form-control  mi-selector">
                                    @*<option value="NULL" selected>-Moneda-</option>*@

                                    <option value="COR">Córdobas</option>

                                    <option value="CRC">Colones</option>
                                    <option value="USD">Dólares</option>
                                    <option value="EUR">Euros</option>


                                </select>
                            </div>
                        </div>

                    </div>


                    <div class="col-sm-6">
                        <label class="col-form-label">Usuario:</label>
                        <div class="form-group row">
                            <div class="col-sm-12">
                                <input type="text" readonly id="Cliente" value="@Model.Usuario.Nombre" class="form-control">

                            </div>
                        </div>
                        <label class="col-form-label">Fecha Final:</label>
                        <div class="form-group row">
                            <div class="col-sm-12">
                                <input type="date" readonly disabled="disabled" asp-for="filtro.FechaFinal" id="FechaFinal" class="form-control">

                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
        <div class="ibox">
            @if (Model.Pais == "C")
            {
                <div class="ibox-content">

                    <div class="row">
                        <div class="col-sm-12" style="text-align: right;">
                            <a title="Agregar Factura Manual" id="FacManual" onclick="javascript: AbrirModal();" style="color: #57b846;">+ Agregar Factura Manual</a>
                        </div>
                        <div class="col-sm-12">
                            <label class="col-form-label">Factura:</label>
                            <div class="form-group row">
                                <div class="col-sm-6">
                                    <input id="Busqueda" class="form-control" type="number" />

                                </div>
                                <div class="col-sm-3">

                                    <button title="Buscar" type="submit" class="btn btn btn-primary" onclick="javascript: onChangeProducto();"> <i class="fa fa-search"></i></button>
                                </div>
                            </div>

                            <input hidden id="sub" type="number" />
                            <input hidden id="desc" type="number" />
                            <input hidden id="imp" type="number" />
                            <input hidden id="monedaFactura" />
                            <input hidden id="imp1" type="number" />
                            <input hidden id="imp2" type="number" />
                            <input hidden id="imp4" type="number" />
                            <input hidden id="imp8" type="number" />
                            <input hidden id="imp13" type="number" />
                            <input hidden id="otrosCargos" type="number" />
                            <label id="Existencia" style="color: red;"> </label>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group row">
                                        <div class="col-sm-12">
                                            <label class="col-form-label">Proveedor:</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <label id="Proveedor" style="line-height: 32px;">
                                            </label>

                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <div class="col-sm-12">
                                            <label class="col-form-label">Consecutivo:</label>

                                        </div>
                                        <div class="col-sm-12" style="text-align: left;">
                                            <label id="CHacienda" style="line-height: 32px;">
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <div class="col-sm-12">
                                            <label class="col-form-label">Descuento:</label>

                                        </div>
                                        <div class="col-sm-6" style="text-align: right;">
                                            <label id="Descuento" style="line-height: 32px;">
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <div class="col-sm-12">
                                            <label class="col-form-label">Total:</label>

                                        </div>
                                        <div class="col-sm-6" style="text-align: right;">
                                            <label id="TotalComp" style="line-height: 32px;">
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <div class="col-sm-12">
                                            <label class="col-form-label">Tipo Gasto:</label>

                                        </div>
                                        <div class="col-sm-8">


                                            <select id="idTipoGastoEditar" class="form-control  mi-selector">
                                                <option value="0" selected>-Sin Asignar-</option>
                                                @foreach (var item in Model.Gastos.OrderBy(a => a.Nombre))
                                                {
                                                    <option value="@item.idTipoGasto">@item.Nombre</option>
                                                }




                                            </select>

                                        </div>



                                    </div>

                                </div>
                                <div class="col-sm-6">

                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <label class="col-form-label">Fecha:</label>
                                            <input readonly hidden id="id" />
                                        </div>
                                        <div class="col-sm-12">
                                            <label id="FechaFac" style="line-height: 32px;">
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <label class="col-form-label">SubTotal:</label>
                                        </div>
                                        <div class="col-sm-6" style="text-align: right;">
                                            <label id="SubTotal" style="line-height: 32px;">
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <div class="col-sm-12">
                                            <label class="col-form-label">Impuesto:</label>

                                        </div>
                                        <div class="col-sm-6" style="text-align: right;">
                                            <label id="Impuesto" style="line-height: 32px;">
                                            </label>
                                        </div>
                                    </div>


                                    <div class="form-group row">
                                        <div class="col-sm-12">
                                            <label class="col-form-label"></label>

                                        </div>
                                        <div class="col-sm-6" style="text-align: right;">
                                            <a href="" target="_blank" id="adjunto" title="Mirar Adjunto de la Factura" class="fa fa-paperclip icono"></a>
                                        </div>
                                    </div>


                                </div>
                                <div class="col-sm-12">
                                    <div class="form-group row">
                                        <div class="col-sm-12">
                                            <label class="col-form-label">Comentario:</label>

                                        </div>
                                        <div class="col-sm-12" style="text-align: right;">
                                            <input class="form-control" maxlength="100" id="ComenFac" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="col-sm-6">




                        </div>
                    </div>

                </div>


            }
            else if (Model.Pais == "P")
            {
                <div class="ibox">
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-6">
                                <center>
                                    <img id="imgPrincipalGP" src="/img/cm.jpg" alt="image" style="width:250px; height:250px;border-radius: 15px;" class="img-fluid" />
                                    <br />
                                    <br />

                                    <label style="font-size: 13px;" class="label" for="imgPrincipalUploadGP">Subir Imagen</label><input id="imgPrincipalUploadGP" accept=".jpg, .png" style="opacity:0; display:none;" type="file" name="imgPrincipalUploadGP" />

                                </center>
                            </div>
                            <div class="col-sm-6">



                                <label class="col-form-label">Tipo Identificación:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12" style="text-align: center;">
                                        <input type="radio" name="idProveedorP" id="idProveedor1P" onclick="javascript: mask2P();" value="01"> Natural &nbsp;
                                        <input type="radio" name="idProveedorP" id="idProveedor2P" onclick="javascript: mask2P();" value="02"> Jurídica &nbsp;
                                        <input type="radio" name="idProveedorP" id="idProveedor3P" onclick="javascript: mask2P();" value="03"> Extranjero
                                    </div>
                                </div>


                                <label class="col-form-label">RUC Proveedor:</label>
                                <div class="form-group row">
                                    <div class="col-sm-8">

                                        <input type="text" id="CodProveedorP" list="proveedoresP" readonly class="form-control">
                                        <datalist id="proveedoresP">
                                            @foreach (var item in Model.Proveedores)
                                            {
                                                <option value="@item.RUC"> @item.RUC</option>

                                            }



                                        </datalist>
                                    </div>
                                    <div class="col-sm-4">

                                        <input type="text" id="DVP" readonly list="dvP" placeholder="D.V" onchange="javascript: onChangeProveedorP(0)" class="form-control">
                                        <datalist id="dvP">
                                            @foreach (var item in Model.Proveedores)
                                            {
                                                <option value="@item.DV"> @item.DV</option>

                                            }



                                        </datalist>
                                    </div>
                                </div>

                                <label class="col-form-label">Nombre Proveedor:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" asp-for="Objeto1.EncCompras.NomProveedor" list="NombresProveedoresP" onchange="javascript: onChangeProveedorP(1)" id="NomProveedorP" class="form-control">
                                        <datalist id="NombresProveedoresP">
                                            @foreach (var item in Model.Proveedores)
                                            {
                                                <option value="@item.Nombre"> @item.Nombre</option>

                                            }



                                        </datalist>

                                    </div>
                                </div>


                                <label class="col-form-label">Número Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" asp-for="Objeto1.EncCompras.NumFactura" id="NumFacturaP" class="form-control" maxlength="5" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" placeholder="Digite los últimos 5 dígitos">
                                    </div>
                                </div>

                                <label class="col-form-label">Fecha Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="date" asp-for="Objeto1.EncCompras.FecFactura" onchange="javascript: onChangeFecFacturaP();" id="FecFacturaP" class="form-control">
                                    </div>
                                </div>


                                <label class="col-form-label">Comentarios:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" asp-for="Objeto1.EncCompras.Comentario" id="ComentarioFacturaP" class="form-control">
                                    </div>
                                </div>



                                <label class="col-form-label">Tipo Documento:</label>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura Fiscal
                                            <input type="checkbox" id="simpP" onchange="javascript: checkP('1');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura Exterior
                                            <input type="checkbox" id="extP" onchange="javascript: checkP('2');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Gastos Varios
                                            <input type="checkbox" id="varP" onchange="javascript: checkP('3');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura Electrónica
                                            <input type="checkbox" id="nrecP" onchange="javascript: checkP('4');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                </div>




                            </div>

                        </div>



                    </div>
                </div>

                <div class="ibox">
                    <label class="text-danger" id="ErrorFacturaP" style="display: none;"> Ha ocurrido un error al intentar insertar la factura, por favor volver a intentar</label>
                    <label class="text-danger" id="FaltaDatosP" style="display: none;"> Parecen que faltan datos por rellenar</label>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-3">
                                <label class="col-form-label">Detalle:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" id="NomProP" class="form-control">
                                    </div>
                                </div>
                                <div hidden>

                                    <label class="col-form-label">Monto Descuento:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <input type="number" id="descIP" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3">

                                <label class="col-form-label">Tipo Impuesto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="TipoImpuestoP" class="form-control  ">
                                            <option value="NULL">-IVA-</option>

                                            <option value="0">Exento</option>
                                            <option value="7" selected>
                                                ITBMS(7%)
                                            </option>
                                            <option value="10">
                                                ITBMS(10%)
                                            </option>



                                        </select>
                                    </div>
                                </div>

                                <div hidden>

                                    <label class="col-form-label">Monto Impuesto:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <input type="number" id="ImpuestoMontoP" class="form-control">
                                        </div>
                                    </div>

                                </div>



                            </div>
                            <div class="col-sm-3">
                                <label class="col-form-label">Tipo Gasto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="idTipoGastoP" class="form-control " onchange="javascript: onChangeTipoGasto()">
                                            <option value="NULL" selected>-Tipo Gasto-</option>
                                            @foreach (var item in Model.Gastos.OrderBy(a => a.Nombre))
                                            {
                                                <option value="@item.idTipoGasto">@item.Nombre</option>
                                            }




                                        </select>
                                    </div>
                                </div>

                            </div>
                            <div class="col-sm-3">
                                <label class="col-form-label">Monto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" id="PrecUniP" class="form-control">
                                    </div>
                                </div>






                            </div>

                            <!--En caso de ser combustible-->
                            <div class="col-sm-12" hidden id="Combustible">
                                <div class="row">
                                    <div class="col-sm-3">
                                        <label class="col-form-label">Cantidad Litros:</label>
                                        <div class="form-group row">
                                            <div class="col-sm-12">

                                                <input type="number" id="CantLitrosP" value="1" class="form-control">
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-sm-3">
                                        <label class="col-form-label">Tipo Combustible:</label>
                                        <div class="form-group row">
                                            <div class="col-sm-12">

                                                <select id="idTipoCombP" class="form-control ">
                                                    <option value="" selected>-Tipo Combustible-</option>

                                                    <option value="Diesel">Diesel</option>
                                                    <option value="Gasolina 95">Gasolina 95</option>
                                                    <option value="Gasolina 90">Gasolina 90</option>
                                                    <option value="Gas LP">Gas LP</option>


                                                </select>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <!--Termina En caso de ser combustible-->
                            <div class="col-sm-12">
                                <div class="row">
                                    <div class="col-sm-8"></div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        @*<button onclick="javascript: AgregarProductosI();" class="btn btn-w-m btn-primary" title="Agregar a la lista">+ Agregar</button>*@
                                        <button id="buttonSpinP" onclick="javascript: EnviarFCP();" class="ladda-button green expand-left"><span class="label-submit">Agregar Factura</span> <span class="spinner"></span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!--Tabla de mentiras-->
                <div class="ibox" hidden>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-12">

                                <div class="table-responsive tableFixHead" style=" overflow-y:scroll;    z-index: 5; height: 300px;">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th align="center" style=" text-align: center;"><h3>Nombre</h3></th>

                                                <th align="center" style=" text-align: center;"><h3>Precio Unitario</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Descuento</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Impuesto</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Total</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Eliminar</h3></th>


                                            </tr>

                                        </thead>
                                        <tbody id="tbodyIP">
                                        </tbody>
                                    </table>

                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-8">

                                    </div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        <div class="row">

                                            <div class="col-sm-12">

                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table; font-weight: 500 !important; font-style: normal;">SubTotal:</label>

                                                            </td>
                                                            <td>
                                                                <label id="subtotalIP" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>

                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Descuento:</label>

                                                            </td>
                                                            <td>
                                                                <label id="descuentoIP" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Impuesto:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuestoIP" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 1:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto1IP" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 2:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto2IP" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 4:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto4IP" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 8:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto8IP" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 13:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto13IP" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Total:</label>

                                                            </td>
                                                            <td>
                                                                <label id="totalIP" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>


                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (Model.Pais == "N")
            {
                <div class="ibox">
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-6">
                                <center>
                                    <img id="imgPrincipalGN" src="/img/cm.jpg" alt="image" style="width:250px; height:250px;border-radius: 15px;" class="img-fluid" />
                                    <br />
                                    <br />

                                    <label style="font-size: 13px;" class="label" for="imgPrincipalUploadGN">Subir Imagen</label><input id="imgPrincipalUploadGN" accept=".jpg, .png" style="opacity:0; display:none;" type="file" name="imgPrincipalUploadGN" />

                                </center>
                            </div>
                            <div class="col-sm-6">



                                <label class="col-form-label">Tipo Identificación:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12" style="text-align: center;">
                                        <input type="radio" name="idProveedorN" id="idProveedor1N" onclick="javascript: mask2N();" value="01"> Natural &nbsp;
                                        <input type="radio" name="idProveedorN" id="idProveedor2N" onclick="javascript: maskN();" value="02"> Jurídica &nbsp;
                                        <input type="radio" name="idProveedorN" id="idProveedor3N" onclick="javascript: mask2N();" value="03"> Extranjero
                                    </div>
                                </div>


                                <label class="col-form-label">Cédula Proveedor:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" id="CodProveedorN" list="proveedoresN" onchange="javascript: onChangeProveedorN(0)"  class="form-control">
                                        <datalist id="proveedoresN">
                                            @foreach (var item in Model.Proveedores)
                                            {
                                                <option value="@item.RUC"> @item.RUC</option>

                                            }



                                        </datalist>
                                    </div>
                                    @*<div class="col-sm-4">

                                            <input type="text" id="DVP" readonly list="dvP" placeholder="D.V" onchange="javascript: onChangeProveedorP(0)" class="form-control">
                                            <datalist id="dvP">
                                                @foreach (var item in Model.Proveedores)
                                                {
                                                    <option value="@item.DV"> @item.DV</option>

                                                }



                                            </datalist>
                                        </div>*@
                                </div>

                                <label class="col-form-label">Nombre Proveedor:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" asp-for="Objeto1.EncCompras.NomProveedor" list="NombresProveedoresN" onchange="javascript: onChangeProveedorN(1)" id="NomProveedorN" class="form-control">
                                        <datalist id="NombresProveedoresN">
                                            @foreach (var item in Model.Proveedores)
                                            {
                                                <option value="@item.Nombre"> @item.Nombre</option>

                                            }



                                        </datalist>

                                    </div>
                                </div>


                                <label class="col-form-label">Número Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" asp-for="Objeto1.EncCompras.NumFactura" id="NumFacturaN" class="form-control" maxlength="5" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" placeholder="Digite los últimos 5 dígitos">
                                    </div>
                                </div>

                                <label class="col-form-label">Fecha Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="date" asp-for="Objeto1.EncCompras.FecFactura" onchange="javascript: onChangeFecFacturaN();" id="FecFacturaN" class="form-control">
                                    </div>
                                </div>


                                <label class="col-form-label">Comentarios:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" asp-for="Objeto1.EncCompras.Comentario" id="ComentarioFacturaN" class="form-control">
                                    </div>
                                </div>



                                <label class="col-form-label">Tipo Documento:</label>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura Fiscal
                                            <input type="checkbox" id="simpN" onchange="javascript: checkN('1');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura Exterior
                                            <input type="checkbox" id="extN" onchange="javascript: checkN('2');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Gastos Varios
                                            <input type="checkbox" id="varN" onchange="javascript: checkN('3');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura Electrónica
                                            <input type="checkbox" id="nrecN" onchange="javascript: checkN('4');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                </div>




                            </div>

                        </div>



                    </div>
                </div>

                <div class="ibox">
                    <label class="text-danger" id="ErrorFacturaN" style="display: none;"> Ha ocurrido un error al intentar insertar la factura, por favor volver a intentar</label>
                    <label class="text-danger" id="FaltaDatosN" style="display: none;"> Parecen que faltan datos por rellenar</label>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-3">
                                <label class="col-form-label">Detalle:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" id="NomProN" class="form-control">
                                    </div>
                                </div>
                                <div hidden>

                                    <label class="col-form-label">Monto Descuento:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <input type="number" id="descIN" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3">

                                <label class="col-form-label">Tipo Impuesto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="TipoImpuestoN" class="form-control  ">
                                            <option value="NULL">-IVA-</option>

                                            <option value="0">Exento</option>
                                            <option value="13">
                                                IV(13%)
                                            </option>
                                            <option value="15" selected>
                                                IVA(15%)
                                            </option>



                                        </select>
                                    </div>
                                </div>

                                <div hidden>

                                    <label class="col-form-label">Monto Impuesto:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <input type="number" id="ImpuestoMontoN" class="form-control">
                                        </div>
                                    </div>

                                </div>



                            </div>
                            <div class="col-sm-3">
                                <label class="col-form-label">Tipo Gasto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="idTipoGastoN" class="form-control " onchange="javascript: onChangeTipoGastoN()">
                                            <option value="NULL" selected>-Tipo Gasto-</option>
                                            @foreach (var item in Model.Gastos.OrderBy(a => a.Nombre))
                                            {
                                                <option value="@item.idTipoGasto">@item.Nombre</option>
                                            }




                                        </select>
                                    </div>
                                </div>

                            </div>
                            <div class="col-sm-3">
                                <label class="col-form-label">Monto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" id="PrecUniN" class="form-control">
                                    </div>
                                </div>






                            </div>

                            <!--En caso de ser combustible-->
                            <div class="col-sm-12" hidden id="CombustibleN">
                                <div class="row">
                                    <div class="col-sm-3">
                                        <label class="col-form-label">Cantidad Litros:</label>
                                        <div class="form-group row">
                                            <div class="col-sm-12">

                                                <input type="number" id="CantLitrosN" value="1" class="form-control">
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-sm-3">
                                        <label class="col-form-label">Tipo Combustible:</label>
                                        <div class="form-group row">
                                            <div class="col-sm-12">

                                                <select id="idTipoCombN" class="form-control ">
                                                    <option value="" selected>-Tipo Combustible-</option>

                                                    <option value="Diesel">Diesel</option>
                                                    <option value="Gasolina 95">Gasolina 95</option>
                                                    <option value="Gasolina 90">Gasolina 90</option>
                                                    <option value="Gas LP">Gas LP</option>


                                                </select>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <!--Termina En caso de ser combustible-->
                            <div class="col-sm-12">
                                <div class="row">
                                    <div class="col-sm-8"></div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        @*<button onclick="javascript: AgregarProductosI();" class="btn btn-w-m btn-primary" title="Agregar a la lista">+ Agregar</button>*@
                                        <button id="buttonSpinN" onclick="javascript: EnviarFCN();" class="ladda-button green expand-left"><span class="label-submit">Agregar Factura</span> <span class="spinner"></span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!--Tabla de mentiras-->
                <div class="ibox" hidden>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-12">

                                <div class="table-responsive tableFixHead" style=" overflow-y:scroll;    z-index: 5; height: 300px;">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th align="center" style=" text-align: center;"><h3>Nombre</h3></th>

                                                <th align="center" style=" text-align: center;"><h3>Precio Unitario</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Descuento</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Impuesto</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Total</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Eliminar</h3></th>


                                            </tr>

                                        </thead>
                                        <tbody id="tbodyIN">
                                        </tbody>
                                    </table>

                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-8">

                                    </div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        <div class="row">

                                            <div class="col-sm-12">

                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table; font-weight: 500 !important; font-style: normal;">SubTotal:</label>

                                                            </td>
                                                            <td>
                                                                <label id="subtotalIN" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>

                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Descuento:</label>

                                                            </td>
                                                            <td>
                                                                <label id="descuentoIN" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Impuesto:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuestoIN" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 1:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto1IN" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 2:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto2IN" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 4:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto4IN" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 8:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto8IN" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 13:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto13IN" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Total:</label>

                                                            </td>
                                                            <td>
                                                                <label id="totalIN" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>


                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div class="row">
            @if (Model.Pais == "C")
            {
                <div class="col-sm-12" style="text-align: center;">
                    <a title="Eliminar" onclick="javascript: LimpiarDatos();" style="width: 25%;" class="btn btnpage">Cancelar</a>&nbsp;
                    <a title="Agregar" id="Agregar" onclick="javascript: InsertarProductoTabla();" style=" color: #fff; width: 25%;" class="btn btn-primary">Asignar</a>
                </div>

            }

        </div>

        <br />
        <div class="ibox">
            <div class="row">
                <div class="col-sm-12">
                    <label class="col-form-label">Observación:</label>
                </div>
                <div class="col-sm-12">
                    <textarea rows="5" class="form-control" asp-for="Liquidacion.EncCierre.Observacion" id="Comentario"></textarea>
                </div>
            </div>
        </div>

    </div>
    <div class="col-sm-6">
        <div class="ibox">

            <div class="ibox-content lista">

                <div class="row">
                    <div class="col-sm-12">
                        <div class="table-responsive tableFixHead" style=" overflow-y:scroll;    z-index: 5; height: 300px;">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th align="center" style=" text-align: center;"><h3>Eliminar</h3></th>
                                        <th align="center" style=" text-align: center;"><h3>Cons. Hacienda</h3></th>
                                        <th align="center" style=" text-align: center;"><h3>Fecha </h3></th>
                                        <th align="center" style=" text-align: center;"><h3>Proveedor</h3></th>
                                        <th align="center" style=" text-align: center;"><h3>Total</h3></th>


                                    </tr>

                                </thead>
                                <tbody id="tbody">
                                </tbody>
                            </table>

                        </div>
                    </div>


                </div>
                <hr />
                <div class="row">
                    <div class="col-sm-6">
                    </div>
                    <div class="col-sm-6" style="text-align: right;">
                        <div class="row">

                            <div class="col-sm-12">

                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table; font-weight: 500 !important; font-style: normal;">SubTotal:</label>

                                            </td>
                                            <td>
                                                <label id="subtotal" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>

                                        </tr>
                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Descuento:</label>

                                            </td>
                                            <td>
                                                <label id="descuento" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>
                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Impuesto:</label>

                                            </td>
                                            <td>
                                                <label id="impuesto" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>

                                        @if (Model.Pais == "C")
                                        {
                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 1:</label>

                                                </td>
                                                <td>
                                                    <label id="impuesto1" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>

                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 2:</label>

                                                </td>
                                                <td>
                                                    <label id="impuesto2" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>

                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 4:</label>

                                                </td>
                                                <td>
                                                    <label id="impuesto4" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>

                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 8:</label>

                                                </td>
                                                <td>
                                                    <label id="impuesto8" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>

                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 13:</label>

                                                </td>
                                                <td>
                                                    <label id="impuesto13" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>
                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Otros Cargos:</label>

                                                </td>
                                                <td>
                                                    <label id="tOCargos" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>
                                        }
                                        else if (Model.Pais == "P")
                                        {
                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> ITBMS(7%):</label>

                                                </td>
                                                <td>
                                                    <label id="impuesto1" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>
                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> ITBMS(10%):</label>

                                                </td>
                                                <td>
                                                    <label id="impuesto2" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>
                                        }
                                        else if (Model.Pais == "N")
                                        {
                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> IV(13%):</label>

                                                </td>
                                                <td>
                                                    <label id="impuesto1" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>
                                            <tr>

                                                <td style="text-align: center;">
                                                    <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> IVA(15%):</label>

                                                </td>
                                                <td>
                                                    <label id="impuesto2" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                </td>
                                            </tr>
                                        }
                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Total:</label>

                                            </td>
                                            <td>
                                                <label id="total" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>


                    </div>


                </div>


            </div>
        </div>


        <div class="d-flex justify-content-end">
            <button onclick="javascript: Generar();" class="btn btn-w-m btn-primary botonAbajo" id="GuardarCambios" title="Guardar">Guardar Cambios</button> &nbsp;
            @*<button onclick="javascript: EnviarRevision();" id="btnEnviarRevision botonAbajo" class="btn btn-w-m btn-success" title="Enviar a Revisión">Enviar a Revisión</button>
                &nbsp;*@
            <button onclick="javascript: GeneraryEnviar();" class="btn btn-w-m btn-warning botonAbajo" title="Guardar y enviar a revisión">Guardar y Aprobar</button>
        </div>
    </div>
</div>

<!--Panama-->
<script>
    var ImageBae64 = '';
    var IMG2 = '';
    var Productos = [];
    var subtotalI = 0;
    var impuestosI = 0;
    var descuentosI = 0;
    var totalComprobanteI = 0;

    var impuestoI1 = 0;
    var impuestoI2 = 0;
    var impuestoI4 = 0;
    var impuestoI8 = 0;
    var impuestoI13 = 0;

    var position = 0;
    async function readFilePrincipalP(input) {

        if (input.files && input.files[0]) {
            /*const maxAllowSize = 512000;*/
            //const maxAllowSize = 2800000;
            const maxAllowSize = 5000000;
            if (input.files[0].size > maxAllowSize) {
                alert("Esta imagen es muy pesada");
                input.value = '';
            } else {
                var reader = new FileReader();
                var img = document.createElement("img");
                var canvas = document.createElement('canvas');

                reader.onload = function (e) {
                    img.src = e.target.result;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);

                    var MAX_WIDTH = 800;
                    var MAX_HEIGHT = 600;
                    var width = img.width;
                    var height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    var dataurl = canvas.toDataURL("image/jpg");
                    document.getElementById('imgPrincipalGP').src = e.target.result;


                    ImageBae64 = dataurl;
                    IMG2 = e.target.result;

                }

            }

            reader.readAsDataURL(input.files[0]);
        }



    }
  //  var idF;
    var fileUploadPrincipal = document.getElementById('imgPrincipalUploadGP');
    fileUploadPrincipal.onchange = async function (e) {

        await readFilePrincipalP(e.srcElement);
        // idF = setInterval(cancelar(e), 2000);

       var idF = setInterval( async function () {

            if (ImageBae64 != "data:,") {
                //alert("Imagen agregada con éxito");
                clearInterval(idF);
            } else {
                await readFilePrincipalP(e.srcElement);
            }
        }, 1500);


        //await readFilePrincipal(e.srcElement);
        //sleep(3000);
        //await readFilePrincipal(e.srcElement);

    }


    function onChangeProveedorP(bit) {

        var ruc = $("#CodProveedorP").val();
        var dv = $("#DVP").val();
        var nombre = $("#NomProveedorP").val();



        if (bit == 1) {

                $("#CodProveedorP").val("");
                $("#DVP").val("");



        } else {
            $("#NomProveedorP").val("");
        }

            $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '@Url.Page("Editar", "BuscarProveedor")',
                data: { ids: $("#CodProveedorP").val(), dv: $("#DVP").val(), nombre: $("#NomProveedorP").val()  },
            success: function (result) {

                console.log(result);

                if (result != null) {

                    /*if ($("#NomProveedorP").val() == "") {*/
                        $("#NomProveedorP").val(result.nombre);
                        $("#DVP").val(result.dv);
                        $("#CodProveedorP").val(result.ruc);
                        switch (result.ruc.replace("-", "").replace("-", "").length) {
                            case 7:
                            case 8:
                            case 9:
                                {
                                    $("#idProveedor1P").prop('checked', true)
                                    mask2P();
                                    break;
                                }
                            case 10:

                                {

                                    $("#idProveedor3P").prop('checked', true)


                                    mask2P();
                                    break;
                                }
                            case 12:
                                {
                                    $("#idProveedor3P").prop('checked', true)
                                    mask2P();
                                    break;
                                }
                            case 13:
                            case 14:
                            case 15:
                                {
                                    $("#idProveedor2P").prop('checked', true)
                                    mask2P();
                                    break;
                                }
                            default:
                                {
                                    $("#idProveedor1P").prop('checked', true)
                                    mask2P();
                                    break;
                                }


                        }
                    //} else {
                    //    $("#DVP").val(result.dv);
                    //    $("#CodProveedorP").val(result.ruc);

                    //    switch (result.ruc.replace("-", "").replace("-", "").length) {
                    //        case 7:
                    //        case 8:
                    //        case 9:
                    //            {
                    //                $("#idProveedor1P").prop('checked', true)
                    //                mask2P();
                    //                break;
                    //            }
                    //        case 10:

                    //            {

                    //                $("#idProveedor3P").prop('checked', true)


                    //                mask2P();
                    //                break;
                    //            }
                    //        case 12:
                    //            {
                    //                $("#idProveedor3P").prop('checked', true)
                    //                mask2P();
                    //                break;
                    //            }
                    //        case 13:
                    //        case 14:
                    //        case 15:
                    //            {
                    //                $("#idProveedor2P").prop('checked', true)
                    //                mask2P();
                    //                break;
                    //            }
                    //        default:
                    //            {
                    //                $("#idProveedor1P").prop('checked', true)
                    //                mask2P();
                    //                break;
                    //            }


                    //    }
                    //}


                } else {


                    $("#CodProveedorP").val(ruc);
                    $("#DVP").val(dv);
                    $("#NomProveedorP").val(nombre);

                }

            },
            beforeSend: function () {

            },
            complete: function () {

            }
        });
        }

    function checkP(i) {

        var checkbox1 = document.getElementById("simpP");
        var checkbox2 = document.getElementById("extP");
        var checkbox3 = document.getElementById("varP");
        var checkbox4 = document.getElementById("nrecP");
        if (i == "1") {

            checkbox2.checked = false;
            checkbox3.checked = false;
            checkbox4.checked = false;
            checkbox1.checked = true;
            $("#CHaciendaP").removeAttr("readonly");
            $("#ConsHaciendaP").removeAttr("readonly");

        }
        else if (i == "2") {
            checkbox3.checked = false;
            checkbox2.checked = true;
            checkbox1.checked = false;
            checkbox4.checked = false;
            $("#CHaciendaP").attr("readonly", "readonly");
            $("#ConsHaciendaP").attr("readonly", "readonly");

            $("#CHaciendaP").val("");
            $("#ConsHaciendaP").val("");
        } else if (i == "3") {
            checkbox3.checked = true;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = false;
        } else {
            checkbox3.checked = false;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = true;
        }
    }

    function AgregarProductosIP() {
        var combo = document.getElementById("idTipoGastoP");
        var selected = combo.options[combo.selectedIndex].text;

        var detalle = {

            CodPro: "1",
            NomPro: ($("#NomProP").val() == "" ? "Detalle factura" : (selected.includes("COMB") ? $("#NomProP").val() + " * " + $("#idTipoCombP").val() : $("#NomProP").val())),
            idTipoGasto: $("#idTipoGastoP").val() == "NULL" ? "0" : $("#idTipoGastoP").val(),
            Cantidad: (selected.includes("COMB") ? $("#CantLitrosP").val() : "1"),
            PrecioUnitario: $("#PrecUniP").val(),
            MontoDescuento: $("#descIP").val(),
            ImpuestoTarifa: $("#TipoImpuestoP").val(),
            ImpuestoMonto: $("#ImpuestoMontoP").val(),
            MontoTotalLinea: 0,
            Impuesto1: 0,
            Impuesto2: 0,
            Impuesto4: 0,
            Impuesto8: 0,
            Impuesto13: 0
        };
        detalle.ImpuestoMonto = 0;
        detalle.MontoDescuento = 0;
        switch ($("#TipoImpuestoP").val()) {
            case "0":
                {

                    detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.00;

                    break;
                }
            case "7":
                {

                    detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.07;
                    detalle.Impuesto1 += detalle.ImpuestoMonto;
                    break;
                }
            case "10":
                {
                    detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.10;
                    detalle.Impuesto2 += detalle.ImpuestoMonto;
                    break;
                }

        }

        //detalle.MontoTotalLinea = ((detalle.PrecioUnitario) - detalle.MontoDescuento) + parseFloat(detalle.ImpuestoMonto);
        detalle.MontoTotalLinea = (detalle.PrecioUnitario);
        var subtotalT = 0;
        var descuentoT = 0;
        var impuestoT = 0;
        var totalT = 0;
        subtotalT = parseFloat(detalle.PrecioUnitario) - detalle.ImpuestoMonto;
        descuentoT = parseFloat(detalle.MontoDescuento);
        impuestoT = parseFloat(detalle.ImpuestoMonto);
        totalT = parseFloat(detalle.MontoTotalLinea);

        subtotalI += subtotalT;
        descuentosI += descuentoT;
        impuestosI += impuestoT;

        totalComprobanteI += totalT;

        var impuesto1T = parseFloat(detalle.Impuesto1);
        var impuesto2T = parseFloat(detalle.Impuesto2);
        var impuesto4T = parseFloat(detalle.Impuesto4);
        var impuesto8T = parseFloat(detalle.Impuesto8);
        var impuesto13T = parseFloat(detalle.Impuesto13);


        impuestoI1 += impuesto1T;
        impuestoI2 += impuesto2T;
        impuestoI4 += impuesto4T;
        impuestoI8 += impuesto8T;
        impuestoI13 += impuesto13T;


        $("#subtotalIP").text(formatoDecimal(subtotalI.toFixed(2)));
        $("#descuentoIP").text(formatoDecimal(descuentosI.toFixed(2)));
        $("#impuestoIP").text(formatoDecimal(impuestosI.toFixed(2)));
        $("#totalIP").text(formatoDecimal(totalComprobanteI.toFixed(2)));


        $("#impuesto1IP").text(formatoDecimal(parseFloat(impuestoI1).toFixed(2)));
        $("#impuesto2IP").text(formatoDecimal(parseFloat(impuestoI2).toFixed(2)));
        $("#impuesto4IP").text(formatoDecimal(parseFloat(impuestoI4).toFixed(2)));
        $("#impuesto8IP").text(formatoDecimal(parseFloat(impuestoI8).toFixed(2)));
        $("#impuesto13IP").text(formatoDecimal(parseFloat(impuestoI13).toFixed(2)));


        Productos.push(detalle);
       // LimpiarDatosI();
     //   RellenaTablaI();
    }
    function LimpiarDatosIP() {

        $("#NomProP").val("");

        $("#PrecUniP").val(0);
        $("#descIP").val(0);
        $("#TipoImpuestoP").val("7").trigger('change');
        $("#idTipoGastoP").val("NULL").trigger('change');
        $("#ImpuestoMontoP").val(0);
        $("#idTipoCombP").val("").trigger('change');
        $("#CantLitrosP").val(1);
    }

    function RellenaTablaIP() {
        var texto = '';

        $("#tbodyIP").html('');

        for (var i = 0; i < Productos.length; i++) {
            texto += '<tr>';

            texto += '<td align="left" style="padding-top:15px;">  <p style="font-size:13px;">' + Productos[i].NomPro + '</p></td>';

            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].PrecioUnitario) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].MontoDescuento) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].ImpuestoMonto) + '</p></td>';
            texto += '<td align="right" style="padding-top:13px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].MontoTotalLinea) + '</p></td>';
            texto += '<td align="center" style="padding-top:13px;">    <a style="margin-left: -1%; position: inherit !important;" onclick = "javascript: EliminaProductoI(' + i + ')" title="Eliminar" class="fa fa-trash icono"></a> ';
            texto += '</tr>'
        }


        $("#tbodyIP").html(texto);
    }

    function EliminaProductoIP(campo) {


                var subtotalT = 0;
                var descuentoT = 0;
                var impuestoT = 0;
                var totalT = 0;
                subtotalT = parseFloat(Productos[campo].PrecioUnitario);
                descuentoT = parseFloat(Productos[campo].MontoDescuento);
                impuestoT = parseFloat(Productos[campo].ImpuestoMonto);

                totalT = parseFloat(Productos[campo].MontoTotalLinea);

                subtotalI -= subtotalT;
                descuentosI -= descuentoT;
                impuestosI -= impuestoT;

                totalComprobanteI -= totalT;

                var impuesto1T = parseFloat(Productos[campo].Impuesto1);
                var impuesto2T = parseFloat(Productos[campo].Impuesto2);
                var impuesto4T = parseFloat(Productos[campo].Impuesto4);
                var impuesto8T = parseFloat(Productos[campo].Impuesto8);
                var impuesto13T = parseFloat(Productos[campo].Impuesto13);


                impuestoI1 -= impuesto1T;
                impuestoI2 -= impuesto2T;
                impuestoI4 -= impuesto4T;
                impuestoI8 -= impuesto8T;
                impuestoI13 -= impuesto13T;


                $("#subtotalIP").text(formatoDecimal(subtotalI.toFixed(2)));
                $("#descuentoIP").text(formatoDecimal(descuentosI.toFixed(2)));
                $("#impuestoIP").text(formatoDecimal(impuestosI.toFixed(2)));
                $("#totalIP").text(formatoDecimal(totalComprobanteI.toFixed(2)));


                $("#impuesto1IP").text(formatoDecimal(parseFloat(impuestoI1).toFixed(2)));
                $("#impuesto2IP").text(formatoDecimal(parseFloat(impuestoI2).toFixed(2)));
                $("#impuesto4IP").text(formatoDecimal(parseFloat(impuestoI4).toFixed(2)));
                $("#impuesto8IP").text(formatoDecimal(parseFloat(impuestoI8).toFixed(2)));
                $("#impuesto13IP").text(formatoDecimal(parseFloat(impuestoI13).toFixed(2)));

                Productos.splice(campo, 1);
                RellenaTablaI();


    }

    function onChangeTipoGasto() {
        var combo = document.getElementById("idTipoGastoP");
        var selected = combo.options[combo.selectedIndex].text;

        if (selected.includes("COMB")) {
            $("#Combustible").attr("hidden", false);
        } else {
            $("#Combustible").attr("hidden", true);
        }
    }

    function maskP() {
        switch ($("#idClienteP").val()) {
            case "01":
                {
                    $("#CodProveedorP").inputmask({ "mask": "99-999-9999" });
                    break;
                }
            case "02":
                {
                    $("#CodProveedorP").inputmask({ "mask": "9999999-99-999999" });

                    break;
                }
            case "03":
                {
                    $("#CodProveedorP").inputmask({ "mask": "9999999999" });
                    break;
                }
            case "04":
                {
                    $("#CodProveedorP").inputmask({ "mask": "9999999999" });
                    break;
                }
            default:
                {
                    break;
                }
        }
    }
    function mask2P() {

        $("#CodProveedorP").attr("readonly", false);
        $("#DVP").attr("readonly", false);
        switch ($("input:radio[name=idProveedorP]:checked").val()) {
            case "01":
                {
                    //$("#CodProveedorP").inputmask({ "mask": "99-999-9999" });
                    $("#CodProveedorP").attr('maxlength', 11);
                    break;
                }
            case "02":
                {
                    //$("#CodProveedorP").inputmask({ "mask": "9999999-99-999999" });
                    $("#CodProveedorP").attr('maxlength', 17);
                    break;
                }
            case "03":
                {
                   // $("#CodProveedorP").inputmask({ "mask": "9999999999" });
                    $("#CodProveedorP").attr('maxlength', 10);
                    break;
                }
            case "04":
                {
                   // $("#CodProveedorP").inputmask({ "mask": "9999999999" });
                    $("#CodProveedorP").attr('maxlength', 10);
                    break;
                }
            default:
                {
                    break;
                }
        }
    }

              function GenerarIP()
              {
                  var button = document.getElementById('buttonSpinP');
                  if (typeof (button.getAttribute('data-loading')) === 'string') {
                      button.removeAttribute('data-loading');
                  }
                  else {
                      button.setAttribute('data-loading', '');
                  }


                  //

                 var checkbox1 = document.getElementById("simpP");
                  var checkbox2 = document.getElementById("extP");
                  var checkbox3 = document.getElementById("varP");
                  var checkbox4 = document.getElementById("nrecP");
                 var EncCompras =
                    {
                        ClaveHacienda: $("#NumFacturaP").val(),
                        ConsecutivoHacienda: $("#NumFacturaP").val(),
                        TipoIdentificacionCliente: "0",
                     NumFactura: $("#NumFacturaP").val(),
                     Comentario: $("#ComentarioFacturaP").val(),
                        CodProveedor: $("#CodProveedorP").val() + "[" + $("#DVP").val(),
                        NomProveedor: $("#NomProveedorP").val(),
                        FecFactura: $("#FecFacturaP").val(),
                        CodigoActividadEconomica: "0" ,
                        CodMoneda: $("#CodMoneda").val(),
                        CodCliente: "0",
                        NomCliente: "0",
                        TotalVenta: $("#subtotalIP").text(),
                        TotalImpuesto: $("#impuestoIP").text(),
                        TotalDescuentos: $("#descuentoIP").text(),
                        Impuesto1: $("#impuesto1IP").text() ,
                        Impuesto2: $("#impuesto2IP").text()  ,
                        Impuesto4: $("#impuesto4IP").text(),
                        Impuesto8: $("#impuesto8IP").text(),
                        Impuesto13: $("#impuesto13IP").text(),
                     TotalComprobante: $("#totalIP").text(),
                     ImagenB64: (ImageBae64 === '' ? '' : ImageBae64.toString().replace('data:image/jpeg;base64,', '').replace('data:image/png;base64,', '')),

                        ImagenBase64: (ImageBae64 === '' ? '' : ImageBae64.toString().replace('data:image/jpeg;base64,', '').replace('data:image/png;base64,', '')),
                        RegimenSimplificado: checkbox1.checked,
                     FacturaExterior: checkbox2.checked,
                     GastosVarios: checkbox3.checked,
                     FacturaNoRecibida: checkbox4.checked
                    };

                    var DetCompras = Productos;
                    var recibido = {
                            EncCompras,
                            DetCompras
                        };

                  var recibidos = JSON.stringify(recibido);
                  if (ValidarFacturaP()) {
                      $("#FaltaDatosP").css("display", "none");

                      $.ajax({
                          type: 'POST',

                          url: '@Url.Page("Editar", "Insertar")',
                          datatype: "application/json",
                          data: { recibidos: recibidos.toString() },
                          headers: {
                              RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                          },
                          success: function (json) {

                              console.log(json.resp + " -> " + json.success );
                              if (json.success == true) {
                                  button.removeAttribute('data-loading');
                                  $("#ErrorFacturaP").css("display", "none");
                                  //Aqui se meteria en el detalle
                                  var detalle = {
                                      id: json.resp,
                                      Proveedor: EncCompras.NomProveedor,
                                      CHacienda: EncCompras.NumFactura,
                                      CodProveedor: EncCompras.CodProveedor,
                                      //    idTipoGasto: $("#idTipoGasto").val(),
                                      Fecha: EncCompras.FecFactura,
                                      SubTotal: parseFloat(EncCompras.TotalVenta.replace(",", "").replace(",", "")),
                                      Descuento: parseFloat(EncCompras.TotalDescuentos.replace(",", "").replace(",", "")) ,
                                      Impuesto: parseFloat(EncCompras.TotalImpuesto.replace(",", "").replace(",", "")),
                                      Total: 0,
                                      Impuesto1: parseFloat(EncCompras.Impuesto1.replace(",", "").replace(",", "")),
                                      Impuesto2: parseFloat(EncCompras.Impuesto2.replace(",", "").replace(",", "")),
                                      Impuesto4: parseFloat(EncCompras.Impuesto4.replace(",", "").replace(",", "")),
                                      Impuesto8: parseFloat(EncCompras.Impuesto8.replace(",", "").replace(",", "")),
                                      Impuesto13: parseFloat(EncCompras.Impuesto13.replace(",", "").replace(",", "")),
                                      idTipoGasto: Productos[0].idTipoGasto,
                                      TotalOtrosCargos: 0,
                                      Comentario: ""
                                  };

                                  console.log(EncCompras);
                                  console.log(detalle);
                                  var subtotalT = 0;
                                  var descuentoT = 0;
                                  var impuestoT = 0;
                                  var totalT = 0;
                                  subtotalT = parseFloat(detalle.SubTotal);
                                  descuentoT = parseFloat(detalle.Descuento);
                                  impuestoT = parseFloat(detalle.Impuesto);
                                  detalle.Total = (subtotalT - descuentoT) + impuestoT
                                  ProdCadena.push(detalle);
                                  totalT = parseFloat(detalle.Total);
                                  var impuesto1T = parseFloat(detalle.Impuesto1);
                                  var impuesto2T = parseFloat(detalle.Impuesto2);
                                  var impuesto4T = parseFloat(detalle.Impuesto4);
                                  var impuesto8T = parseFloat(detalle.Impuesto8);
                                  var impuesto13T = parseFloat(detalle.Impuesto13);



                                  subtotal += subtotalT;
                                  descuentos += descuentoT;
                                  impuestos += impuestoT;

                                  totalComprobante += totalT;
                                  impuesto1 += impuesto1T;
                                  impuesto2 += impuesto2T;
                                  impuesto4 += impuesto4T;
                                  impuesto8 += impuesto8T;
                                  impuesto13 += impuesto13T;

                                  $("#subtotal").text(formatoDecimal(parseFloat(subtotal).toFixed(2)));
                                  $("#descuento").text(formatoDecimal(parseFloat(descuentos).toFixed(2)));
                                  $("#impuesto").text(formatoDecimal(parseFloat(impuestos).toFixed(2)));
                                  $("#total").text(formatoDecimal(parseFloat(totalComprobante).toFixed(2)));

                                  //
                                  $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
                                  $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));

                                  //Modificar por ser de panama
                                  LimpiarDatos();

                                  RellenaTabla();
                                  LimpiarDatosGeneralesP();
                                  //$("#ModalInclusion").modal("hide");

                              } else {
                                  $("#ErrorFacturaP").text(json.resp);
                                  $("#ErrorFacturaP").css("display", "block");
                                  button.removeAttribute('data-loading');
                                  EliminaProductoIP(0);
                              }
                          },

                          beforeSend: function (xhr) {


                          },
                          complete: function () {

                          },
                          error: function (error) {

                              $("#ErrorFactura").css("display", "block");


                          }
                      });
                  } else {
                      $("#FaltaDatosP").css("display", "block");
                      button.removeAttribute('data-loading');
                      Productos = [];
                  }

    }

    function LimpiarDatosGeneralesP() {
        $("#NumFacturaP").val("");
        $("#CodProveedorP").val("");
        $("#DVP").val("");
        $("#NomProveedorP").val("");
        $("#FecFacturaP").val("");
        $("#subtotalIP").text("0");
        $("#impuestoIP").text("0");
        $("#descuentoIP").text("0");
        $("#impuesto1IP").text("0");
        $("#impuesto2IP").text("0");
        $("#impuesto4IP").text("0");
        $("#impuesto8IP").text("0");
        $("#impuesto13IP").text("0");
        $("#totalIP").text("0");
        ImagenBase64 = "";
        Productos = [];

        subtotalT = 0;
        descuentoT = 0;
        impuestoT = 0;
        totalT = 0;

        impuesto1T = 0;
        impuesto2T = 0;
        impuesto4T = 0;
        impuesto8T = 0;
        impuesto13T = 0;

        subtotalI = 0;
        impuestosI = 0;
        descuentosI = 0;
        totalComprobanteI = 0;

        impuestoI1 = 0;
        impuestoI2 = 0;
        impuestoI4 = 0;
        impuestoI8 = 0;
        impuestoI13 = 0;
        document.getElementById('imgPrincipalGP').src = "/img/cm.jpg";
        ImageBae64 = "";
        LimpiarDatosIP();
        RellenaTablaIP();
    }
    function ValidarFacturaP() {
        if (ProdCadena.find(a => a.CHacienda.trim() == $("#NumFacturaP").val() && a.CodProveedor == $("#CodProveedorP").val()) != undefined) {
            return false;
        }

        if ($("#NumFacturaP").val() == "") {
            return false;
        } else if ($("#CodProveedorP").val() == "") {
            return false;
        } else if ($("#NomProveedorP").val() == "") {
            return false;
        } else if ($("#FecFacturaP").val() == "")
        {
            return false;
        } else if (Productos.length == 0)
        {
            return false;
        } else if (ImageBae64 == "")
        {
            return false;
        } else if ($("#idTipoGastoP").val() == "NULL") {
            return false;
        }
        else {
            return true;
        }
    }

    async function EnviarFCP() {
        AgregarProductosIP();
        GenerarIP();

    }
</script>


<!--Nicaragua-->
<script>
    var ImageBae64 = '';
    var IMG2 = '';
    var Productos = [];
    var subtotalI = 0;
    var impuestosI = 0;
    var descuentosI = 0;
    var totalComprobanteI = 0;

    var impuestoI1 = 0;
    var impuestoI2 = 0;
    var impuestoI4 = 0;
    var impuestoI8 = 0;
    var impuestoI13 = 0;

    var position = 0;
    async function readFilePrincipalN(input) {

        if (input.files && input.files[0]) {
            /*const maxAllowSize = 512000;*/
            //const maxAllowSize = 2800000;
            const maxAllowSize = 5000000;
            if (input.files[0].size > maxAllowSize) {
                alert("Esta imagen es muy pesada");
                input.value = '';
            } else {
                var reader = new FileReader();
                var img = document.createElement("img");
                var canvas = document.createElement('canvas');

                reader.onload = function (e) {
                    img.src = e.target.result;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);

                    var MAX_WIDTH = 800;
                    var MAX_HEIGHT = 600;
                    var width = img.width;
                    var height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    var dataurl = canvas.toDataURL("image/jpg");
                    document.getElementById('imgPrincipalGN').src = e.target.result;


                    ImageBae64 = dataurl;
                    IMG2 = e.target.result;

                }

            }

            reader.readAsDataURL(input.files[0]);
        }



    }
  //  var idF;
    var fileUploadPrincipal = document.getElementById('imgPrincipalUploadGN');
    fileUploadPrincipal.onchange = async function (e) {

        await readFilePrincipalN(e.srcElement);
        // idF = setInterval(cancelar(e), 2000);

       var idF = setInterval( async function () {

            if (ImageBae64 != "data:,") {
                //alert("Imagen agregada con éxito");
                clearInterval(idF);
            } else {
                await readFilePrincipalN(e.srcElement);
            }
        }, 1500);

 
    }


    function onChangeProveedorN(bit) {

        var ruc = $("#CodProveedorN").val();
        var dv = "undefined";
        var nombre = $("#NomProveedorN").val();



        if (bit == 1) {

                $("#CodProveedorN").val("");
                $("#DVP").val("");



        } else {
            $("#NomProveedorN").val("");
        }

            $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '@Url.Page("Editar", "BuscarProveedor")',
                data: { ids: $("#CodProveedorN").val(), dv: dv, nombre: $("#NomProveedorN").val()  },
            success: function (result) {

                console.log(result);

                if (result != null) {
 
                        $("#NomProveedorN").val(result.nombre);
                        $("#DVP").val(result.dv);
                        $("#CodProveedorN").val(result.ruc);
                        switch (result.ruc.replace("-", "").replace("-", "").length) {
                            case 15:
                                {
                                    if (result.ruc.includes("J") || result.ruc.includes("j")) {
                                        $("#idProveedor2N").prop('checked', true)
                                        mask2N();
                                        break;
                                    } else {
                                        $("#idProveedor1N").prop('checked', true)
                                        mask2N();
                                        break;
                                    }

                                }

                            default:
                                {
                                    $("#idProveedor1N").prop('checked', true)
                                    mask2N();
                                    break;
                                }
                        


                        }
                   

                } else {


                    $("#CodProveedorN").val(ruc);
                    $("#DVP").val(dv);
                    $("#NomProveedorN").val(nombre);

                }

            },
            beforeSend: function () {

            },
            complete: function () {

            }
        });
        }

    function checkN(i) {

        var checkbox1 = document.getElementById("simpN");
        var checkbox2 = document.getElementById("extN");
        var checkbox3 = document.getElementById("varN");
        var checkbox4 = document.getElementById("nrecN");
        if (i == "1") {

            checkbox2.checked = false;
            checkbox3.checked = false;
            checkbox4.checked = false;
            checkbox1.checked = true;
            $("#CHaciendaN").removeAttr("readonly");
            $("#ConsHaciendaN").removeAttr("readonly");

        }
        else if (i == "2") {
            checkbox3.checked = false;
            checkbox2.checked = true;
            checkbox1.checked = false;
            checkbox4.checked = false;
            $("#CHaciendaN").attr("readonly", "readonly");
            $("#ConsHaciendaN").attr("readonly", "readonly");

            $("#CHaciendaN").val("");
            $("#ConsHaciendaN").val("");
        } else if (i == "3") {
            checkbox3.checked = true;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = false;
        } else {
            checkbox3.checked = false;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = true;
        }
    }

    function AgregarProductosIN() {
        var combo = document.getElementById("idTipoGastoN");
        var selected = combo.options[combo.selectedIndex].text;

        var detalle = {

            CodPro: "1",
            NomPro: ($("#NomProN").val() == "" ? "Detalle factura" : (selected.includes("COMB") ? $("#NomProN").val() + " * " + $("#idTipoCombN").val() : $("#NomProN").val())),
            idTipoGasto: $("#idTipoGastoN").val() == "NULL" ? "0" : $("#idTipoGastoN").val(),
            Cantidad: (selected.includes("COMB") ? $("#CantLitrosN").val() : "1"),
            PrecioUnitario: $("#PrecUniN").val(),
            MontoDescuento: $("#descIN").val(),
            ImpuestoTarifa: $("#TipoImpuestoN").val(),
            ImpuestoMonto: $("#ImpuestoMontoN").val(),
            MontoTotalLinea: 0,
            Impuesto1: 0,
            Impuesto2: 0,
            Impuesto4: 0,
            Impuesto8: 0,
            Impuesto13: 0
        };
        detalle.ImpuestoMonto = 0;
        detalle.MontoDescuento = 0;
        switch ($("#TipoImpuestoN").val()) {
            case "0":
                {

                    detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.00;

                    break;
                }
            case "13":
                {

                    detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.13;
                    detalle.Impuesto1 += detalle.ImpuestoMonto;
                    break;
                }
            case "15":
                {
                    detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.15;
                    detalle.Impuesto2 += detalle.ImpuestoMonto;
                    break;
                }

        }

        //detalle.MontoTotalLinea = ((detalle.PrecioUnitario) - detalle.MontoDescuento) + parseFloat(detalle.ImpuestoMonto);
        detalle.MontoTotalLinea = (detalle.PrecioUnitario);
        var subtotalT = 0;
        var descuentoT = 0;
        var impuestoT = 0;
        var totalT = 0;
        subtotalT = parseFloat(detalle.PrecioUnitario) - detalle.ImpuestoMonto;
        descuentoT = parseFloat(detalle.MontoDescuento);
        impuestoT = parseFloat(detalle.ImpuestoMonto);
        totalT = parseFloat(detalle.MontoTotalLinea);

        subtotalI += subtotalT;
        descuentosI += descuentoT;
        impuestosI += impuestoT;

        totalComprobanteI += totalT;

        var impuesto1T = parseFloat(detalle.Impuesto1);
        var impuesto2T = parseFloat(detalle.Impuesto2);
        var impuesto4T = parseFloat(detalle.Impuesto4);
        var impuesto8T = parseFloat(detalle.Impuesto8);
        var impuesto13T = parseFloat(detalle.Impuesto13);


        impuestoI1 += impuesto1T;
        impuestoI2 += impuesto2T;
        impuestoI4 += impuesto4T;
        impuestoI8 += impuesto8T;
        impuestoI13 += impuesto13T;


        $("#subtotalIN").text(formatoDecimal(subtotalI.toFixed(2)));
        $("#descuentoIN").text(formatoDecimal(descuentosI.toFixed(2)));
        $("#impuestoIN").text(formatoDecimal(impuestosI.toFixed(2)));
        $("#totalIN").text(formatoDecimal(totalComprobanteI.toFixed(2)));


        $("#impuesto1IN").text(formatoDecimal(parseFloat(impuestoI1).toFixed(2)));
        $("#impuesto2IN").text(formatoDecimal(parseFloat(impuestoI2).toFixed(2)));
        $("#impuesto4IN").text(formatoDecimal(parseFloat(impuestoI4).toFixed(2)));
        $("#impuesto8IN").text(formatoDecimal(parseFloat(impuestoI8).toFixed(2)));
        $("#impuesto13IN").text(formatoDecimal(parseFloat(impuestoI13).toFixed(2)));


        Productos.push(detalle);
      
    }
    function LimpiarDatosIN() {

        $("#NomProN").val("");

        $("#PrecUniN").val(0);
        $("#descIN").val(0);
        $("#TipoImpuestoN").val("15").trigger('change');
        $("#idTipoGastoN").val("NULL").trigger('change');
        $("#ImpuestoMontoN").val(0);
        $("#idTipoCombN").val("").trigger('change');
        $("#CantLitrosN").val(1);
    }

    function RellenaTablaIN() {
        var texto = '';

        $("#tbodyIN").html('');

        for (var i = 0; i < Productos.length; i++) {
            texto += '<tr>';

            texto += '<td align="left" style="padding-top:15px;">  <p style="font-size:13px;">' + Productos[i].NomPro + '</p></td>';

            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].PrecioUnitario) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].MontoDescuento) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].ImpuestoMonto) + '</p></td>';
            texto += '<td align="right" style="padding-top:13px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].MontoTotalLinea) + '</p></td>';
            texto += '<td align="center" style="padding-top:13px;">    <a style="margin-left: -1%; position: inherit !important;" onclick = "javascript: EliminaProductoN(' + i + ')" title="Eliminar" class="fa fa-trash icono"></a> ';
            texto += '</tr>'
        }


        $("#tbodyIN").html(texto);
    }

    function EliminaProductoIN(campo) {


                var subtotalT = 0;
                var descuentoT = 0;
                var impuestoT = 0;
                var totalT = 0;
                subtotalT = parseFloat(Productos[campo].PrecioUnitario);
                descuentoT = parseFloat(Productos[campo].MontoDescuento);
                impuestoT = parseFloat(Productos[campo].ImpuestoMonto);

                totalT = parseFloat(Productos[campo].MontoTotalLinea);

                subtotalI -= subtotalT;
                descuentosI -= descuentoT;
                impuestosI -= impuestoT;

                totalComprobanteI -= totalT;

                var impuesto1T = parseFloat(Productos[campo].Impuesto1);
                var impuesto2T = parseFloat(Productos[campo].Impuesto2);
                var impuesto4T = parseFloat(Productos[campo].Impuesto4);
                var impuesto8T = parseFloat(Productos[campo].Impuesto8);
                var impuesto13T = parseFloat(Productos[campo].Impuesto13);


                impuestoI1 -= impuesto1T;
                impuestoI2 -= impuesto2T;
                impuestoI4 -= impuesto4T;
                impuestoI8 -= impuesto8T;
                impuestoI13 -= impuesto13T;


                $("#subtotalIN").text(formatoDecimal(subtotalI.toFixed(2)));
                $("#descuentoIN").text(formatoDecimal(descuentosI.toFixed(2)));
                $("#impuestoIN").text(formatoDecimal(impuestosI.toFixed(2)));
                $("#totalIN").text(formatoDecimal(totalComprobanteI.toFixed(2)));


                $("#impuesto1IN").text(formatoDecimal(parseFloat(impuestoI1).toFixed(2)));
                $("#impuesto2IN").text(formatoDecimal(parseFloat(impuestoI2).toFixed(2)));
                $("#impuesto4IN").text(formatoDecimal(parseFloat(impuestoI4).toFixed(2)));
                $("#impuesto8IN").text(formatoDecimal(parseFloat(impuestoI8).toFixed(2)));
                $("#impuesto13IN").text(formatoDecimal(parseFloat(impuestoI13).toFixed(2)));

                Productos.splice(campo, 1);
                RellenaTablaI();


    }

    function onChangeTipoGastoN() {
        var combo = document.getElementById("idTipoGastoN");
        var selected = combo.options[combo.selectedIndex].text;

        if (selected.includes("COMB")) {
            $("#CombustibleN").attr("hidden", false);
        } else {
            $("#CombustibleN").attr("hidden", true);
        }
    }

    function maskN() {
        switch ($("#idClienteN").val()) {
            case "01":
                {
                    $("#CodProveedorN").inputmask({ "mask": "999-999999-99999" });
                    break;
                }
            case "02":
                {
                    $("#CodProveedorN").inputmask({ "mask": "99999999999999-9" });

                    break;
                }
            case "03":
                {
                    $("#CodProveedorN").inputmask({ "mask": "9999999999" });
                    break;
                }
            case "04":
                {
                    $("#CodProveedorN").inputmask({ "mask": "9999999999" });
                    break;
                }
            default:
                {
                    break;
                }
        }
    }
    function mask2N() {

        $("#CodProveedorN").attr("readonly", false);
        $("#DVN").attr("readonly", false);
        switch ($("input:radio[name=idProveedorN]:checked").val()) {
            case "01":
                {
                    //$("#CodProveedorP").inputmask({ "mask": "99-999-9999" });
                    $("#CodProveedorN").attr('maxlength', 18);
                    break;
                }
            case "02":
                {
                    //$("#CodProveedorP").inputmask({ "mask": "9999999-99-999999" });
                    $("#CodProveedorN").attr('maxlength', 18);
                    break;
                }
            case "03":
                {
                    // $("#CodProveedorP").inputmask({ "mask": "9999999999" });
                    $("#CodProveedorN").attr('maxlength', 15);
                    break;
                }
            case "04":
                {
                    //$("#CodProveedorP").inputmask({ "mask": "9999999999" });
                    $("#CodProveedorN").attr('maxlength', 15);
                    break;
                }
            default:
                {
                    break;
                }
        }
    }

              function GenerarIN()
              {
                  var button = document.getElementById('buttonSpinN');
                  if (typeof (button.getAttribute('data-loading')) === 'string') {
                      button.removeAttribute('data-loading');
                  }
                  else {
                      button.setAttribute('data-loading', '');
                  }


                  //

                 var checkbox1 = document.getElementById("simpN");
                  var checkbox2 = document.getElementById("extN");
                  var checkbox3 = document.getElementById("varN");
                  var checkbox4 = document.getElementById("nrecN");
                 var EncCompras =
                    {
                        ClaveHacienda: $("#NumFacturaN").val(),
                        ConsecutivoHacienda: $("#NumFacturaN").val(),
                        TipoIdentificacionCliente: "0",
                     NumFactura: $("#NumFacturaN").val(),
                     Comentario: $("#ComentarioFacturaN").val(),
                        CodProveedor: $("#CodProveedorN").val() + "[" + $("#DVP").val(),
                        NomProveedor: $("#NomProveedorN").val(),
                        FecFactura: $("#FecFacturaN").val(),
                        CodigoActividadEconomica: "0" ,
                        CodMoneda: $("#CodMoneda").val(),
                        CodCliente: "0",
                        NomCliente: "0",
                        TotalVenta: $("#subtotalIN").text(),
                        TotalImpuesto: $("#impuestoIN").text(),
                        TotalDescuentos: $("#descuentoIN").text(),
                        Impuesto1: $("#impuesto1IN").text() ,
                        Impuesto2: $("#impuesto2IN").text()  ,
                        Impuesto4: $("#impuesto4IN").text(),
                        Impuesto8: $("#impuesto8IN").text(),
                        Impuesto13: $("#impuesto13IN").text(),
                     TotalComprobante: $("#totalIN").text(),
                     ImagenB64: (ImageBae64 === '' ? '' : ImageBae64.toString().replace('data:image/jpeg;base64,', '').replace('data:image/png;base64,', '')),

                        ImagenBase64: (ImageBae64 === '' ? '' : ImageBae64.toString().replace('data:image/jpeg;base64,', '').replace('data:image/png;base64,', '')),
                        RegimenSimplificado: checkbox1.checked,
                     FacturaExterior: checkbox2.checked,
                     GastosVarios: checkbox3.checked,
                     FacturaNoRecibida: checkbox4.checked
                    };

                    var DetCompras = Productos;
                    var recibido = {
                            EncCompras,
                            DetCompras
                        };

                  var recibidos = JSON.stringify(recibido);
                  if (ValidarFacturaN()) {
                      $("#FaltaDatosN").css("display", "none");

                      $.ajax({
                          type: 'POST',

                          url: '@Url.Page("Editar", "Insertar")',
                          datatype: "application/json",
                          data: { recibidos: recibidos.toString() },
                          headers: {
                              RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                          },
                          success: function (json) {

                              console.log(json.resp + " -> " + json.success );
                              if (json.success == true) {
                                  button.removeAttribute('data-loading');
                                  $("#ErrorFacturaN").css("display", "none");
                                  //Aqui se meteria en el detalle
                                  var detalle = {
                                      id: json.resp,
                                      Proveedor: EncCompras.NomProveedor,
                                      CHacienda: EncCompras.NumFactura,
                                      CodProveedor: EncCompras.CodProveedor,
                                      //    idTipoGasto: $("#idTipoGasto").val(),
                                      Fecha: EncCompras.FecFactura,
                                      SubTotal: parseFloat(EncCompras.TotalVenta.replace(",", "").replace(",", "")),
                                      Descuento: parseFloat(EncCompras.TotalDescuentos.replace(",", "").replace(",", "")) ,
                                      Impuesto: parseFloat(EncCompras.TotalImpuesto.replace(",", "").replace(",", "")),
                                      Total: 0,
                                      Impuesto1: parseFloat(EncCompras.Impuesto1.replace(",", "").replace(",", "")),
                                      Impuesto2: parseFloat(EncCompras.Impuesto2.replace(",", "").replace(",", "")),
                                      Impuesto4: parseFloat(EncCompras.Impuesto4.replace(",", "").replace(",", "")),
                                      Impuesto8: parseFloat(EncCompras.Impuesto8.replace(",", "").replace(",", "")),
                                      Impuesto13: parseFloat(EncCompras.Impuesto13.replace(",", "").replace(",", "")),
                                      idTipoGasto: Productos[0].idTipoGasto,
                                      TotalOtrosCargos: 0,
                                      Comentario: ""
                                  };

                                  console.log(EncCompras);
                                  console.log(detalle);
                                  var subtotalT = 0;
                                  var descuentoT = 0;
                                  var impuestoT = 0;
                                  var totalT = 0;
                                  subtotalT = parseFloat(detalle.SubTotal);
                                  descuentoT = parseFloat(detalle.Descuento);
                                  impuestoT = parseFloat(detalle.Impuesto);
                                  detalle.Total = (subtotalT - descuentoT) + impuestoT
                                  ProdCadena.push(detalle);
                                  totalT = parseFloat(detalle.Total);
                                  var impuesto1T = parseFloat(detalle.Impuesto1);
                                  var impuesto2T = parseFloat(detalle.Impuesto2);
                                  var impuesto4T = parseFloat(detalle.Impuesto4);
                                  var impuesto8T = parseFloat(detalle.Impuesto8);
                                  var impuesto13T = parseFloat(detalle.Impuesto13);



                                  subtotal += subtotalT;
                                  descuentos += descuentoT;
                                  impuestos += impuestoT;

                                  totalComprobante += totalT;
                                  impuesto1 += impuesto1T;
                                  impuesto2 += impuesto2T;
                                  impuesto4 += impuesto4T;
                                  impuesto8 += impuesto8T;
                                  impuesto13 += impuesto13T;

                                  $("#subtotal").text(formatoDecimal(parseFloat(subtotal).toFixed(2)));
                                  $("#descuento").text(formatoDecimal(parseFloat(descuentos).toFixed(2)));
                                  $("#impuesto").text(formatoDecimal(parseFloat(impuestos).toFixed(2)));
                                  $("#total").text(formatoDecimal(parseFloat(totalComprobante).toFixed(2)));

                                  //
                                  $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
                                  $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));

                                  //Modificar por ser de panama
                                  LimpiarDatos();

                                  RellenaTabla();
                                  LimpiarDatosGeneralesN();
                                  LimpiarDatosIN();

                                  //$("#ModalInclusion").modal("hide");

                              } else {
                                  $("#ErrorFacturaN").text(json.resp);
                                  $("#ErrorFacturaN").css("display", "block");
                                  button.removeAttribute('data-loading');
                                  EliminaProductoIN(0);
                              }
                          },

                          beforeSend: function (xhr) {


                          },
                          complete: function () {

                          },
                          error: function (error) {

                              $("#ErrorFactura").css("display", "block");


                          }
                      });
                  } else {
                      $("#FaltaDatosN").css("display", "block");
                      button.removeAttribute('data-loading');
                      Productos = [];
                  }

    }

    function LimpiarDatosGeneralesN() {
        $("#NumFacturaN").val("");
        $("#CodProveedorN").val("");
        $("#DVP").val("");
        $("#NomProveedorN").val("");
        $("#FecFacturaN").val("");
        $("#subtotalIN").text("0");
        $("#impuestoIN").text("0");
        $("#descuentoIN").text("0");
        $("#impuesto1IN").text("0");
        $("#impuesto2IN").text("0");
        $("#impuesto4IN").text("0");
        $("#impuesto8IN").text("0");
        $("#impuesto13IN").text("0");
        $("#totalIN").text("0");
        ImagenBase64 = "";
        Productos = [];

        subtotalT = 0;
        descuentoT = 0;
        impuestoT = 0;
        totalT = 0;

        impuesto1T = 0;
        impuesto2T = 0;
        impuesto4T = 0;
        impuesto8T = 0;
        impuesto13T = 0;

        subtotalI = 0;
        impuestosI = 0;
        descuentosI = 0;
        totalComprobanteI = 0;

        impuestoI1 = 0;
        impuestoI2 = 0;
        impuestoI4 = 0;
        impuestoI8 = 0;
        impuestoI13 = 0;
        document.getElementById('imgPrincipalGN').src = "/img/cm.jpg";
        ImageBae64 = "";
        LimpiarDatosIN();
        RellenaTablaIN();
    }
    function ValidarFacturaN() {
        if (ProdCadena.find(a => a.CHacienda.trim() == $("#NumFacturaN").val() && a.CodProveedor == $("#CodProveedorN").val()) != undefined) {
            return false;
        }

        if ($("#NumFacturaN").val() == "") {
            return false;
        } else if ($("#CodProveedorN").val() == "") {
            return false;
        } else if ($("#NomProveedorN").val() == "") {
            return false;
        } else if ($("#FecFacturaN").val() == "")
        {
            return false;
        } else if (Productos.length == 0)
        {
            return false;
        } else if (ImageBae64 == "")
        {
            return false;
        } else if ($("#idTipoGastoN").val() == "NULL") {
            return false;
        }
        else {
            return true;
        }
    }

    async function EnviarFCN() {
        AgregarProductosIN();
        GenerarIN();

    }
</script>

<!--Programacion del modal-->

<div class="modal fade bd-example-modal-lg" id="ModalInclusion" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="exampleModalLongTitle">Inclusión de Factura Manual</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">

                <div class="ibox">
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-6">
                                <center>
                                    <img id="imgPrincipalG" src="/img/cm.jpg" alt="image" style="width:250px; height:250px;border-radius: 15px;" class="img-fluid" />
                                    <br />
                                    <br />

                                    <label style="font-size: 13px;" class="label" for="imgPrincipalUploadG">Subir Imagen</label><input id="imgPrincipalUploadG" accept=".jpg, .png" style="opacity:0; display:none;" type="file" name="imgPrincipalUploadG" />

                                </center>
                            </div>
                            <div class="col-sm-6">



                                <label class="col-form-label">Tipo Indentificación:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12" style="text-align: center;">
                                        <input type="radio" name="idProveedor" id="idProveedor1" onclick="javascript: mask2();" value="01"> Física &nbsp;
                                        <input type="radio" name="idProveedor" id="idProveedor2" onclick="javascript: mask2();" value="02"> Jurídica &nbsp;
                                        <input type="radio" name="idProveedor" id="idProveedor3" onclick="javascript: mask2();" value="03"> DIMEX &nbsp;
                                        <input type="radio" name="idProveedor" id="idProveedor4" onclick="javascript: mask2();" value="04"> NITE
                                    </div>
                                </div>


                                <label class="col-form-label">Cédula Proveedor:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" id="CodProveedor" list="proveedoresCR" onchange="javascript: onChangeProveedorCR(0);" class="form-control">
                                        <datalist id="proveedoresCR">
                                            @foreach (var item in Model.Proveedores)
                                            {
                                                <option value="@item.RUC"> @item.RUC</option>

                                            }



                                        </datalist>
                                    </div>
                                </div>

                                <label class="col-form-label">Nombre Proveedor:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" asp-for="Objeto1.EncCompras.NomProveedor" onchange="javascript: onChangeProveedorCR(1);" list="proveedoresNomCR" id="NomProveedor" class="form-control">
                                        <datalist id="proveedoresNomCR">
                                            @foreach (var item in Model.Proveedores)
                                            {
                                                <option value="@item.Nombre"> @item.Nombre</option>

                                            }



                                        </datalist>
                                    </div>
                                </div>


                                <label class="col-form-label">Número Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" asp-for="Objeto1.EncCompras.NumFactura" id="NumFactura" class="form-control" maxlength="5" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" placeholder="Digite los últimos 5 dígitos del consecutivo en caso de ser electronica">
                                    </div>
                                </div>

                                <label class="col-form-label">Fecha Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="date" asp-for="Objeto1.EncCompras.FecFactura" onchange="javascript: onChangeFecFactura();" id="FecFactura" class="form-control">
                                    </div>
                                </div>


                                <label class="col-form-label">Comentarios:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" asp-for="Objeto1.EncCompras.Comentario" id="ComentarioFactura" class="form-control">
                                    </div>
                                </div>



                                <label class="col-form-label">Tipo Documento:</label>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Regimen Simplificado
                                            <input type="checkbox" id="simp" onchange="javascript: check('1');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura Exterior
                                            <input type="checkbox" id="ext" onchange="javascript: check('2');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Gastos Varios
                                            <input type="checkbox" id="var" onchange="javascript: check('3');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12" hidden>
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura No Recibida
                                            <input type="checkbox" id="nrec" onchange="javascript: check('4');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                </div>



                            </div>

                        </div>

                    </div>
                </div>

                <div class="ibox">
                    <label class="text-danger" id="ErrorFactura" style="display: none;"> Ha ocurrido un error al intentar insertar la factura, por favor volver a intentar</label>
                    <label class="text-danger" id="FaltaDatos" style="display: none;"> Parecen que faltan datos por rellenar</label>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-3">
                                <label class="col-form-label">Detalle:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" id="NomPro" class="form-control">
                                    </div>
                                </div>
                                <div hidden>

                                    <label class="col-form-label">Monto Descuento:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <input type="number" id="descI" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3">

                                <label class="col-form-label">Tipo Impuesto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="TipoImpuesto" class="form-control  ">
                                            <option value="NULL" selected>-IVA-</option>

                                            <option value="0">I.V.A 0</option>
                                            <option value="1">I.V.A 1</option>
                                            <option value="2">I.V.A 2</option>
                                            <option value="4">I.V.A 4</option>
                                            <option value="8">I.V.A 8</option>
                                            <option value="13">I.V.A 13</option>


                                        </select>
                                    </div>
                                </div>
                                <div hidden>

                                    <label class="col-form-label">Monto Impuesto:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <input type="number" id="ImpuestoMonto" class="form-control">
                                        </div>
                                    </div>
                                </div>


                            </div>
                            <div class="col-sm-3">

                                <label class="col-form-label">Tipo Gasto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="idTipoGasto" class="form-control ">
                                            <option value="NULL" selected>-Tipo Gasto-</option>
                                            @foreach (var item in Model.Gastos.OrderBy(a => a.Nombre))
                                            {
                                                <option value="@item.idTipoGasto">@item.Nombre</option>
                                            }




                                        </select>
                                    </div>
                                </div>

                            </div>
                            <div class="col-sm-3">
                                <label class="col-form-label">Precio Unitario:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" id="PrecUniI" class="form-control">
                                    </div>
                                </div>






                            </div>
                            <div class="col-sm-12">
                                <div class="row">
                                    <div class="col-sm-8"></div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        @*<button onclick="javascript: AgregarProductosI();" class="btn btn-w-m btn-primary" title="Agregar a la lista">+ Agregar</button>*@
                                        <button id="buttonSpin" onclick="javascript: EnviarFC();" class="ladda-button green expand-left"><span class="label-submit">Guardar Cambios</span> <span class="spinner"></span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ibox" hidden>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-12">

                                <div class="table-responsive tableFixHead" style=" overflow-y:scroll;    z-index: 5; height: 300px;">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th align="center" style=" text-align: center;"><h3>Nombre</h3></th>

                                                <th align="center" style=" text-align: center;"><h3>Precio Unitario</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Descuento</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Impuesto</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Total</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Eliminar</h3></th>


                                            </tr>

                                        </thead>
                                        <tbody id="tbodyI">
                                        </tbody>
                                    </table>

                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-8">

                                    </div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        <div class="row">

                                            <div class="col-sm-12">

                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table; font-weight: 500 !important; font-style: normal;">SubTotal:</label>

                                                            </td>
                                                            <td>
                                                                <label id="subtotalI" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>

                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Descuento:</label>

                                                            </td>
                                                            <td>
                                                                <label id="descuentoI" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Impuesto:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuestoI" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 1:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto1I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 2:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto2I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 4:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto4I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 8:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto8I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 13:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto13I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>



                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Total:</label>

                                                            </td>
                                                            <td>
                                                                <label id="totalI" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>


                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--<div class="d-flex justify-content-end">-->
                @*<button onclick="javascript: GenerarI();" class="btn btn-w-m btn-primary" title="Guardar">Guardar Cambios</button>*@
                <!--<button id="buttonSpin" onclick="javascript: GenerarI();" class="ladda-button green expand-left"><span class="label-submit">Guardar Cambios</span> <span class="spinner"></span></button>
                </div>-->

            </div>
        </div>
    </div>
</div>


<!--Programacion del modal para editar una factura manual-->

<div class="modal fade bd-example-modal-lg" id="ModalEdicion" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="exampleModalLongTitle2">Edición de Factura Manual</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">

                <div class="ibox">
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-6">
                                <center>
                                    <img id="imgPrincipalGE" src="/img/cm.jpg" alt="image" style="width:250px; height:250px;border-radius: 15px;" class="img-fluid" />
                                    <br />
                                    <br />

                                    <label style="font-size: 13px;" class="label" for="imgPrincipalUploadGE">Subir Imagen</label><input id="imgPrincipalUploadGE" accept=".jpg, .png" style="opacity:0; display:none;" type="file" name="imgPrincipalUploadGE" />

                                </center>
                            </div>
                            <div class="col-sm-6">



                                <label class="col-form-label">Tipo Identificación:</label>
                                @if (Model.Pais == "P" || Model.Pais == "N")
                                {
                                    <div class="form-group row">
                                        <div class="col-sm-12" style="text-align: center;">
                                            <input type="radio" name="idProvedor" id="idProvedor1" onclick="javascript: maskE2();" value="01"> Natural &nbsp;
                                            <input type="radio" name="idProvedor" id="idProvedor2" onclick="javascript: maskE2();" value="02"> Jurídica &nbsp;
                                            <input type="radio" name="idProvedor" id="idProvedor3" onclick="javascript: maskE2();" value="03"> Extranjero
                                        </div>
                                    </div>
                                }
                                else if(Model.Pais == "C")
                                {
                                    <div class="form-group row">
                                        <div class="col-sm-12" style="text-align: center;">
                                            <input type="radio" name="idProvedor" id="idProvedor1" onclick="javascript: maskE2();" value="01"> Física &nbsp;
                                            <input type="radio" name="idProvedor" id="idProvedor2" onclick="javascript: maskE2();" value="02"> Jurídica &nbsp;
                                            <input type="radio" name="idProvedor" id="idProvedor3" onclick="javascript: maskE2();" value="03"> DIMEX &nbsp;
                                            <input type="radio" name="idProvedor" id="idProvedor4" onclick="javascript: maskE2();" value="04"> NITE
                                        </div>
                                    </div>
                                }


                                @if (Model.Pais == "P" )
                                {
                                    <label class="col-form-label">RUC Proveedor:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-8">

                                            <input type="text" id="CodProveedorE" readonly class="form-control">
                                        </div>
                                        <div class="col-sm-4">

                                            <input type="text" id="DVE" placeholder="D.V" readonly class="form-control">
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <label class="col-form-label">Cédula Proveedor:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <input type="text" id="CodProveedorE" class="form-control">
                                        </div>
                                    </div>
                                }


                                <label class="col-form-label">Nombre Proveedor:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" id="NomProveedorE" class="form-control">
                                    </div>
                                </div>


                                <label class="col-form-label">Número Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" id="NumFacturaE" class="form-control" maxlength="5" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" placeholder="Digite los últimos 5 dígitos del consecutivo en caso de ser electronica">
                                    </div>
                                </div>

                                <label class="col-form-label">Fecha Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="date" onchange="javascript: onChangeFecFacturaE();" id="FecFacturaE" class="form-control">
                                    </div>
                                </div>






                                <label class="col-form-label">Tipo Documento:</label>
                                @if (Model.Pais == "C")
                                {
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                                Regimen Simplificado
                                                <input type="checkbox" id="simpE" onchange="javascript: checkE('1');">
                                                <span class="check"></span>
                                            </label>
                                        </div>
                                        <div class="col-sm-12">
                                            <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                                Factura Exterior
                                                <input type="checkbox" id="extE" onchange="javascript: checkE('2');">
                                                <span class="check"></span>
                                            </label>
                                        </div>
                                        <div class="col-sm-12">
                                            <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                                Gastos Varios
                                                <input type="checkbox" id="varE" onchange="javascript: checkE('3');">
                                                <span class="check"></span>
                                            </label>
                                        </div>
                                        <div class="col-sm-12" hidden>
                                            <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                                Factura No Recibida
                                                <input type="checkbox" id="nrecE" onchange="javascript: checkE('4');">
                                                <span class="check"></span>
                                            </label>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                                Factura Fiscal
                                                <input type="checkbox" id="simpE" onchange="javascript: checkE('1');">
                                                <span class="check"></span>
                                            </label>
                                        </div>
                                        <div class="col-sm-12">
                                            <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                                Factura Exterior
                                                <input type="checkbox" id="extE" onchange="javascript: checkE('2');">
                                                <span class="check"></span>
                                            </label>
                                        </div>
                                        <div class="col-sm-12">
                                            <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                                Gastos Varios
                                                <input type="checkbox" id="varE" onchange="javascript: checkE('3');">
                                                <span class="check"></span>
                                            </label>
                                        </div>
                                        <div class="col-sm-12">
                                            <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                                Factura Electrónica
                                                <input type="checkbox" id="nrecE" onchange="javascript: checkE('4');">
                                                <span class="check"></span>
                                            </label>
                                        </div>
                                    </div>
                                }




                            </div>

                        </div>

                    </div>
                </div>

                <div class="ibox">
                    <input id="idFacE" hidden />
                    <label class="text-danger" id="ErrorFacturaE" style="display: none;"> Ha ocurrido un error al intentar insertar la factura, por favor volver a intentar</label>
                    <label class="text-danger" id="FaltaDatosE" style="display: none;"> Parecen que faltan datos por rellenar</label>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-3">
                                <label class="col-form-label">Detalle:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" id="NomProE" class="form-control">
                                    </div>
                                </div>
                                <div hidden>

                                    <label class="col-form-label">Monto Descuento:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <input type="number" id="descE" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3">

                                <label class="col-form-label">Tipo Impuesto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="TipoImpuestoE" class="form-control  ">
                                            <option value="NULL" selected>-IVA-</option>
                                            @if (Model.Pais == "C")
                                            {
                                                <option value="0">I.V.A 0</option>
                                                <option value="1">I.V.A 1</option>
                                                <option value="2">I.V.A 2</option>
                                                <option value="4">I.V.A 4</option>
                                                <option value="8">I.V.A 8</option>
                                                <option value="13">I.V.A 13</option>
                                            }
                                            else if (Model.Pais == "P")
                                            {
                                                <option value="0">Exento</option>
                                                <option value="7" selected>
                                                    ITBMS(7%)
                                                </option>
                                                <option value="10">
                                                    ITBMS(10%)
                                                </option>
                                            }
                                            else if (Model.Pais == "N")
                                            {
                                                <option value="0">Exento</option>
                                                <option value="13" >
                                                    IV(13%)
                                                </option>
                                                <option value="15" selected>
                                                    IVA(15%)
                                                </option>
                                            }




                                        </select>
                                    </div>
                                </div>
                                <div hidden>

                                    <label class="col-form-label">Monto Impuesto:</label>
                                    <div class="form-group row">
                                        <div class="col-sm-12">

                                            <input type="number" id="ImpuestoMontoE" class="form-control">
                                        </div>
                                    </div>
                                </div>


                            </div>
                            <div class="col-sm-3">

                                <label class="col-form-label">Tipo Gasto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="idTipoGastoE" class="form-control " onchange="javascript: onChangeTipoGastoE()">
                                            <option value="NULL" selected>-Tipo Gasto-</option>
                                            @foreach (var item in Model.Gastos.OrderBy(a => a.Nombre))
                                            {
                                                <option value="@item.idTipoGasto">@item.Nombre</option>
                                            }




                                        </select>
                                    </div>
                                </div>

                            </div>
                            <div class="col-sm-3">
                                <label class="col-form-label">Precio Unitario:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" id="PrecUniE" class="form-control">
                                    </div>
                                </div>






                            </div>

                            <!--En caso de ser combustible-->
                            <div class="col-sm-12" hidden id="CombustibleE">
                                <div class="row">
                                    <div class="col-sm-3">
                                        <label class="col-form-label">Cantidad Litros:</label>
                                        <div class="form-group row">
                                            <div class="col-sm-12">

                                                <input type="number" id="CantLitrosE" value="1" class="form-control">
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-sm-3">
                                        <label class="col-form-label">Tipo Combustible:</label>
                                        <div class="form-group row">
                                            <div class="col-sm-12">

                                                <select id="idTipoCombE" class="form-control ">
                                                    <option value="" selected>-Tipo Combustible-</option>

                                                    <option value="Diesel">Diesel</option>
                                                    <option value="Gasolina 95">Gasolina 95</option>
                                                    <option value="Gasolina 90">Gasolina 90</option>
                                                    <option value="Gas LP">Gas LP</option>


                                                </select>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <!--Termina En caso de ser combustible-->

                            <div class="col-sm-12">
                                <div class="row">
                                    <div class="col-sm-8"></div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        @*<button onclick="javascript: AgregarProductosI();" class="btn btn-w-m btn-primary" title="Agregar a la lista">+ Agregar</button>*@
                                        <button id="buttonSpinE" onclick="javascript: EnviarFCE();" class="ladda-button green expand-left"><span class="label-submit">Guardar Cambios</span> <span class="spinner"></span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ibox" hidden>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-12">

                                <div class="table-responsive tableFixHead" style=" overflow-y:scroll;    z-index: 5; height: 300px;">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th align="center" style=" text-align: center;"><h3>Nombre</h3></th>

                                                <th align="center" style=" text-align: center;"><h3>Precio Unitario</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Descuento</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Impuesto</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Total</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Eliminar</h3></th>


                                            </tr>

                                        </thead>
                                        <tbody id="tbodyE">
                                        </tbody>
                                    </table>

                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-8">

                                    </div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        <div class="row">

                                            <div class="col-sm-12">

                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table; font-weight: 500 !important; font-style: normal;">SubTotal:</label>

                                                            </td>
                                                            <td>
                                                                <label id="subtotalE" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>

                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Descuento:</label>

                                                            </td>
                                                            <td>
                                                                <label id="descuentoE" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Impuesto:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuestoE" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 1:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto1E" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 2:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto2E" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 4:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto4E" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 8:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto8E" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 13:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto13E" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>



                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Total:</label>

                                                            </td>
                                                            <td>
                                                                <label id="totalE" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>


                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--<div class="d-flex justify-content-end">-->
                @*<button onclick="javascript: GenerarI();" class="btn btn-w-m btn-primary" title="Guardar">Guardar Cambios</button>*@
                <!--<button id="buttonSpin" onclick="javascript: GenerarI();" class="ladda-button green expand-left"><span class="label-submit">Guardar Cambios</span> <span class="spinner"></span></button>
                </div>-->

            </div>
        </div>
    </div>
</div>

<!--Script para insertar una factura manual-->
<script>
    var ImageBae64 = '';
    var IMG2 = '';
    var Productos = [];
    var subtotalI = 0;
    var impuestosI = 0;
    var descuentosI = 0;
    var totalComprobanteI = 0;

    var impuestoI1 = 0;
    var impuestoI2 = 0;
    var impuestoI4 = 0;
    var impuestoI8 = 0;
    var impuestoI13 = 0;


    async function readFilePrincipal(input) {
        if (input.files && input.files[0]) {
            /*const maxAllowSize = 512000;*/
            //const maxAllowSize = 2800000;
            const maxAllowSize = 5000000;
            if (input.files[0].size > maxAllowSize) {
                alert("Esta imagen es muy pesada");
                input.value = '';
            } else {
                var reader = new FileReader();
                var img = document.createElement("img");
                var canvas = document.createElement('canvas');

                reader.onload = function (e) {
                    img.src = e.target.result;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);

                    var MAX_WIDTH = 800;
                    var MAX_HEIGHT = 600;
                    var width = img.width;
                    var height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    var dataurl = canvas.toDataURL("image/jpg");
                    document.getElementById('imgPrincipalG').src = e.target.result;

                   // console.log(dataurl);
                    ImageBae64 = dataurl;//e.target.result;
                    IMG2 = e.target.result;
                    //var idF = setInterval(cancelar, 3000);

                    //function cancelar() {
                    //    console.log("cancelar -> " +ImageBae64);
                    //    if (ImageBae64 != "data:,") {
                    //        clearInterval(idF);
                    //    }
                    //}
                }

            }

            reader.readAsDataURL(input.files[0]);
        }



    }

    var fileUploadPrincipal = document.getElementById('imgPrincipalUploadG');
    fileUploadPrincipal.onchange = async function (e) {
        await readFilePrincipal(e.srcElement);
        var idF = setInterval(async function () {

            if (ImageBae64 != "data:,") {
                //alert("Imagen agregada con éxito");
                clearInterval(idF);
            } else {
                await readFilePrincipal(e.srcElement);
            }
        }, 1500);

    }

    function check(i) {

        var checkbox1 = document.getElementById("simp");
        var checkbox2 = document.getElementById("ext");
        var checkbox3 = document.getElementById("var");
        var checkbox4 = document.getElementById("nrec");
        if (i == "1") {

            checkbox2.checked = false;
            checkbox3.checked = false;
            checkbox1.checked = true;
            $("#CHacienda").removeAttr("readonly");
            $("#ConsHacienda").removeAttr("readonly");

        }
        else if (i == "2") {
            checkbox3.checked = false;
            checkbox2.checked = true;
            checkbox1.checked = false;
            $("#CHacienda").attr("readonly", "readonly");
            $("#ConsHacienda").attr("readonly", "readonly");

            $("#CHacienda").val("");
            $("#ConsHacienda").val("");
        } else if (i == "3") {
            checkbox3.checked = true;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = false;
        } else {
            checkbox3.checked = false;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = true;
        }
    }
    function AbrirModal() {
        $("#ModalInclusion").modal("show");
    }
    function AgregarProductosI() {


        var detalle = {

            CodPro: "1",
            NomPro: ($("#NomPro").val() == "" ? "Detalle factura" : $("#NomPro").val()),
            idTipoGasto: $("#idTipoGasto").val() == "NULL" ? "0" : $("#idTipoGasto").val(),
            Cantidad: "1",
            PrecioUnitario: $("#PrecUniI").val(),
            MontoDescuento: $("#descI").val(),
            ImpuestoTarifa: $("#TipoImpuesto").val(),
            ImpuestoMonto: $("#ImpuestoMonto").val(),
            MontoTotalLinea: 0,
            Impuesto1: 0,
            Impuesto2: 0,
            Impuesto4: 0,
            Impuesto8: 0,
            Impuesto13: 0
        };

        switch ($("#TipoImpuesto").val()) {
            case "1":
                {
                    detalle.Impuesto1 += detalle.ImpuestoMonto;
                    break;
                }
            case "2":
                {
                    detalle.Impuesto2 += detalle.ImpuestoMonto;
                    break;
                }
            case "4":
                {
                    detalle.Impuesto4 += detalle.ImpuestoMonto;
                    break;
                }
            case "8":
                {
                    detalle.Impuesto8 += detalle.ImpuestoMonto;
                    break;
                }
            case "13":
                {
                    detalle.Impuesto13 += detalle.ImpuestoMonto;
                    break;
                }
        }

        detalle.MontoTotalLinea = ((detalle.PrecioUnitario) - detalle.MontoDescuento) + parseFloat(detalle.ImpuestoMonto);

        var subtotalT = 0;
        var descuentoT = 0;
        var impuestoT = 0;
        var totalT = 0;
        subtotalT = parseFloat(detalle.PrecioUnitario);
        descuentoT = parseFloat(detalle.MontoDescuento);
        impuestoT = parseFloat(detalle.ImpuestoMonto);
        totalT = parseFloat(detalle.MontoTotalLinea);

        subtotalI += subtotalT;
        descuentosI += descuentoT;
        impuestosI += impuestoT;

        totalComprobanteI += totalT;

        var impuesto1T = parseFloat(detalle.Impuesto1);
        var impuesto2T = parseFloat(detalle.Impuesto2);
        var impuesto4T = parseFloat(detalle.Impuesto4);
        var impuesto8T = parseFloat(detalle.Impuesto8);
        var impuesto13T = parseFloat(detalle.Impuesto13);


        impuestoI1 += impuesto1T;
        impuestoI2 += impuesto2T;
        impuestoI4 += impuesto4T;
        impuestoI8 += impuesto8T;
        impuestoI13 += impuesto13T;


        $("#subtotalI").text(formatoDecimal(subtotalI.toFixed(2)));
        $("#descuentoI").text(formatoDecimal(descuentosI.toFixed(2)));
        $("#impuestoI").text(formatoDecimal(impuestosI.toFixed(2)));
        $("#totalI").text(formatoDecimal(totalComprobanteI.toFixed(2)));


        $("#impuesto1I").text(formatoDecimal(parseFloat(impuestoI1).toFixed(2)));
        $("#impuesto2I").text(formatoDecimal(parseFloat(impuestoI2).toFixed(2)));
        $("#impuesto4I").text(formatoDecimal(parseFloat(impuestoI4).toFixed(2)));
        $("#impuesto8I").text(formatoDecimal(parseFloat(impuestoI8).toFixed(2)));
        $("#impuesto13I").text(formatoDecimal(parseFloat(impuestoI13).toFixed(2)));


        Productos.push(detalle);
        //LimpiarDatosI();
       // RellenaTablaI();
    }
    function LimpiarDatosI() {

        $("#NomPro").val("");

        $("#PrecUniI").val(0);
        $("#descI").val(0);
        $("#TipoImpuesto").val("0").trigger('change');
        $("#idTipoGasto").val("NULL").trigger('change');
        $("#ImpuestoMonto").val(0);

    }

    function RellenaTablaI() {
        var texto = '';

        $("#tbodyI").html('');

        for (var i = 0; i < Productos.length; i++) {
            texto += '<tr>';

            texto += '<td align="left" style="padding-top:15px;">  <p style="font-size:13px;">' + Productos[i].NomPro + '</p></td>';

            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].PrecioUnitario) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].MontoDescuento) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].ImpuestoMonto) + '</p></td>';
            texto += '<td align="right" style="padding-top:13px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].MontoTotalLinea) + '</p></td>';
            texto += '<td align="center" style="padding-top:13px;">    <a style="margin-left: -1%; position: inherit !important;" onclick = "javascript: EliminaProductoI(' + i + ')" title="Eliminar" class="fa fa-trash icono"></a> ';
            texto += '</tr>'
        }
        $("#tbodyI").html(texto);
    }

    function EliminaProductoI(campo) {


                var subtotalT = 0;
                var descuentoT = 0;
                var impuestoT = 0;
        var totalT = 0;
                subtotalT = parseFloat(Productos[campo].PrecioUnitario);
                descuentoT = parseFloat(Productos[campo].MontoDescuento);
                impuestoT = parseFloat(Productos[campo].ImpuestoMonto);

                totalT = parseFloat(Productos[campo].MontoTotalLinea);

                subtotalI -= subtotalT;
                descuentosI -= descuentoT;
                impuestosI -= impuestoT;

                totalComprobanteI -= totalT;

                var impuesto1T = parseFloat(Productos[campo].Impuesto1);
                var impuesto2T = parseFloat(Productos[campo].Impuesto2);
                var impuesto4T = parseFloat(Productos[campo].Impuesto4);
                var impuesto8T = parseFloat(Productos[campo].Impuesto8);
                var impuesto13T = parseFloat(Productos[campo].Impuesto13);


                impuestoI1 -= impuesto1T;
                impuestoI2 -= impuesto2T;
                impuestoI4 -= impuesto4T;
                impuestoI8 -= impuesto8T;
                impuestoI13 -= impuesto13T;


                $("#subtotalI").text(formatoDecimal(subtotalI.toFixed(2)));
                $("#descuentoI").text(formatoDecimal(descuentosI.toFixed(2)));
                $("#impuestoI").text(formatoDecimal(impuestosI.toFixed(2)));
                $("#totalI").text(formatoDecimal(totalComprobanteI.toFixed(2)));


                $("#impuesto1I").text(formatoDecimal(parseFloat(impuestoI1).toFixed(2)));
                $("#impuesto2I").text(formatoDecimal(parseFloat(impuestoI2).toFixed(2)));
                $("#impuesto4I").text(formatoDecimal(parseFloat(impuestoI4).toFixed(2)));
                $("#impuesto8I").text(formatoDecimal(parseFloat(impuestoI8).toFixed(2)));
                $("#impuesto13I").text(formatoDecimal(parseFloat(impuestoI13).toFixed(2)));

                Productos.splice(campo, 1);
                RellenaTablaI();


    }



    function mask() {
        switch ($("#idCliente").val()) {
            case "01":
                {
                    $("#CodCliente").inputmask({ "mask": "9-9999-9999" });
                    break;
                }
            case "02":
                {
                    $("#CodCliente").inputmask({ "mask": "9-999-999999" });
                    break;
                }
            case "03":
                {
                    $("#CodCliente").inputmask({ "mask": "999999999999" });
                    break;
                }
            case "04":
                {
                    $("#CodCliente").inputmask({ "mask": "9999999999" });
                    break;
                }
            default:
                {
                    break;
                }
        }
    }
    function mask2() {
        switch ($("input:radio[name=idProveedor]:checked").val()) {
            case "01":
                {
                    $("#CodProveedor").inputmask({ "mask": "9-9999-9999" });
                    break;
                }
            case "02":
                {
                    $("#CodProveedor").inputmask({ "mask": "9-999-999999" });
                    break;
                }
            case "03":
                {
                    $("#CodProveedor").inputmask({ "mask": "999999999999" });
                    break;
                }
            case "04":
                {
                    $("#CodProveedor").inputmask({ "mask": "9999999999" });
                    break;
                }
            default:
                {
                    break;
                }
        }
    }

              function GenerarI()
              {
                  var button = document.getElementById('buttonSpin');
                  if (typeof (button.getAttribute('data-loading')) === 'string') {
                      button.removeAttribute('data-loading');
                  }
                  else {
                      button.setAttribute('data-loading', '');
                  }

                 var checkbox1 = document.getElementById("simp");
                  var checkbox2 = document.getElementById("ext");
                  var checkbox3 = document.getElementById("var");
                  var checkbox4 = document.getElementById("nrec");
                 var EncCompras =
                    {
                        ClaveHacienda: $("#NumFactura").val(),
                        ConsecutivoHacienda: $("#NumFactura").val(),
                        TipoIdentificacionCliente: "0",
                        Comentario: $("#ComentarioFactura").val(),
                        NumFactura: $("#NumFactura").val(),
                        CodProveedor: $("#CodProveedor").val(),
                        NomProveedor: $("#NomProveedor").val(),
                        FecFactura: $("#FecFactura").val(),
                        CodigoActividadEconomica: "0" ,
                        CodMoneda: $("#CodMoneda").val(),
                        CodCliente: "0",
                        NomCliente: "0",
                        TotalVenta: $("#subtotalI").text(),
                        TotalImpuesto: $("#impuestoI").text(),
                        TotalDescuentos: $("#descuentoI").text(),
                        Impuesto1: $("#impuesto1I").text() ,
                        Impuesto2: $("#impuesto2I").text()  ,
                        Impuesto4: $("#impuesto4I").text(),
                        Impuesto8: $("#impuesto8I").text(),
                        Impuesto13: $("#impuesto13I").text(),
                     TotalComprobante: $("#totalI").text(),
                     ImagenB64: (ImageBae64 === '' ? '' : ImageBae64.toString().replace('data:image/jpeg;base64,', '').replace('data:image/png;base64,', '')),

                        ImagenBase64: (ImageBae64 === '' ? '' : ImageBae64.toString().replace('data:image/jpeg;base64,', '').replace('data:image/png;base64,', '')),
                        RegimenSimplificado: checkbox1.checked,
                     FacturaExterior: checkbox2.checked,
                     GastosVarios: checkbox3.checked,
                     FacturaNoRecibida: false//checkbox4.checked
                    };

                    var DetCompras = Productos;
                    var recibido = {
                            EncCompras,
                            DetCompras
                        };

                        var recibidos = JSON.stringify(recibido);
                  if (ValidarFactura()) {
                      $("#FaltaDatos").css("display", "none");
                      $.ajax({
                          type: 'POST',

                          url: '@Url.Page("Editar", "Insertar")',
                          datatype: "application/json",
                          data: { recibidos: recibidos.toString() },
                          headers: {
                              RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                          },
                          success: function (json) {

                              console.log(json);
                              if (json.success == true) {
                                  button.removeAttribute('data-loading');
                                  $("#ErrorFactura").css("display", "none");
                                  //Aqui se meteria en el detalle
                                  var detalle = {
                                      id: json.resp,
                                      Proveedor: EncCompras.NomProveedor,
                                      CHacienda: EncCompras.NumFactura,
                                      //    idTipoGasto: $("#idTipoGasto").val(),
                                      Fecha: EncCompras.FecFactura,
                                      SubTotal: parseFloat(EncCompras.TotalVenta.replace(",", "").replace(",", "")),
                                      Descuento: parseFloat(EncCompras.TotalDescuentos.replace(",", "").replace(",", "")),
                                      Impuesto: parseFloat(EncCompras.TotalImpuesto.replace(",", "").replace(",", "")),
                                      Total: 0,
                                      Impuesto1: parseFloat(EncCompras.Impuesto1.replace(",", "").replace(",", "")),
                                      Impuesto2: parseFloat(EncCompras.Impuesto2.replace(",", "").replace(",", "")),
                                      Impuesto4: parseFloat(EncCompras.Impuesto4.replace(",", "").replace(",", "")),
                                      Impuesto8: parseFloat(EncCompras.Impuesto8.replace(",", "").replace(",", "")),
                                      Impuesto13: parseFloat(EncCompras.Impuesto13.replace(",", "").replace(",", "")),
                                      idTipoGasto: Productos[0].idTipoGasto,
                                      TotalOtrosCargos: 0,
                                      Comentario: ""
                                  };

                                  console.log(EncCompras);
                                  console.log(detalle);
                                  var subtotalT = 0;
                                  var descuentoT = 0;
                                  var impuestoT = 0;
                                  var totalT = 0;
                                  subtotalT = parseFloat(detalle.SubTotal);
                                  descuentoT = parseFloat(detalle.Descuento);
                                  impuestoT = parseFloat(detalle.Impuesto);
                                  detalle.Total = (subtotalT - descuentoT) + impuestoT
                                  ProdCadena.push(detalle);
                                  totalT = parseFloat(detalle.Total);
                                  var impuesto1T = parseFloat(detalle.Impuesto1);
                                  var impuesto2T = parseFloat(detalle.Impuesto2);
                                  var impuesto4T = parseFloat(detalle.Impuesto4);
                                  var impuesto8T = parseFloat(detalle.Impuesto8);
                                  var impuesto13T = parseFloat(detalle.Impuesto13);




                                  subtotal += subtotalT;
                                  descuentos += descuentoT;
                                  impuestos += impuestoT;

                                  totalComprobante += totalT;
                                  impuesto1 += impuesto1T;
                                  impuesto2 += impuesto2T;
                                  impuesto4 += impuesto4T;
                                  impuesto8 += impuesto8T;
                                  impuesto13 += impuesto13T;

                                  $("#subtotal").text(formatoDecimal(parseFloat(subtotal).toFixed(2)));
                                  $("#descuento").text(formatoDecimal(parseFloat(descuentos).toFixed(2)));
                                  $("#impuesto").text(formatoDecimal(parseFloat(impuestos).toFixed(2)));
                                  $("#total").text(formatoDecimal(parseFloat(totalComprobante).toFixed(2)));

                                  $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
                                  $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));
                                  $("#impuesto4").text(formatoDecimal(parseFloat(impuesto4).toFixed(2)));
                                  $("#impuesto8").text(formatoDecimal(parseFloat(impuesto8).toFixed(2)));
                                  $("#impuesto13").text(formatoDecimal(parseFloat(impuesto13).toFixed(2)));
                                  LimpiarDatos();

                                  RellenaTabla();
                                  LimpiarDatosGenerales();

                                  $("#ModalInclusion").modal("hide");

                              } else {
                                  $("#ErrorFactura").text(json.resp);
                                  $("#ErrorFactura").css("display", "block");
                                  button.removeAttribute('data-loading');
                                  EliminaProductoI(0);
                              }
                          },

                          beforeSend: function (xhr) {


                          },
                          complete: function () {

                          },
                          error: function (error) {
                              button.removeAttribute('data-loading');
                              $("#ErrorFactura").css("display", "block");


                          }
                      });
                  } else {
                      $("#FaltaDatos").css("display", "block");
                      button.removeAttribute('data-loading');
                      Productos = [];
                  }
    }

    function LimpiarDatosGenerales() {
        $("#NumFactura").val("");
        $("#CodProveedor").val("");
        $("#NomProveedor").val("");
        $("#FecFactura").val("");
        $("#subtotalI").text("0");
        $("#impuestoI").text("0");
        $("#descuentoI").text("0");
        $("#impuesto1I").text("0");
        $("#impuesto2I").text("0");
        $("#impuesto4I").text("0");
        $("#impuesto8I").text("0");
        $("#impuesto13I").text("0");
        $("#totalI").text("0");
        ImagenBase64 = "";
        Productos = [];

        subtotalT = 0;
        descuentoT = 0;
         impuestoT = 0;
        totalT = 0;

         impuesto1T = 0;
         impuesto2T = 0;
         impuesto4T = 0;
         impuesto8T = 0;
        impuesto13T = 0;

         subtotalI = 0;
         impuestosI = 0;
         descuentosI = 0;
         totalComprobanteI = 0;

         impuestoI1 = 0;
         impuestoI2 = 0;
         impuestoI4 = 0;
         impuestoI8 = 0;
        impuestoI13 = 0;
        document.getElementById('imgPrincipalG').src = "/img/cm.jpg";
        ImageBae64 = "";
        LimpiarDatosI();
        RellenaTablaI();
    }
    function ValidarFactura() {
        if (ProdCadena.find(a => a.CHacienda.trim() == $("#NumFactura").val() && a.CodProveedor == $("#CodProveedor").val()) != undefined) {
            return false;
        }

        if ($("#NumFactura").val() == "") {
            return false;
        } else if ($("#CodProveedor").val() == "") {
            return false;
        } else if ($("#NomProveedor").val() == "") {
            return false;
        } else if ($("#FecFactura").val() == "") {
            return false;
        } else if (Productos.length == 0) {
            return false;
        } else if (ImageBae64 == "") {
            return false;
        } else if ($("#idTipoGasto").val() == "NULL") {
            return false;
        }
        else {
            return true;
        }
    }

    async function EnviarFC() {
        AgregarProductosI();
        GenerarI();

    }
</script>

<!--Script para editar una factura manual-->
<script>
    var ImageBae64E = '';
    var ProductosE = [];
    var subtotalE = 0;
    var impuestosE = 0;
    var descuentosE = 0;
    var totalComprobanteE = 0;

    var impuestoE1 = 0;
    var impuestoE2 = 0;
    var impuestoE4 = 0;
    var impuestoE8 = 0;
    var impuestoE13 = 0;
    var resultadoAnterior = [];

    function onChangeFecFacturaE() {
        if (new Date($("#FechaFinal").val()).addDays(1) < new Date($("#FecFacturaE").val()).addDays(1) || new Date($("#FechaI").val()).addDays(1) > new Date($("#FecFacturaE").val()).addDays(1)) {
            $("#FecFacturaE").val($("#FechaI").val());

            alert("La fecha de la factura manual no puede ser menor o mayor que la del periodo");
        }
    }

    async function readFilePrincipalE(input) {
        if (input.files && input.files[0]) {
            /*const maxAllowSize = 512000;*/
            //const maxAllowSize = 2800000;
            const maxAllowSize = 5000000;
            if (input.files[0].size > maxAllowSize) {
                alert("Esta imagen es muy pesada");
                input.value = '';
            } else {
                var reader = new FileReader();
                var img = document.createElement("img");
                var canvas = document.createElement('canvas');

                reader.onload = function (e) {
                    img.src = e.target.result;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);

                    var MAX_WIDTH = 800;
                    var MAX_HEIGHT = 600;
                    var width = img.width;
                    var height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    var dataurl = canvas.toDataURL("image/jpg");
                    document.getElementById('imgPrincipalGE').src = e.target.result;

                   // console.log(dataurl);
                    ImageBae64E = dataurl;//e.target.result;

                    //var idF = setInterval(cancelar, 3000);

                    //function cancelar() {
                    //    console.log("cancelar -> " +ImageBae64);
                    //    if (ImageBae64 != "data:,") {
                    //        clearInterval(idF);
                    //    }
                    //}
                }

            }

            reader.readAsDataURL(input.files[0]);
        }



    }

    var fileUploadPrincipalE = document.getElementById('imgPrincipalUploadGE');
    fileUploadPrincipalE.onchange = async function (e) {
        await readFilePrincipalE(e.srcElement);
        var idF = setInterval(async function () {

            if (ImageBae64E != "data:,") {
                //alert("Imagen agregada con éxito");
                clearInterval(idF);
            } else {
                await readFilePrincipalE(e.srcElement);
            }
        }, 1500);

    }

    function checkE(i) {

        var checkbox1 = document.getElementById("simpE");
        var checkbox2 = document.getElementById("extE");
        var checkbox3 = document.getElementById("varE");
        var checkbox4 = document.getElementById("nrecE");
        if (i == "1") {

            checkbox2.checked = false;
            checkbox3.checked = false;
            checkbox1.checked = true;
            $("#CHacienda").removeAttr("readonly");
            $("#ConsHacienda").removeAttr("readonly");

        }
        else if (i == "2") {
            checkbox3.checked = false;
            checkbox2.checked = true;
            checkbox1.checked = false;
            $("#CHacienda").attr("readonly", "readonly");
            $("#ConsHacienda").attr("readonly", "readonly");

            $("#CHacienda").val("");
            $("#ConsHacienda").val("");
        } else if (i == "3") {
            checkbox3.checked = true;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = false;
        } else {
            checkbox3.checked = false;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = true;
        }
    }
    function AbrirModalE() {
        $("#ModalEdicion").modal("show");
    }
    function AgregarProductosE() {
        var combo = document.getElementById("idTipoGastoE");
        var selected = combo.options[combo.selectedIndex].text;

        var detalle = {

            CodPro: "1",
            NomPro: ($("#NomProE").val() == "" ? "Detalle factura" : (selected.includes("COMB") ? $("#NomProE").val() + " * " + $("#idTipoCombE").val() : $("#NomProE").val())) ,
            idTipoGasto: $("#idTipoGastoE").val() == "NULL" ? "0" : $("#idTipoGastoE").val(),
            Cantidad: (selected.includes("COMB") && Pais == "P" ? $("#CantLitrosE").val() : "1"),
            PrecioUnitario: $("#PrecUniE").val(),
            MontoDescuento: $("#descE").val(),
            ImpuestoTarifa: $("#TipoImpuestoE").val(),
            ImpuestoMonto: $("#ImpuestoMontoE").val(),
            MontoTotalLinea: 0,
            Impuesto1: 0,
            Impuesto2: 0,
            Impuesto4: 0,
            Impuesto8: 0,
            Impuesto13: 0
        };

        switch ($("#TipoImpuestoE").val()) {
            case "1":
                {
                    detalle.Impuesto1 += detalle.ImpuestoMonto;
                    break;
                }
            case "2":
                {
                    detalle.Impuesto2 += detalle.ImpuestoMonto;
                    break;
                }
            case "4":
                {
                    detalle.Impuesto4 += detalle.ImpuestoMonto;
                    break;
                }
            case "8":
                {
                    detalle.Impuesto8 += detalle.ImpuestoMonto;
                    break;
                }
            case "13":
                {
                    if (Pais == "C") {
                        detalle.Impuesto13 += detalle.ImpuestoMonto;

                    } else if(Pais == "N") {
                        detalle.ImpuestoMonto = 0;
                        detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.13;
                        detalle.Impuesto1 += detalle.ImpuestoMonto;
                    }
                    break;
                }
            case "7":
                {
                    detalle.ImpuestoMonto = 0;
                    detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.07;
                    detalle.Impuesto1 += detalle.ImpuestoMonto;
                    break;
                }
            case "10":
                {
                    detalle.ImpuestoMonto = 0;
                    detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.10;
                    detalle.Impuesto2 += detalle.ImpuestoMonto;
                    break;
                }
            case "15":
                {
                    detalle.ImpuestoMonto = 0;
                    detalle.ImpuestoMonto += parseFloat(detalle.PrecioUnitario) * 0.15;
                    detalle.Impuesto2 += detalle.ImpuestoMonto;
                    break;
                }

        }

        if (Pais == "C") {
            detalle.MontoTotalLinea = ((detalle.PrecioUnitario) - detalle.MontoDescuento) + parseFloat(detalle.ImpuestoMonto);

        } else {
            detalle.MontoTotalLinea = (detalle.PrecioUnitario);
        }

        var subtotalT = 0;
        var descuentoT = 0;
        var impuestoT = 0;
        var totalT = 0;

        if (Pais == "P" || Pais == "N") {
            subtotalT = parseFloat(detalle.PrecioUnitario) - detalle.ImpuestoMonto;
        } else {
            subtotalT = parseFloat(detalle.PrecioUnitario);
        }

        descuentoT = parseFloat(detalle.MontoDescuento);
        impuestoT = parseFloat(detalle.ImpuestoMonto);
        totalT = parseFloat(detalle.MontoTotalLinea);

        subtotalE += subtotalT;
        descuentosE += descuentoT;
        impuestosE += impuestoT;

        totalComprobanteE += totalT;

        var impuesto1T = parseFloat(detalle.Impuesto1);
        var impuesto2T = parseFloat(detalle.Impuesto2);
        var impuesto4T = parseFloat(detalle.Impuesto4);
        var impuesto8T = parseFloat(detalle.Impuesto8);
        var impuesto13T = parseFloat(detalle.Impuesto13);


        impuestoE1 += impuesto1T;
        impuestoE2 += impuesto2T;
        impuestoE4 += impuesto4T;
        impuestoE8 += impuesto8T;
        impuestoE13 += impuesto13T;


        $("#subtotalE").text(formatoDecimal(subtotalE.toFixed(2)));
        $("#descuentoE").text(formatoDecimal(descuentosE.toFixed(2)));
        $("#impuestoE").text(formatoDecimal(impuestosE.toFixed(2)));
        $("#totalE").text(formatoDecimal(totalComprobanteE.toFixed(2)));


        $("#impuesto1E").text(formatoDecimal(parseFloat(impuestoE1).toFixed(2)));
        $("#impuesto2E").text(formatoDecimal(parseFloat(impuestoE2).toFixed(2)));
        $("#impuesto4E").text(formatoDecimal(parseFloat(impuestoE4).toFixed(2)));
        $("#impuesto8E").text(formatoDecimal(parseFloat(impuestoE8).toFixed(2)));
        $("#impuesto13E").text(formatoDecimal(parseFloat(impuestoE13).toFixed(2)));


        ProductosE.push(detalle);
        //LimpiarDatosI();
       // RellenaTablaI();
    }
    function LimpiarDatosE() {

        $("#NomProE").val("");

        $("#PrecUniE").val(0);
        $("#descE").val(0);
        $("#TipoImpuestoE").val("0").trigger('change');
        $("#idTipoGastoE").val("NULL").trigger('change');
        $("#ImpuestoMontoE").val(0);
        $("#idTipoCombE").val("").trigger('change');
        $("#CantLitrosE").val(1);
    }

    function RellenaTablaE() {
        var texto = '';

        $("#tbodyE").html('');

        for (var i = 0; i < ProductosE.length; i++) {
            texto += '<tr>';

            texto += '<td align="left" style="padding-top:15px;">  <p style="font-size:13px;">' + ProductosE[i].NomPro + '</p></td>';

            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(ProductosE[i].PrecioUnitario) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(ProductosE[i].MontoDescuento) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(ProductosE[i].ImpuestoMonto) + '</p></td>';
            texto += '<td align="right" style="padding-top:13px;">  <p style="font-size:13px;">' + formatoDecimal(ProductosE[i].MontoTotalLinea) + '</p></td>';
            texto += '<td align="center" style="padding-top:13px;">    <a style="margin-left: -1%; position: inherit !important;" onclick = "javascript: EliminaProductoE(' + i + ')" title="Eliminar" class="fa fa-trash icono"></a> ';
            texto += '</tr>'
        }
        $("#tbodyE").html(texto);
    }

    function EliminaProductoE(campo) {


                var subtotalT = 0;
                var descuentoT = 0;
                var impuestoT = 0;
        var totalT = 0;
        subtotalT = parseFloat(ProductosE[campo].PrecioUnitario);
        descuentoT = parseFloat(ProductosE[campo].MontoDescuento);
        impuestoT = parseFloat(ProductosE[campo].ImpuestoMonto);

        totalT = parseFloat(ProductosE[campo].MontoTotalLinea);

                subtotalE -= subtotalT;
                descuentosE -= descuentoT;
                impuestosE -= impuestoT;

                totalComprobanteE -= totalT;

        var impuesto1T = parseFloat(ProductosE[campo].Impuesto1);
        var impuesto2T = parseFloat(ProductosE[campo].Impuesto2);
        var impuesto4T = parseFloat(ProductosE[campo].Impuesto4);
        var impuesto8T = parseFloat(ProductosE[campo].Impuesto8);
        var impuesto13T = parseFloat(ProductosE[campo].Impuesto13);


                impuestoE1 -= impuesto1T;
                impuestoE2 -= impuesto2T;
                impuestoE4 -= impuesto4T;
                impuestoE8 -= impuesto8T;
                impuestoE13 -= impuesto13T;


                $("#subtotalE").text(formatoDecimal(subtotalE.toFixed(2)));
                $("#descuentoE").text(formatoDecimal(descuentosE.toFixed(2)));
                $("#impuestoE").text(formatoDecimal(impuestosE.toFixed(2)));
                $("#totalE").text(formatoDecimal(totalComprobanteE.toFixed(2)));


                $("#impuesto1E").text(formatoDecimal(parseFloat(impuestoE1).toFixed(2)));
                $("#impuesto2E").text(formatoDecimal(parseFloat(impuestoE2).toFixed(2)));
                $("#impuesto4E").text(formatoDecimal(parseFloat(impuestoE4).toFixed(2)));
                $("#impuesto8E").text(formatoDecimal(parseFloat(impuestoE8).toFixed(2)));
                $("#impuesto13E").text(formatoDecimal(parseFloat(impuestoE13).toFixed(2)));

        ProductosE.splice(campo, 1);
                RellenaTablaE();


    }

    function onChangeTipoGastoE() {
        var combo = document.getElementById("idTipoGastoE");
        var selected = combo.options[combo.selectedIndex].text;

        if (selected.includes("COMB") && (Pais == "P" || Pais == "N")) {
            $("#CombustibleE").attr("hidden", false);
        } else {
            $("#CombustibleE").attr("hidden", true);
        }
    }

    function AbrirModalEdicion(id) {
        $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '@Url.Page("Editar", "BuscarFM")',
            data: { idB: id },
            success: function (result) {

                console.log("Resultado de la busqueda en la edicion: " + result.encCompras);

                if (result != null) {
                    resultadoAnterior = result;
                    $("#idFacE").val(id);
                    document.getElementById('imgPrincipalGE').src = result.imagenB64 == null ? result.pdfFactura : "data:image/png;base64," + result.imagenB64;

                    if (Pais == "P" || Pais == "N") {
                        $("#DVE").val(result.codProveedor.split("[")[1]);
                        result.codProveedor = result.codProveedor.split("[")[0];


                    }

                    switch (result.codProveedor.replace("-", "").replace("-", "").length) {
                        case 7:
                        case 8:
                        case 9:
                            {
                                $("#idProvedor1").prop('checked', true)
                                maskE2();
                                break;
                            }
                        case 10:

                            {
                                if (Pais == "P") {
                                    $("#idProvedor3").prop('checked', true)
                                } else {
                                    $("#idProvedor2").prop('checked', true)
                                }

                                maskE2();
                                break;
                            }
                        case 12:
                            {
                                $("#idProvedor3").prop('checked', true)
                                maskE2();
                                break;
                            }
                        case 13:
                        case 14:
                        case 15:
                            {
                                if (Pais != "N") {
                                    $("#idProvedor2").prop('checked', true)

                                } else {
                                    if (result.codProveedor.replace("-", "").replace("-", "").includes("J") || result.codProveedor.replace("-", "").replace("-", "").includes("j") ) {
                                        $("#idProvedor2").prop('checked', true)

                                    } else {
                                        $("#idProvedor1").prop('checked', true)

                                    }
                                }
                                maskE2();
                                break;
                            }

                    }

                    $("#CodProveedorE").val(result.codProveedor.replace("-", "").replace("-", ""));
                    $("#NomProveedorE").val(result.nomProveedor);
                    $("#NumFacturaE").val(result.numFactura);
                    $("#FecFacturaE").val(result.fecFactura.toString().replace("T00:00:00", ""));
                    $("#NomProE").val(result.detCompras[0].nomPro);
                    $("#TipoImpuestoE").val(result.detCompras[0].impuestoTarifa);
                    $("#idTipoGastoE").val(result.detCompras[0].idTipoGasto);


                        $("#PrecUniE").val(result.detCompras[0].precioUnitario);



                    $("#descE").val(result.detCompras[0].montoDescuento);
                    $("#ImpuestoMontoE").val(result.detCompras[0].impuestoMonto);
                    if (result.regimenSimplificado) {
                        checkE('1');

                    } else if (result.facturaExterior) {
                        checkE('2');
                    } else {
                        checkE('3');
                    }


                    if (Pais == "P" || Pais == "N") {
                        var combo = document.getElementById("idTipoGastoE");
                        var selected = combo.options[combo.selectedIndex].text;

                        if (selected.includes("COMB")) {
                            $("#CombustibleE").attr("hidden", false);
                            $("#CantLitrosE").val(result.detCompras[0].cantidad);
                            $("#NomProE").val(result.detCompras[0].nomPro.split("*")[0].trim());
                            $("#idTipoCombE").val(result.detCompras[0].nomPro.split("*")[1].trim());
                        } else {
                            $("#CombustibleE").attr("hidden", true);
                        }
                    }


                    AbrirModalE();


                }

            },
            beforeSend: function () {

            },
            complete: function () {

            }
        });
    }

    function maskE() {
        if (Pais == "P") {
            switch ($("#idClienteE").val()) {
                case "01":
                    {
                        $("#CodClienteE").inputmask({ "mask": "99-999-9999" });
                        break;
                    }
                case "02":
                    {
                        $("#CodClienteE").inputmask({ "mask": "9999999-99-999999" });
                        break;
                    }
                case "03":
                    {
                        $("#CodClienteE").inputmask({ "mask": "9999999999" });
                        break;
                    }
                case "04":
                    {
                        $("#CodClienteE").inputmask({ "mask": "9999999999" });
                        break;
                    }
                default:
                    {
                        break;
                    }
            }
        } else if(Pais == "C") {

            switch ($("#idClienteE").val()) {
                case "01":
                    {
                        $("#CodClienteE").inputmask({ "mask": "9-9999-9999" });
                        break;
                    }
                case "02":
                    {
                        $("#CodClienteE").inputmask({ "mask": "9-999-999999" });
                        break;
                    }
                case "03":
                    {
                        $("#CodClienteE").inputmask({ "mask": "999999999999" });
                        break;
                    }
                case "04":
                    {
                        $("#CodClienteE").inputmask({ "mask": "9999999999" });
                        break;
                    }
                default:
                    {
                        break;
                    }
            }
        } else if (Pais == "N") {
            switch ($("#idClienteE").val()) {
                case "01":
                    {
                        $("#CodClienteE").inputmask({ "mask": "999-999999-99999" });
                        break;
                    }
                case "02":
                    {
                        $("#CodClienteE").inputmask({ "mask": "99999999999999-9" });
                        break;
                    }
                case "03":
                    {
                        $("#CodClienteE").inputmask({ "mask": "999999999999999" });
                        break;
                    }
                case "04":
                    {
                        $("#CodClienteE").inputmask({ "mask": "999999999999999" });
                        break;
                    }
                default:
                    {
                        break;
                    }
            }
        }


    }
    function maskE2() {

        if (Pais == "P" || Pais == "N") {
           
        } else if(Pais == "C") {
            switch ($("input:radio[name=idProvedor]:checked").val()) {
                case "01":
                    {
                        $("#CodProveedorE").inputmask({ "mask": "9-9999-9999" });
                        break;
                    }
                case "02":
                    {
                        $("#CodProveedorE").inputmask({ "mask": "9-999-999999" });
                        break;
                    }
                case "03":
                    {
                        $("#CodProveedorE").inputmask({ "mask": "999999999999" });
                        break;
                    }
                case "04":
                    {
                        $("#CodProveedorE").inputmask({ "mask": "9999999999" });
                        break;
                    }
                default:
                    {
                        break;
                    }
            }
        }


    }

              function GenerarE()
              {
                  var button = document.getElementById('buttonSpinE');
                  if (typeof (button.getAttribute('data-loading')) === 'string') {
                      button.removeAttribute('data-loading');
                  }
                  else {
                      button.setAttribute('data-loading', '');
                  }

                 var checkbox1 = document.getElementById("simpE");
                  var checkbox2 = document.getElementById("extE");
                  var checkbox3 = document.getElementById("varE");
                  var checkbox4 = document.getElementById("nrecE");
                 var EncCompras =
                 {
                        id: $("#idFacE").val(),
                        ClaveHacienda: $("#NumFacturaE").val(),
                        ConsecutivoHacienda: $("#NumFacturaE").val(),
                        TipoIdentificacionCliente: "0",
                        NumFactura: $("#NumFacturaE").val(),
                        CodProveedor: (Pais == "P" || Pais == "N" ? $("#CodProveedorE").val() + "[" + $("#DVE").val() : $("#CodProveedorE").val()),
                        NomProveedor: $("#NomProveedorE").val(),
                        FecFactura: $("#FecFacturaE").val(),
                        CodigoActividadEconomica: "0" ,
                        CodMoneda: $("#CodMoneda").val(),
                        CodCliente: "0",
                        NomCliente: "0",
                        TotalVenta: $("#subtotalE").text(),
                        TotalImpuesto: $("#impuestoE").text(),
                        TotalDescuentos: $("#descuentoE").text(),
                        Impuesto1: $("#impuesto1E").text() ,
                        Impuesto2: $("#impuesto2E").text()  ,
                        Impuesto4: $("#impuesto4E").text(),
                        Impuesto8: $("#impuesto8E").text(),
                        Impuesto13: $("#impuesto13E").text(),
                        TotalComprobante: $("#totalE").text(),
                        ImagenBase64: (ImageBae64E === '' ? '' : ImageBae64E.toString().replace('data:image/jpeg;base64,', '').replace('data:image/png;base64,', '')),
                        RegimenSimplificado: checkbox1.checked,
                     FacturaExterior: checkbox2.checked,
                     GastosVarios: checkbox3.checked,
                     FacturaNoRecibida: (Pais == "P" || Pais == "N" ? checkbox4.checked : false)//checkbox4.checked
                    };

                    var DetCompras = ProductosE;
                    var recibido = {
                            EncCompras,
                            DetCompras
                        };

                        var recibidos = JSON.stringify(recibido);
                  if (ValidarFacturaE()) {
                      $("#FaltaDatosE").css("display", "none");
                      $.ajax({
                          type: 'POST',

                          url: '@Url.Page("Editar", "EditarCompra")',
                          datatype: "application/json",
                          data: { recibidos: recibidos.toString() },
                          headers: {
                              RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                          },
                          success: function (json) {

                              console.log(json);
                              if (json.success == true) {
                                  button.removeAttribute('data-loading');
                                  $("#ErrorFacturaE").css("display", "none");
                                  //Aqui se meteria en el detalle
                                  var detalle = {
                                      id: json.resp,
                                      Proveedor: EncCompras.NomProveedor,
                                      CHacienda: EncCompras.NumFactura,
                                      //    idTipoGasto: $("#idTipoGasto").val(),
                                      Fecha: EncCompras.FecFactura,
                                      SubTotal: parseFloat(EncCompras.TotalVenta.replace(",", "").replace(",", "")),
                                      Descuento: parseFloat(EncCompras.TotalDescuentos.replace(",", "").replace(",", "")),
                                      Impuesto: parseFloat(EncCompras.TotalImpuesto.replace(",", "").replace(",", "")),
                                      Total: 0,
                                      Impuesto1: parseFloat(EncCompras.Impuesto1.replace(",", "").replace(",", "")),
                                      Impuesto2: parseFloat(EncCompras.Impuesto2.replace(",", "").replace(",", "")),
                                      Impuesto4: parseFloat(EncCompras.Impuesto4.replace(",", "").replace(",", "")),
                                      Impuesto8: parseFloat(EncCompras.Impuesto8.replace(",", "").replace(",", "")),
                                      Impuesto13: parseFloat(EncCompras.Impuesto13.replace(",", "").replace(",", "")),
                                      idTipoGasto: ProductosE[0].idTipoGasto,
                                      TotalOtrosCargos: 0,
                                      Comentario: ""
                                  };

                                  console.log(EncCompras);
                                  console.log(detalle);
                                  var subtotalT = 0;
                                  var descuentoT = 0;
                                  var impuestoT = 0;
                                  var totalT = 0;
                                  subtotalT = parseFloat(detalle.SubTotal);
                                  descuentoT = parseFloat(detalle.Descuento);
                                  impuestoT = parseFloat(detalle.Impuesto);
                                  detalle.Total = (subtotalT - descuentoT) + impuestoT

                                  totalT = parseFloat(detalle.Total);
                                  var impuesto1T = parseFloat(detalle.Impuesto1);
                                  var impuesto2T = parseFloat(detalle.Impuesto2);
                                  var impuesto4T = parseFloat(detalle.Impuesto4);
                                  var impuesto8T = parseFloat(detalle.Impuesto8);
                                  var impuesto13T = parseFloat(detalle.Impuesto13);

                                  //Se le resta los totales anteriores al general para despues sumarle los demas
                                  if (Pais == "P" || Pais == "N") {
                                      subtotal -= parseFloat(resultadoAnterior.totalComprobante) - parseFloat(resultadoAnterior.totalImpuesto);
                                  } else {
                                      subtotal -= parseFloat(resultadoAnterior.totalVenta);
                                  }

                                  descuentos -= parseFloat(resultadoAnterior.totalDescuentos);
                                  impuestos -= parseFloat(resultadoAnterior.totalImpuesto);
                                  if (Pais == "P" || Pais == "N") {
                                      totalComprobante -= parseFloat(resultadoAnterior.totalComprobante);
                                  } else {
                                      totalComprobante -= (parseFloat(resultadoAnterior.totalVenta) - parseFloat(resultadoAnterior.totalDescuentos)) - parseFloat(resultadoAnterior.totalImpuesto);
                                  }

                                  impuesto1 -= parseFloat(resultadoAnterior.impuesto1);
                                  impuesto2 -= parseFloat(resultadoAnterior.impuesto2);
                                  impuesto4 -= parseFloat(resultadoAnterior.impuesto4);
                                  impuesto8 -= parseFloat(resultadoAnterior.impuesto8);
                                  impuesto13 -= parseFloat(resultadoAnterior.impuesto13);

                                  ///------------------------------------------------------///////////////



                                  subtotal += subtotalT;
                                  descuentos += descuentoT;
                                  impuestos += impuestoT;

                                  totalComprobante += totalT;
                                  impuesto1 += impuesto1T;
                                  impuesto2 += impuesto2T;
                                  impuesto4 += impuesto4T;
                                  impuesto8 += impuesto8T;
                                  impuesto13 += impuesto13T;

                                  $("#subtotal").text(formatoDecimal(parseFloat(subtotal).toFixed(2)));
                                  $("#descuento").text(formatoDecimal(parseFloat(descuentos).toFixed(2)));
                                  $("#impuesto").text(formatoDecimal(parseFloat(impuestos).toFixed(2)));
                                  $("#total").text(formatoDecimal(parseFloat(totalComprobante).toFixed(2)));

                                  $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
                                  $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));
                                  $("#impuesto4").text(formatoDecimal(parseFloat(impuesto4).toFixed(2)));
                                  $("#impuesto8").text(formatoDecimal(parseFloat(impuesto8).toFixed(2)));
                                  $("#impuesto13").text(formatoDecimal(parseFloat(impuesto13).toFixed(2)));

                                  var objetoNuevo = ProdCadena.find(a => a.id == parseInt(EncCompras.id));
                                  var index = ProdCadena.indexOf(ProdCadena.find(a => a.id == parseInt(EncCompras.id)));
                                  objetoNuevo.Impuesto = impuestoT;
                                  objetoNuevo.SubTotal = subtotalT;
                                  objetoNuevo.Descuento = descuentoT;
                                  objetoNuevo.Impuesto1 = impuesto1T;
                                  objetoNuevo.Impuesto2 = impuesto2T;
                                  objetoNuevo.Impuesto4 = impuesto4T;
                                  objetoNuevo.Impuesto13 = impuesto13T;
                                  objetoNuevo.Total = totalT;
                                  objetoNuevo.CHacienda = detalle.CHacienda;
                                  objetoNuevo.Fecha = detalle.Fecha.toString().substring(8, 10) + "/" + detalle.Fecha.toString().substring(5, 7) + "/" + detalle.Fecha.toString().substring(0,4);
                                  objetoNuevo.Proveedor = detalle.Proveedor;
                                  objetoNuevo.idTipoGasto = detalle.idTipoGasto;
                                  ProdCadena[index] = objetoNuevo;






                                  LimpiarDatosE();

                                  RellenaTablaE();
                                  LimpiarDatosGeneralesE();



                                  RellenaTabla();
                                  $("#ModalEdicion").modal("hide");

                              } else {
                                  $("#ErrorFacturaE").text(json.resp);
                                  $("#ErrorFacturaE").css("display", "block");
                                  button.removeAttribute('data-loading');
                                  EliminaProductoE(0);
                              }



                          },

                          beforeSend: function (xhr) {


                          },
                          complete: function () {

                          },
                          error: function (error) {
                              button.removeAttribute('data-loading');
                              $("#ErrorFacturaE").css("display", "block");


                          }
                      });
                  } else {
                      $("#FaltaDatosE").css("display", "block");
                      button.removeAttribute('data-loading');
                      ProductosE = [];
                  }
    }

    function LimpiarDatosGeneralesE() {
        $("#NumFacturaE").val("");
        $("#CodProveedorE").val("");
        $("#DVE").val("");
        $("#NomProveedorE").val("");
        $("#FecFacturaE").val("");
        $("#subtotalE").text("0");
        $("#impuestoE").text("0");
        $("#descuentoE").text("0");
        $("#impuesto1E").text("0");
        $("#impuesto2E").text("0");
        $("#impuesto4E").text("0");
        $("#impuesto8E").text("0");
        $("#impuesto13E").text("0");
        $("#totalE").text("0");
        ImagenBase64E = "";
        ProductosE = [];

        subtotalT = 0;
        descuentoT = 0;
         impuestoT = 0;
        totalT = 0;

         impuesto1T = 0;
         impuesto2T = 0;
         impuesto4T = 0;
         impuesto8T = 0;
        impuesto13T = 0;

         subtotalE = 0;
         impuestosE = 0;
         descuentosE = 0;
         totalComprobanteE = 0;

         impuestoE1 = 0;
         impuestoE2 = 0;
         impuestoE4 = 0;
         impuestoE8 = 0;
        impuestoE13 = 0;
        document.getElementById('imgPrincipalGE').src = "/img/cm.jpg";
        ImageBae64E = "";
        LimpiarDatosE();
        RellenaTablaE();
    }
    function ValidarFacturaE() {




        if ($("#NumFacturaE").val() == "") {
            return false;
        } else if ($("#CodProveedorE").val() == "") {
            return false;
        } else if ($("#NomProveedorE").val() == "") {
            return false;
        } else if ($("#FecFacturaE").val() == "") {
            return false;
        } else if (ProductosE.length == 0) {
            return false;
        } else if (ImageBae64E == "" && document.getElementById('imgPrincipalGE').src == "") {
            return false;
        } else if ($("#idTipoGastoE").val() == "NULL") {
            return false;
        }
        else {
            return true;
        }
    }

    async function EnviarFCE() {
        AgregarProductosE();
        GenerarE();

    }
</script>
