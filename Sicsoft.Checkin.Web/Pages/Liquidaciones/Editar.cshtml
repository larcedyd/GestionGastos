@page "{id}"
@model InversionGloblalWeb.Pages.Liquidaciones.EditarModel
@{
    ViewData["Title"] = "Liquidaciones";
}
@section Title{
    <h2><i></i> @ViewData["Title"]</h2>
}
@section breadcrumb{
    <li class="breadcrumb-item">
        <a asp-page="./Index">Liquidaciones</a>
    </li>

    <li class="breadcrumb-item active">
        <strong>Editar </strong>
    </li>
}
@section TitleAction{
    <a asp-page="./Index" class="nav-link text-dark"><i class="fa fa-arrow-circle-o-left "></i>  Regresar</a>
}
@section styles{
    <link rel="stylesheet" href="~/lib/summernote/summernote-bs4.css" />
    <link rel="stylesheet" href="~/lib/select2/css/select2.min.css" />
    <link rel="stylesheet" href="~/lib/select2/css/select2-bootstrap4.min.css" />
    <link href="~/lib/dropzone/basic.css" rel="stylesheet" />
    <link href="~/lib/dropzone/dropzone.css" rel="stylesheet" />
    <link href="~/lib/iCheck/skins/square/green.css" rel="stylesheet" />
    <link href="~/lib/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jasny-bootstrap/4.0.0/css/jasny-bootstrap.min.css">
    <style>
        /*     .tableFixHead th {
            position: sticky;
            top: 0;
            background: white;
        }*/
        td {
            border-bottom-style: solid !important;
            border-bottom-width: 1px !important;
            border-bottom-color: #dec2e6 !important;
        }

        h3 {
            font-size: 13px !important;
        }

        th {
            background-color: transparent !important;
        }

        td p {
            font-weight: 300 !important;
        }

        .lab {
            font-weight: 400;
            font-size: 13px;
        }

        .lab2 {
            font-weight: 400;
            font-size: 13px;
        }

        .label {
            color: #fff !important;
            background-color: #57b846 !important;
            cursor: pointer;
            text-decoration: underline;
            background: none;
            font-size: 17px;
            padding: 8px 18px !important;
        }
        .label-submit {
            color: #fff !important;
            background-color: #57b846 !important;
            cursor: pointer;
            background: none;
            font-size: 13px;
            padding: 8px 18px !important;
        }
        /*label
    {
        font-size: 15px;
    }*/

        #imgGalerias {
            display: none;
        }

    </style>
}
@section scripts{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/lib/summernote/summernote-bs4.min.js"></script>
    <script src="~/lib/select2/js/select2.min.js"></script>
    <script src="~/lib/dropzone/dropzone.js"></script>
    <script src="~/lib/iCheck/icheck.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[type=number]').forEach(node => node.addEventListener('keypress', e => {
                if (e.keyCode == 13) {
                    onChangeProducto();
                }
            }))
        });
    </script>
    <script>

        $(document).ready(function () {

        jQuery(document).ready(function ($) {
            $(document).ready(function () {


            });
        });


            $(":input").inputmask();
            $('.mi-selector').select2();

            $("#NomPro").val("");

            $("#PrecUniI").val(0);
            $("#descI").val(0);
            $("#TipoImpuesto").val("0").trigger('change');
            $("#idTipoGasto").val("NULL").trigger('change');
            $("#ImpuestoMonto").val(0);

            $("input:radio[name=idProveedor]:checked").val("01");
            $(".js-example-responsive").select2({
                width: 'resolve',// need to override the changed default
                height: 'resolve'
            });

            Recuperar();








        });
        var ProdCadena = [];
        var bandera = false;
        var idP = 0;
        var subtotal = 0;
        var impuestos = 0;
        var descuentos = 0;
        var totalComprobante = 0;

        var impuesto1 = 0;
        var impuesto2 = 0;
        var impuesto4 = 0;
        var impuesto8 = 0;
        var impuesto13 = 0;
        var oCargos = 0;


        function Recuperar() {
            try {
                var det = JSON.parse($("#Liquidacion").val());
               
                  
            $("#idCierre").val(det[0].idCierre);
            console.log(det[0]);

            var Estado = "@Model.Liquidacion.EncCierre.Estado";
            $("#CodMoneda").val("@Model.Liquidacion.EncCierre.CodMoneda");
            console.log("Estado " + Estado);
            //if (Estado != "P") {
            //    document.getElementById('btnEnviarRevision').disabled = true;
            //}

            //if (Estado != "P" && Estado != "R") {
            //    document.getElementById('GuardarCambios').disabled = true;
            //}


            for (var i = 0; i < det.length; i++)
            {


                var detalle = {
                    id: det[i].id,
                    Proveedor: (det[i].NomProveedor.length > 40 ? det[i].NomProveedor.substr(0, 40) : det[i].NomProveedor),
                    CHacienda: det[i].ConsecutivoHacienda,
                //    idTipoGasto: $("#idTipoGasto").val(),
                    Fecha: det[i].FecFactura.substr(8, 2) + "/" + det[i].FecFactura.substr(5, 2) + "/" + det[i].FecFactura.substr(0, 4),
                    SubTotal: det[i].TotalVenta,
                    Descuento: det[i].TotalDescuentos,
                    Impuesto: det[i].TotalImpuesto,
                    Total: 0,
                    TotalOtrosCargos : det[i].TotalOtrosCargos,
                    Impuesto1: det[i].Impuesto1,
                    Impuesto2: det[i].Impuesto2,
                    Impuesto4: det[i].Impuesto4,
                    Impuesto8: det[i].Impuesto8,
                    Impuesto13: det[i].Impuesto13,
                    idTipoGasto: det[i].idTipoGasto,
                    Comentario: det[i].Comentario
            };


            var subtotalT = 0;
            var descuentoT = 0;
            var impuestoT = 0;
                var totalT = 0;
                var oCargosT = 0;
            subtotalT = parseFloat(detalle.SubTotal);
            descuentoT = parseFloat(detalle.Descuento);
            impuestoT = parseFloat(detalle.Impuesto);
                oCargosT = parseFloat(detalle.TotalOtrosCargos);
                detalle.Total = (subtotalT - descuentoT) + impuestoT + oCargosT;
            ProdCadena.push(detalle);
            totalT = parseFloat(detalle.Total);
            var impuesto1T = parseFloat(detalle.Impuesto1);
            var impuesto2T = parseFloat(detalle.Impuesto2);
            var impuesto4T = parseFloat(detalle.Impuesto4);
            var impuesto8T = parseFloat(detalle.Impuesto8);
            var impuesto13T = parseFloat(detalle.Impuesto13);



            subtotal += subtotalT;
            descuentos += descuentoT;
            impuestos += impuestoT;
                oCargos += oCargosT;
            totalComprobante += totalT;
            impuesto1 += impuesto1T;
            impuesto2 += impuesto2T;
            impuesto4 += impuesto4T;
            impuesto8 += impuesto8T;
            impuesto13 += impuesto13T;

            $("#subtotal").text(formatoDecimal(parseFloat(subtotal).toFixed(2)));
            $("#descuento").text(formatoDecimal(parseFloat(descuentos).toFixed(2)));
            $("#impuesto").text(formatoDecimal(parseFloat(impuestos).toFixed(2)));
            $("#total").text(formatoDecimal(parseFloat(totalComprobante).toFixed(2)));
                $("#tOCargos").text(formatoDecimal(parseFloat(oCargos).toFixed(2)));
            $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
            $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));
            $("#impuesto4").text(formatoDecimal(parseFloat(impuesto4).toFixed(2)));
            $("#impuesto8").text(formatoDecimal(parseFloat(impuesto8).toFixed(2)));
                $("#impuesto13").text(formatoDecimal(parseFloat(impuesto13).toFixed(2)));
            }

            if (ProdCadena.length > 0) {
                $("#CodMoneda").select2({ disabled: true });
            } else {
                $("#CodMoneda").select2({ disabled: false });
            }
            LimpiarDatos();

                RellenaTabla();

            } catch (error) {
                alert(error);
            }


        }

    function onChangeProducto() {

        console.log("Busqueda" + $("#Busqueda").val());
        $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '@Url.Page("Editar", "Buscar")',
            data: { idB: $("#Busqueda").val(), cierre: $("#idCierre").val() },
            success: function (result) {

                console.log("Resultado de la busqueda: " + result);
                $("#Existencia").text("");
                if (result != null) {

                    if (result.nomProveedor.length > 40) {
                        $("#Proveedor").text(result.nomProveedor.substr(0, 40));
                    } else {
                        $("#Proveedor").text(result.nomProveedor);
                    }
                    $("#id").val(result.id);
                    $("#CHacienda").text(result.consecutivoHacienda);
                    $("#FechaFac").text(result.fecFactura.substr(8, 2) + "/" + result.fecFactura.substr(5, 2) + "/" + result.fecFactura.substr(0, 4));


                    $("#SubTotal").text(formatoDecimal(parseFloat(result.totalVenta)));

                    $("#Impuesto").text(formatoDecimal(parseFloat(result.totalImpuesto)));
                    $("#Descuento").text(formatoDecimal(parseFloat(result.totalDescuentos)));
                    //  $("#idTipoGasto").val(result.idTipoGasto).trigger('change.select2');;

                    $("#sub").val(result.totalVenta);
                    $("#desc").val(result.totalDescuentos);
                    $("#imp").val(result.totalImpuesto);
                    $("#otrosCargos").val(result.totalOtrosCargos);

                    $("#imp1").val(result.impuesto1);
                    $("#imp2").val(result.impuesto2);
                    $("#imp4").val(result.impuesto4);
                    $("#imp8").val(result.impuesto8);
                    $("#imp13").val(result.impuesto13);
                    $("#otrosCargos").val(result.totalOtrosCargos);
                    $("#idTipoGastoEditar").val(result.idTipoGasto).trigger('change.select2');
                    $("#tipoGasto").text(result.tipoGasto);
                    console.log(result.pdfFactura);

                    $("#adjunto").attr('href', result.pdfFactura);
                    var detalle = {
                        id: $("#id").val(),
                        Proveedor: $("#Proveedor").text(),
                        CHacienda: $("#CHacienda").text(),
                        //    idTipoGasto: $("#idTipoGasto").val(),
                        Fecha: $("#FechaFac").text(),
                        SubTotal: $("#sub").val(),
                        Descuento: $("#desc").val(),
                        Impuesto: $("#imp").val(),
                        Total: 0,
                        Impuesto1: $("#imp1").val(),
                        Impuesto2: $("#imp2").val(),
                        Impuesto4: $("#imp4").val(),
                        Impuesto8: $("#imp8").val(),
                        Impuesto13: $("#imp13").val(),
                        TotalOtrosCargos: $("#otrosCargos").val()
                    };
                    $("#monedaFactura").val(result.codMoneda);
                    console.log("Ya esta asignada: " + result.idCierre);
                    if (ProdCadena.find(a => a.id == parseInt(detalle.id)) != undefined) {
                        var str = "Ya esta asignada";
                        $("#Existencia").text(str);
                        LimpiarDatos();
                    } else if ((result.idCierre != 0 && result.idCierre != parseInt($("#idCierre").val()))) {
                        var str = "No existe, no es de este periodo o ya esta asignada. Puedes intentar colocando más dígitos del consecutivo de hacienda.";
                        $("#Existencia").text(str);
                        LimpiarDatos();
                    }

                } else {

                    var str = "No existe, no es de este periodo o ya esta asignada. Puedes intentar colocando más dígitos del consecutivo de hacienda.";
                    $("#Existencia").text(str);
                    LimpiarDatos();



                }

            },
            beforeSend: function () {

            },
            complete: function () {

            }
        });

        }

        function ValidarAntesTabla() {
            if ($("#Proveedor").text() == "") {
                return false;
            } else if ($("#idTipoGastoEditar").val() == "0" || $("#idTipoGastoEditar").val() == null) {
                return false;
            }

            else {
                return true;
            }
        }

        function validarMoneda() {
            if ($("#CodMoneda").val() != $("#monedaFactura").val()) {
                return false;
            }
            else {
                return true;
            }
        }
       function InsertarProductoTabla() {



           if (ValidarAntesTabla()) {
               if (validarMoneda()) {



                   var detalle = {
                       id: $("#id").val(),
                       Proveedor: $("#Proveedor").text(),
                       CHacienda: $("#CHacienda").text(),
                       //    idTipoGasto: $("#idTipoGasto").val(),
                       Fecha: $("#FechaFac").text(),
                       SubTotal: $("#sub").val(),
                       Descuento: $("#desc").val(),
                       Impuesto: $("#imp").val(),
                       Total: 0,
                       Impuesto1: $("#imp1").val(),
                       Impuesto2: $("#imp2").val(),
                       Impuesto4: $("#imp4").val(),
                       Impuesto8: $("#imp8").val(),
                       Impuesto13: $("#imp13").val(),
                       idTipoGasto: $("#idTipoGastoEditar").val(),
                       TotalOtrosCargos: $("#otrosCargos").val(),
                       Comentario: $("#ComenFac").val()
                   };


                   var subtotalT = 0;
                   var descuentoT = 0;
                   var impuestoT = 0;
                   var totalT = 0;
                   var oCargosT = 0;
                   subtotalT = parseFloat(detalle.SubTotal);
                   descuentoT = parseFloat(detalle.Descuento);
                   impuestoT = parseFloat(detalle.Impuesto);
                   oCargosT = parseFloat(detalle.TotalOtrosCargos);
                   detalle.Total = (subtotalT - descuentoT) + impuestoT + oCargosT;
                   ProdCadena.push(detalle);
                   totalT = parseFloat(detalle.Total);
                   var impuesto1T = parseFloat(detalle.Impuesto1);
                   var impuesto2T = parseFloat(detalle.Impuesto2);
                   var impuesto4T = parseFloat(detalle.Impuesto4);
                   var impuesto8T = parseFloat(detalle.Impuesto8);
                   var impuesto13T = parseFloat(detalle.Impuesto13);


                   subtotal += subtotalT;
                   descuentos += descuentoT;
                   impuestos += impuestoT;

                   totalComprobante += totalT;
                   impuesto1 += impuesto1T;
                   impuesto2 += impuesto2T;
                   impuesto4 += impuesto4T;
                   impuesto8 += impuesto8T;
                   impuesto13 += impuesto13T;
                   oCargos += oCargosT;
                   $("#subtotal").text(formatoDecimal(parseFloat(subtotal).toFixed(2)));
                   $("#descuento").text(formatoDecimal(parseFloat(descuentos).toFixed(2)));
                   $("#impuesto").text(formatoDecimal(parseFloat(impuestos).toFixed(2)));
                   $("#total").text(formatoDecimal(parseFloat(totalComprobante).toFixed(2)));
                   $("#tOCargos").text(formatoDecimal(parseFloat(oCargos).toFixed(2)));
                   $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
                   $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));
                   $("#impuesto4").text(formatoDecimal(parseFloat(impuesto4).toFixed(2)));
                   $("#impuesto8").text(formatoDecimal(parseFloat(impuesto8).toFixed(2)));
                   $("#impuesto13").text(formatoDecimal(parseFloat(impuesto13).toFixed(2)));

                   if (ProdCadena.length > 0) {
                       $("#CodMoneda").select2({ disabled: true });
                   } else {
                       $("#CodMoneda").select2({ disabled: false });
                   }
                   LimpiarDatos();

                   RellenaTabla();
               } else {
                   Swal.fire({
                       icon: 'error',
                       title: 'Oops...',
                       text: 'Pareciera que la moneda especificada no es la misma que la factura.'

                   });
               }
           }
           else {
               Swal.fire({
                   icon: 'error',
                   title: 'Oops...',
                   text: 'Pareciera que aún falta un campo por llenar'

               });
           }
        }
        function LimpiarDatos() {
            $("#Proveedor").text("");
            $("#monedaFactura").val("");

            $("#CHacienda").text("");
            $("#FechaFac").text("");


            $("#SubTotal").text("");

            $("#Impuesto").text("");
            $("#Descuento").text("");
            //$("#idTipoGasto").val("");

            $("#imp1").val(0);
            $("#imp2").val(0);
            $("#imp4").val(0);
            $("#imp8").val(0);
            $("#imp13").val(0);
            $("#otrosCargos").val(0);
            $("#Busqueda").val("")
            $("#adjunto").attr('href', '');
            $("#tipoGasto").text("");
           // $("#Busqueda").val("NULL").trigger('change.select2');
            $("#ComenFac").val("");
            $("#idTipoGastoEditar").val("NULL").trigger('change.select2');
        }

        function RellenaTabla() {
            var sOptions = '';

            $("#tbody").html('');

            for (var i = 0; i < ProdCadena.length; i++) {
                sOptions += '<tr>';

                sOptions += '<td align="center" style="padding-top:13px;">    <a style="margin-left: -1%; position: inherit !important;" onclick = "javascript: EliminaProducto(' + i + ')" title="Eliminar" class="fa fa-trash icono"></a> ';
                sOptions += '<td align="center" style="padding-top:15px;">  <p style="font-size:13px;">' + ProdCadena[i].CHacienda + '</p></td>';
                sOptions += '<td align="center" style="padding-top:15px;">  <p style="font-size:13px;">' + ProdCadena[i].Fecha + '</p></td>';
                sOptions += '<td align="left" style="padding-top:15px;">  <p style="font-size:13px;">' + ProdCadena[i].Proveedor + '</p></td>';
                sOptions += '<td align="right" style="padding-top:13px;">  <p style="font-size:13px;">' + formatoDecimal(ProdCadena[i].Total) + '</p></td>';





                sOptions += '</tr>'
            }
            $("#tbody").html(sOptions);
        }
        function EliminaProducto(campo) {
            console.log("campo: " + campo);
            Swal.fire({
                title: '¿Desea eliminar esta factura?',
                showDenyButton: true,
                showCancelButton: false,
                confirmButtonText: `Aceptar`,
                denyButtonText: `Cancelar`,
                customClass: {
                    confirmButton: 'swalBtnColor',
                    denyButton: 'swalDeny'
                },
            }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {
                    console.log(ProdCadena[campo]);
                    var subtotalT = 0;
                    var descuentoT = 0;
                    var impuestoT = 0;
                    var oCargosT = 0;
                    subtotalT = parseFloat(ProdCadena[campo].SubTotal);
                    descuentoT = parseFloat(ProdCadena[campo].Descuento);
                    impuestoT = parseFloat(ProdCadena[campo].Impuesto);
                    oCargosT = parseFloat(ProdCadena[campo].TotalOtrosCargos);
                    totalT = parseFloat(ProdCadena[campo].Total);

                    subtotal -= subtotalT;
                    descuentos -= descuentoT;
                    impuestos -= impuestoT;
                    oCargos -= oCargosT;
                    totalComprobante -= totalT;
                    var impuesto1T = parseFloat(ProdCadena[campo].Impuesto1);
                    var impuesto2T = parseFloat(ProdCadena[campo].Impuesto2);
                    var impuesto4T = parseFloat(ProdCadena[campo].Impuesto4);
                    var impuesto8T = parseFloat(ProdCadena[campo].Impuesto8);
                    var impuesto13T = parseFloat(ProdCadena[campo].Impuesto13);


                    impuesto1 -= impuesto1T;
                    impuesto2 -= impuesto2T;
                    impuesto4 -= impuesto4T;
                    impuesto8 -= impuesto8T;
                    impuesto13 -= impuesto13T;

                    $("#subtotal").text(formatoDecimal(subtotal.toFixed(2)));
                    $("#descuento").text(formatoDecimal(descuentos.toFixed(2)));
                    $("#impuesto").text(formatoDecimal(impuestos.toFixed(2)));
                    $("#total").text(formatoDecimal(totalComprobante.toFixed(2)));
                    $("#tOCargos").text(formatoDecimal(parseFloat(oCargos).toFixed(2)));
                    $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
                    $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));
                    $("#impuesto4").text(formatoDecimal(parseFloat(impuesto4).toFixed(2)));
                    $("#impuesto8").text(formatoDecimal(parseFloat(impuesto8).toFixed(2)));
                    $("#impuesto13").text(formatoDecimal(parseFloat(impuesto13).toFixed(2)));

                    ProdCadena.splice(campo, 1);
                    if (ProdCadena.length > 0) {
                        $("#CodMoneda").select2({ disabled: true });
                    } else {
                        $("#CodMoneda").select2({ disabled: false });
                    }
                    RellenaTabla();

                }
            })

        }

        @*   function escogeCodigo(i) {

                $("#CodPro").val(ProdCadena[i].codPro).trigger('change');

                $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '@Url.Page("Nuevo", "Producto")',
                    data: { id: ProdCadena[i].codPro },
            success: function (result) {

                console.log(result);

                if (result.codPro != "") {
                    $("#Nombre").val(result.nomPro);
                    $("#PrecioVenta").text( result.costoPro.toFixed(2)) ;
                    $("#Costo").val(ProdCadena[i].PreVta);
                    $("#UnidadMedida").text(result.uniMed);
                    $("#Cantidad").val(ProdCadena[i].cantidad);
                    $("#Descuento").val(ProdCadena[i].descuento),
                        $("#Impuesto").val(ProdCadena[i].impuesto)
                    bandera = true;
                    idP = i;
                    //EliminaProducto(i,i);



                    //$("#Cantidad").val(result.existencia);
                }

            },
            beforeSend: function () {

            },
            complete: function () {

            }
        });
        }









       *@

        function validar(enc) {
            console.log(enc);
            if (enc.SubTotal == "" || enc.SubTotal == null) {

                return false;
            } else if (enc.FechaInicial == "" || enc.FechaInicial == null) {
                return false;
            } else if (ProdCadena.length == 0)
            {
                return false;
            } else if (enc.CodMoneda == "NULL") {
                return false;
            }
            else {
                return true;
            }
        }


        function Generar() {

            var EncCompras =
            {
                idCierre: $("#idCierre").val(),
                Periodo: $("#Periodo").val(),
                CodMoneda: $("#CodMoneda").val(),
                FechaInicial: $("#FechaI").val(),
                FechaFinal: $("#FechaFinal").val(),
                SubTotal: $("#subtotal").text(),
                CodMoneda: $("#CodMoneda").val(),
                Impuestos: $("#impuesto").text(),
                Descuento: $("#descuento").text(),
                Impuesto1: $("#impuesto1").text() ,
                Impuesto2: $("#impuesto2").text()  ,
                Impuesto4: $("#impuesto4").text(),
                Impuesto8: $("#impuesto8").text(),
                Impuesto13: $("#impuesto13").text(),
                TotalOtrosCargos: $("#tOCargos").text(),
                Total: $("#total").text(),
                Observacion: $("#Comentario").val()
            };

            var Cadena = [];

            for (var i = 0; i < ProdCadena.length; i++) {
                var det = {
                    idFactura: ProdCadena[i].id,
                    idTipoGasto: ProdCadena[i].idTipoGasto,
                    Comentario: ProdCadena[i].Comentario
                };
                Cadena.push(det);
            }


            var DetCompras = Cadena;


            var recibido = {
                EncCompras,
                DetCompras
            }


            console.log(JSON.stringify(recibido));

            if (validar(EncCompras)) {

                Swal.fire({
                    title: '¿Desea guardar los cambios de esta liquidación?',
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: `Aceptar`,
                    denyButtonText: `Cancelar`,
                    customClass: {
                        confirmButton: 'swalBtnColor',
                        denyButton: 'swalDeny'
                    },
                }).then((result) => {
                    if (result.isConfirmed) {
                        var recibidos = JSON.stringify(recibido);

                        $.ajax({
                            type: 'POST',

                            url: '@Url.Page("Editar", "Generar")',
                            dataType: 'json',
                            data: { recibidos: recibidos.toString() },
                            headers: {
                                RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                            },
                            success: function (json) {

                                $("#divProcesando").hide();

                                if ($('.modal-backdrop').is(':visible')) {

                                    $('body').removeClass('modal-open');
                                    $('.modal-backdrop').hide();
                                }
                                console.log("resultado " + json.mensaje);
                                if (json.success == true) {
                                    Swal.fire({
                                        title: "Ha sido generado con éxito",

                                        icon: 'success',
                                        showCancelButton: false,

                                        confirmButtonText: 'OK',
                                        customClass: {
                                            confirmButton: 'swalBtnColor',

                                        },
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            location.reload();
                                        }
                                    })

                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: 'Ha ocurrido un error al intentar guardar '

                                    })
                                }
                            },

                            beforeSend: function (xhr) {

                                $("#divProcesando").modal("show");
                            },
                            complete: function () {

                            },
                            error: function (error) {

                            }
                        });
                    }
                }
               )

            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Pareciera que aún falta un campo por llenar'

                });
            }

        }


        function EnviarRevision() {
            Swal.fire({
                title: '¿Desea enviar a revisión esta liquidación?',
                showDenyButton: true,
                showCancelButton: false,
                confirmButtonText: `Aceptar`,
                denyButtonText: `Cancelar`,
                customClass: {
                    confirmButton: 'swalBtnColor',
                    denyButton: 'swalDeny'
                },
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: 'GET',

                        url: '@Url.Page("Editar", "Estado")',
                        dataType: 'text',
                        data: { idB: $("#idCierre").val() },
                        headers: {
                            RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                        },
                        success: function (json) {

                            $("#divProcesando").hide();

                            if ($('.modal-backdrop').is(':visible')) {

                                $('body').removeClass('modal-open');
                                $('.modal-backdrop').hide();
                            }
                            console.log("resultado " + json);
                            if (json == "true") {
                                Swal.fire({
                                    title: "Ha sido enviado con éxito",

                                    icon: 'success',
                                    showCancelButton: false,

                                    confirmButtonText: 'OK',
                                    customClass: {
                                        confirmButton: 'swalBtnColor',

                                    },
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = window.location.href.split("/Editar")[0];
                                    }
                                })

                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: 'Ha ocurrido un error al intentar enviar'

                                })
                            }
                        },

                        beforeSend: function (xhr) {

                            $("#divProcesando").modal("show");
                        },
                        complete: function () {

                        },
                        error: function (error) {

                        }
                    });
                }
            })

        }


        //Generar y Enviar
         function GeneraryEnviar() {

            var EncCompras =
            {
                idCierre: $("#idCierre").val(),
                Periodo: $("#Periodo").val(),

                FechaInicial: $("#FechaI").val(),
                FechaFinal: $("#FechaFinal").val(),
                SubTotal: $("#subtotal").text(),
                CodMoneda: $("#CodMoneda").val(),
                Impuestos: $("#impuesto").text(),
                Descuento: $("#descuento").text(),
                Impuesto1: $("#impuesto1").text() ,
                Impuesto2: $("#impuesto2").text()  ,
                Impuesto4: $("#impuesto4").text(),
                Impuesto8: $("#impuesto8").text(),
                Impuesto13: $("#impuesto13").text(),
                TotalOtrosCargos: $("#tOCargos").text(),
                Total: $("#total").text(),
                Observacion: $("#Comentario").val()
            };

            var Cadena = [];

            for (var i = 0; i < ProdCadena.length; i++) {
                var det = {
                    idFactura: ProdCadena[i].id,
                    idTipoGasto: ProdCadena[i].idTipoGasto,
                    Comentario: ProdCadena[i].Comentario
                };
                Cadena.push(det);
            }


            var DetCompras = Cadena;


            var recibido = {
                EncCompras,
                DetCompras
            }


            console.log(JSON.stringify(recibido));

            if (validar(EncCompras)) {

                Swal.fire({
                    title: '¿Desea guardar y enviar a revisión esta liquidación?',
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: `Aceptar`,
                    denyButtonText: `Cancelar`,
                    customClass: {
                        confirmButton: 'swalBtnColor',
                        denyButton: 'swalDeny'
                    },
                }).then((result) => {
                    if (result.isConfirmed) {
                        var recibidos = JSON.stringify(recibido);

                        $.ajax({
                            type: 'POST',

                            url: '@Url.Page("Editar", "GeneraryEnviar")',
                            dataType: 'json',
                            data: { recibidos: recibidos.toString() },
                            headers: {
                                RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                            },
                            success: function (json) {

                                $("#divProcesando").hide();

                                if ($('.modal-backdrop').is(':visible')) {

                                    $('body').removeClass('modal-open');
                                    $('.modal-backdrop').hide();
                                }
                                console.log("resultado " + json);
                                if (json.success == true) {
                                    Swal.fire({
                                        title: "Ha sido generado con éxito",

                                        icon: 'success',
                                        showCancelButton: false,

                                        confirmButtonText: 'OK',
                                        customClass: {
                                            confirmButton: 'swalBtnColor',

                                        },
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            window.location.href = window.location.href.split("/Editar")[0];
                                        }
                                    })

                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: 'Ha ocurrido un error al intentar guardar'

                                    })
                                }
                            },

                            beforeSend: function (xhr) {

                                $("#divProcesando").modal("show");
                            },
                            complete: function () {

                            },
                            error: function (error) {

                            }
                        });
                    }
                }
               )

            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Pareciera que aún falta un campo por llenar'

                });
            }

        }


        const formatter = new Intl.NumberFormat('es-CR', {
            style: 'currency',
            currency: 'CRC',
            minimumFractionDigits: 0
        })
    </script>

}
@using Newtonsoft.Json;

<div class="row">
    <div class="col-sm-6">
        <div class="ibox ">
            <input hidden id="Liquidacion" value="@JsonConvert.SerializeObject(Model.Objeto)" />
            <div class="ibox-content">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input id="idCierre" hidden />
                <div class="row">
                    <div class="col-sm-6">

                        <label class="col-form-label">Periodo:</label>
                        <div class="form-group row">
                            <div class="col-sm-8">

                                <input type="text" readonly value="@Model.Periodo" id="Periodo" class="form-control">
                            </div>
                        </div>

                        <label class="col-form-label">Fecha Inicial:</label>
                        <div class="form-group row">
                            <div class="col-sm-12">
                                <input type="date" readonly asp-for="filtro.FechaInicio" id="FechaI" class="form-control">

                            </div>
                        </div>
                        <label class="col-form-label">Moneda:</label>
                        <div class="form-group row">
                            <div class="col-sm-12">

                                <select id="CodMoneda" class="form-control  mi-selector">
                                    @*<option value="NULL" selected>-Moneda-</option>*@


                                    <option value="CRC">Colones</option>
                                    <option value="USD">Dólares</option>
                                    <option value="EUR">Euros</option>


                                </select>
                            </div>
                        </div>

                    </div>


                    <div class="col-sm-6">
                        <label class="col-form-label">Usuario:</label>
                        <div class="form-group row">
                            <div class="col-sm-12">
                                <input type="text" readonly id="Cliente" value="@Model.Usuario.Nombre" class="form-control">

                            </div>
                        </div>
                        <label class="col-form-label">Fecha Final:</label>
                        <div class="form-group row">
                            <div class="col-sm-12">
                                <input type="date" readonly asp-for="filtro.FechaFinal" id="FechaFinal" class="form-control">

                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
        <div class="ibox">

            <div class="ibox-content">

                <div class="row">
                    <div class="col-sm-12" style="text-align: right;">
                        <a title="Agregar Factura Manual" id="FacManual" onclick="javascript: AbrirModal();" style="color: #57b846;">+ Agregar Factura Manual</a>
                    </div>
                    <div class="col-sm-12">
                        <label class="col-form-label">Factura:</label>
                        <div class="form-group row">
                            <div class="col-sm-6">
                                <input id="Busqueda" class="form-control" type="number" />

                            </div>
                            <div class="col-sm-3">

                                <button title="Buscar" type="submit" class="btn btn btn-primary" onclick="javascript: onChangeProducto();"> <i class="fa fa-search"></i></button>
                            </div>
                        </div>

                        <input hidden id="sub" type="number" />
                        <input hidden id="desc" type="number" />
                        <input hidden id="imp" type="number" />
                        <input hidden id="monedaFactura" />
                        <input hidden id="imp1" type="number" />
                        <input hidden id="imp2" type="number" />
                        <input hidden id="imp4" type="number" />
                        <input hidden id="imp8" type="number" />
                        <input hidden id="imp13" type="number" />
                        <input hidden id="otrosCargos" type="number" />
                        <label id="Existencia" style="color: red;"> </label>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group row">
                                    <div class="col-sm-12">
                                        <label class="col-form-label">Proveedor:</label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label id="Proveedor" style="line-height: 32px;">
                                        </label>

                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-sm-12">
                                        <label class="col-form-label">Consecutivo:</label>

                                    </div>
                                    <div class="col-sm-12" style="text-align: left;">
                                        <label id="CHacienda" style="line-height: 32px;">
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-sm-12">
                                        <label class="col-form-label">Descuento:</label>

                                    </div>
                                    <div class="col-sm-6" style="text-align: right;">
                                        <label id="Descuento" style="line-height: 32px;">
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-sm-12">
                                        <label class="col-form-label">Tipo Gasto:</label>

                                    </div>
                                    <div class="col-sm-8">


                                        <select id="idTipoGastoEditar" class="form-control  mi-selector">
                                            <option value="0" selected>-Sin Asignar-</option>
                                            @foreach (var item in Model.Gastos)
                                            {
                                                <option value="@item.idTipoGasto">@item.Nombre</option>
                                            }




                                        </select>

                                    </div>



                                </div>

                            </div>
                            <div class="col-sm-6">

                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <label class="col-form-label">Fecha:</label>
                                        <input readonly hidden id="id" />
                                    </div>
                                    <div class="col-sm-12">
                                        <label id="FechaFac" style="line-height: 32px;">
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <label class="col-form-label">SubTotal:</label>
                                    </div>
                                    <div class="col-sm-6" style="text-align: right;">
                                        <label id="SubTotal" style="line-height: 32px;">
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <div class="col-sm-12">
                                        <label class="col-form-label">Impuesto:</label>

                                    </div>
                                    <div class="col-sm-6" style="text-align: right;">
                                        <label id="Impuesto" style="line-height: 32px;">
                                        </label>
                                    </div>
                                </div>


                                <div class="form-group row">
                                    <div class="col-sm-12">
                                        <label class="col-form-label"></label>

                                    </div>
                                    <div class="col-sm-6" style="text-align: right;">
                                        <a href="" target="_blank" id="adjunto" title="Mirar Adjunto de la Factura" class="fa fa-paperclip icono"></a>
                                    </div>
                                </div>


                            </div>
                            <div class="col-sm-12">
                                <div class="form-group row">
                                    <div class="col-sm-12">
                                        <label class="col-form-label">Comentario:</label>

                                    </div>
                                    <div class="col-sm-12" style="text-align: right;">
                                        <input class="form-control" maxlength="100" id="ComenFac" />
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-sm-6">




                    </div>
                </div>

            </div>
        </div>
        <div class="row">

            <div class="col-sm-12" style="text-align: center;">
                <a title="Eliminar" onclick="javascript: LimpiarDatos();" style="width: 25%;" class="btn btnpage">Cancelar</a>&nbsp;
                <a title="Agregar" id="Agregar" onclick="javascript: InsertarProductoTabla();" style=" color: #fff; width: 25%;" class="btn btn-primary">Asignar</a>
            </div>
        </div>

        <br />
        <div class="ibox">
            <div class="row">
                <div class="col-sm-12">
                    <label class="col-form-label">Observación:</label>
                </div>
                <div class="col-sm-12">
                    <textarea rows="5" class="form-control" asp-for="Liquidacion.EncCierre.Observacion" id="Comentario"></textarea>
                </div>
            </div>
        </div>

    </div>
    <div class="col-sm-6">
        <div class="ibox">

            <div class="ibox-content lista">

                <div class="row">
                    <div class="col-sm-12">
                        <div class="table-responsive tableFixHead" style=" overflow-y:scroll;    z-index: 5; height: 300px;">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th align="center" style=" text-align: center;"><h3>Eliminar</h3></th>
                                        <th align="center" style=" text-align: center;"><h3>Cons. Hacienda</h3></th>
                                        <th align="center" style=" text-align: center;"><h3>Fecha </h3></th>
                                        <th align="center" style=" text-align: center;"><h3>Proveedor</h3></th>
                                        <th align="center" style=" text-align: center;"><h3>Total</h3></th>


                                    </tr>

                                </thead>
                                <tbody id="tbody">
                                </tbody>
                            </table>

                        </div>
                    </div>


                </div>
                <hr />
                <div class="row">
                    <div class="col-sm-6">
                    </div>
                    <div class="col-sm-6" style="text-align: right;">
                        <div class="row">

                            <div class="col-sm-12">

                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table; font-weight: 500 !important; font-style: normal;">SubTotal:</label>

                                            </td>
                                            <td>
                                                <label id="subtotal" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>

                                        </tr>
                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Descuento:</label>

                                            </td>
                                            <td>
                                                <label id="descuento" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>
                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Impuesto:</label>

                                            </td>
                                            <td>
                                                <label id="impuesto" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>
                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 1:</label>

                                            </td>
                                            <td>
                                                <label id="impuesto1" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>

                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 2:</label>

                                            </td>
                                            <td>
                                                <label id="impuesto2" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>

                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 4:</label>

                                            </td>
                                            <td>
                                                <label id="impuesto4" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>

                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 8:</label>

                                            </td>
                                            <td>
                                                <label id="impuesto8" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>

                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 13:</label>

                                            </td>
                                            <td>
                                                <label id="impuesto13" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>
                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Otros Cargos:</label>

                                            </td>
                                            <td>
                                                <label id="tOCargos" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>
                                        <tr>

                                            <td style="text-align: center;">
                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Total:</label>

                                            </td>
                                            <td>
                                                <label id="total" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>


                    </div>


                </div>


            </div>
        </div>


        <div class="d-flex justify-content-end">
            <button onclick="javascript: Generar();" class="btn btn-w-m btn-primary botonAbajo" id="GuardarCambios" title="Guardar">Guardar Cambios</button> &nbsp;
            @*<button onclick="javascript: EnviarRevision();" id="btnEnviarRevision botonAbajo" class="btn btn-w-m btn-success" title="Enviar a Revisión">Enviar a Revisión</button>
            &nbsp;*@
            <button onclick="javascript: GeneraryEnviar();" class="btn btn-w-m btn-warning botonAbajo" title="Guardar y enviar a revisión">Guardar y Aprobar</button>
        </div>
    </div>
</div>
<!--Programacion del modal-->

<div class="modal fade bd-example-modal-lg" id="ModalInclusion" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="exampleModalLongTitle">Inclusión de Factura Manual</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">

                <div class="ibox">
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-6">
                                <center>
                                    <img id="imgPrincipalG" src="/img/cm.jpg" alt="image" style="width:250px; height:250px;border-radius: 15px;" class="img-fluid" />
                                    <br />
                                    <br />

                                    <label style="font-size: 13px;" class="label" for="imgPrincipalUploadG">Subir Imagen</label><input id="imgPrincipalUploadG" accept=".jpg, .png" style="opacity:0; display:none;" type="file" name="imgPrincipalUploadG" />

                                </center>
                            </div>
                            <div class="col-sm-6">



                                <label class="col-form-label">Tipo Indentificación:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12" style="text-align: center;">
                                        <input type="radio" name="idProveedor" id="idProveedor1" onclick="javascript: mask2();" value="01"> Física &nbsp;
                                        <input type="radio" name="idProveedor" id="idProveedor2" onclick="javascript: mask2();" value="02"> Jurídica &nbsp;
                                        <input type="radio" name="idProveedor" id="idProveedor3" onclick="javascript: mask2();" value="03"> DIMEX &nbsp;
                                        <input type="radio" name="idProveedor" id="idProveedor4" onclick="javascript: mask2();" value="04"> NITE
                                    </div>
                                </div>


                                <label class="col-form-label">Cédula Proveedor:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" id="CodProveedor" class="form-control">
                                    </div>
                                </div>

                                <label class="col-form-label">Nombre Proveedor:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" asp-for="Objeto1.EncCompras.NomProveedor" id="NomProveedor" class="form-control">
                                    </div>
                                </div>


                                <label class="col-form-label">Número Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" asp-for="Objeto1.EncCompras.NumFactura" id="NumFactura" class="form-control" maxlength="5" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" placeholder="Digite los últimos 5 dígitos del consecutivo en caso de ser electronica">
                                    </div>
                                </div>

                                <label class="col-form-label">Fecha Factura:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="date" asp-for="Objeto1.EncCompras.FecFactura" id="FecFactura" class="form-control">
                                    </div>
                                </div>






                                <label class="col-form-label">Tipo Documento:</label>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Regimen Simplificado
                                            <input type="checkbox" id="simp" onchange="javascript: check('1');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura Exterior
                                            <input type="checkbox" id="ext" onchange="javascript: check('2');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12">
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Gastos Varios
                                            <input type="checkbox" id="var" onchange="javascript: check('3');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                    <div class="col-sm-12" hidden>
                                        <label class="checkbox" style="text-decoration: none; font-size: 13px;">
                                            Factura No Recibida
                                            <input type="checkbox" id="nrec" onchange="javascript: check('4');">
                                            <span class="check"></span>
                                        </label>
                                    </div>
                                </div>



                            </div>

                        </div>
                     
                    </div>
                </div>
              
                <div class="ibox">
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-3">
                                <label class="col-form-label">Detalle:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="text" maxlength="200" id="NomPro" class="form-control">
                                    </div>
                                </div>

                                <label class="col-form-label">Monto Descuento:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" id="descI" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3">

                                <label class="col-form-label">Tipo Impuesto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="TipoImpuesto" class="form-control  ">
                                            <option value="NULL" selected>-IVA-</option>

                                            <option value="0">I.V.A 0</option>
                                            <option value="1">I.V.A 1</option>
                                            <option value="2">I.V.A 2</option>
                                            <option value="4">I.V.A 4</option>
                                            <option value="8">I.V.A 8</option>
                                            <option value="13">I.V.A 13</option>


                                        </select>
                                    </div>
                                </div>
                                <label class="col-form-label">Tipo Gasto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <select id="idTipoGasto" class="form-control ">
                                            <option value="NULL" selected>-Tipo Gasto-</option>
                                            @foreach (var item in Model.Gastos)
                                            {
                                                <option value="@item.idTipoGasto">@item.Nombre</option>
                                            }




                                        </select>
                                    </div>
                                </div>

                            </div>
                            <div class="col-sm-3">

                                <label class="col-form-label">Monto Impuesto:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" id="ImpuestoMonto" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <label class="col-form-label">Precio Unitario:</label>
                                <div class="form-group row">
                                    <div class="col-sm-12">

                                        <input type="number" id="PrecUniI" class="form-control">
                                    </div>
                                </div>






                            </div>
                            <div class="col-sm-12">
                                <div class="row">
                                    <div class="col-sm-8"></div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        @*<button onclick="javascript: AgregarProductosI();" class="btn btn-w-m btn-primary" title="Agregar a la lista">+ Agregar</button>*@
                                        <button id="buttonSpin" onclick="javascript: EnviarFC();" class="ladda-button green expand-left"><span class="label-submit">Guardar Cambios</span> <span class="spinner"></span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ibox" hidden>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-sm-12">

                                <div class="table-responsive tableFixHead" style=" overflow-y:scroll;    z-index: 5; height: 300px;">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th align="center" style=" text-align: center;"><h3>Nombre</h3></th>

                                                <th align="center" style=" text-align: center;"><h3>Precio Unitario</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Descuento</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Impuesto</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Total</h3></th>
                                                <th align="center" style=" text-align: center;"><h3>Eliminar</h3></th>


                                            </tr>

                                        </thead>
                                        <tbody id="tbodyI">
                                        </tbody>
                                    </table>

                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-8">
                                        <label class="text-danger" id="ErrorFactura" style="display: none;"> Ha ocurrido un error al intentar insertar la factura, por favor volver a intentar</label>
                                        <label class="text-danger" id="FaltaDatos" style="display: none;"> Parecen que faltan datos por rellenar</label>
                                    </div>
                                    <div class="col-sm-4" style="text-align: right;">
                                        <div class="row">

                                            <div class="col-sm-12">

                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table; font-weight: 500 !important; font-style: normal;">SubTotal:</label>

                                                            </td>
                                                            <td>
                                                                <label id="subtotalI" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>

                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Descuento:</label>

                                                            </td>
                                                            <td>
                                                                <label id="descuentoI" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Impuesto:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuestoI" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 1:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto1I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 2:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto2I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 4:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto4I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 8:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto8I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>

                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> I.V.A 13:</label>

                                                            </td>
                                                            <td>
                                                                <label id="impuesto13I" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>


                                                       
                                                        <tr>

                                                            <td style="text-align: center;">
                                                                <label class="col-form-label" style="display: inline-table;  font-weight: 500 !important; font-style: normal;"> Total:</label>

                                                            </td>
                                                            <td>
                                                                <label id="totalI" style="display: inline-table;  font-weight: bold !important; font-style: normal;">0</label>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>


                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--<div class="d-flex justify-content-end">-->
                    @*<button onclick="javascript: GenerarI();" class="btn btn-w-m btn-primary" title="Guardar">Guardar Cambios</button>*@
                    <!--<button id="buttonSpin" onclick="javascript: GenerarI();" class="ladda-button green expand-left"><span class="label-submit">Guardar Cambios</span> <span class="spinner"></span></button>
                </div>-->

            </div>
        </div>
    </div>
</div>

<script>
    var ImageBae64 = '';
    var Productos = [];
    var subtotalI = 0;
    var impuestosI = 0;
    var descuentosI = 0;
    var totalComprobanteI = 0;

    var impuestoI1 = 0;
    var impuestoI2 = 0;
    var impuestoI4 = 0;
    var impuestoI8 = 0;
    var impuestoI13 = 0;


    async function readFilePrincipal(input) {
        if (input.files && input.files[0]) {
            /*const maxAllowSize = 512000;*/
            //const maxAllowSize = 2800000;
            const maxAllowSize = 5000000;
            if (input.files[0].size > maxAllowSize) {
                alert("Esta imagen es muy pesada");
                input.value = '';
            } else {
                var reader = new FileReader();
                var img = document.createElement("img");
                var canvas = document.createElement('canvas');

                reader.onload = function (e) {
                    img.src = e.target.result;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);

                    var MAX_WIDTH = 800;
                    var MAX_HEIGHT = 600;
                    var width = img.width;
                    var height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    var dataurl = canvas.toDataURL("image/jpg");
                    document.getElementById('imgPrincipalG').src = e.target.result;
                   
                   // console.log(dataurl);
                    ImageBae64 = dataurl;//e.target.result;
                     
                    //var idF = setInterval(cancelar, 3000);

                    //function cancelar() {
                    //    console.log("cancelar -> " +ImageBae64);
                    //    if (ImageBae64 != "data:,") {
                    //        clearInterval(idF);
                    //    }
                    //}
                }

            }

            reader.readAsDataURL(input.files[0]);
        }



    }
     
    var fileUploadPrincipal = document.getElementById('imgPrincipalUploadG');
    fileUploadPrincipal.onchange = async function (e) {
        await readFilePrincipal(e.srcElement);
        var idF = setInterval(async function () {

            if (ImageBae64 != "data:,") {
                //alert("Imagen agregada con éxito");
                clearInterval(idF);
            } else {
                await readFilePrincipal(e.srcElement);
            }
        }, 1500);
        
    }

    function check(i) {

        var checkbox1 = document.getElementById("simp");
        var checkbox2 = document.getElementById("ext");
        var checkbox3 = document.getElementById("var");
        var checkbox4 = document.getElementById("nrec");
        if (i == "1") {

            checkbox2.checked = false;
            checkbox3.checked = false;
            checkbox1.checked = true;
            $("#CHacienda").removeAttr("readonly");
            $("#ConsHacienda").removeAttr("readonly");

        }
        else if (i == "2") {
            checkbox3.checked = false;
            checkbox2.checked = true;
            checkbox1.checked = false;
            $("#CHacienda").attr("readonly", "readonly");
            $("#ConsHacienda").attr("readonly", "readonly");

            $("#CHacienda").val("");
            $("#ConsHacienda").val("");
        } else if (i == "3") {
            checkbox3.checked = true;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = false;
        } else {
            checkbox3.checked = false;
            checkbox2.checked = false;
            checkbox1.checked = false;
            checkbox4.checked = true;
        }
    }
    function AbrirModal() {
        $("#ModalInclusion").modal("show");
    }
    function AgregarProductosI() {


        var detalle = {

            CodPro: "1",
            NomPro: $("#NomPro").val(),
            idTipoGasto: $("#idTipoGasto").val() == "NULL" ? "0" : $("#idTipoGasto").val(),
            Cantidad: "1",
            PrecioUnitario: $("#PrecUniI").val(),
            MontoDescuento: $("#descI").val(),
            ImpuestoTarifa: $("#TipoImpuesto").val(),
            ImpuestoMonto: $("#ImpuestoMonto").val(),
            MontoTotalLinea: 0,
            Impuesto1: 0,
            Impuesto2: 0,
            Impuesto4: 0,
            Impuesto8: 0,
            Impuesto13: 0
        };

        switch ($("#TipoImpuesto").val()) {
            case "1":
                {
                    detalle.Impuesto1 += detalle.ImpuestoMonto;
                    break;
                }
            case "2":
                {
                    detalle.Impuesto2 += detalle.ImpuestoMonto;
                    break;
                }
            case "4":
                {
                    detalle.Impuesto4 += detalle.ImpuestoMonto;
                    break;
                }
            case "8":
                {
                    detalle.Impuesto8 += detalle.ImpuestoMonto;
                    break;
                }
            case "13":
                {
                    detalle.Impuesto13 += detalle.ImpuestoMonto;
                    break;
                }
        }

        detalle.MontoTotalLinea = ((detalle.PrecioUnitario) - detalle.MontoDescuento) + parseFloat(detalle.ImpuestoMonto);

        var subtotalT = 0;
        var descuentoT = 0;
        var impuestoT = 0;
        var totalT = 0;
        subtotalT = parseFloat(detalle.PrecioUnitario);
        descuentoT = parseFloat(detalle.MontoDescuento);
        impuestoT = parseFloat(detalle.ImpuestoMonto);
        totalT = parseFloat(detalle.MontoTotalLinea);

        subtotalI += subtotalT;
        descuentosI += descuentoT;
        impuestosI += impuestoT;

        totalComprobanteI += totalT;

        var impuesto1T = parseFloat(detalle.Impuesto1);
        var impuesto2T = parseFloat(detalle.Impuesto2);
        var impuesto4T = parseFloat(detalle.Impuesto4);
        var impuesto8T = parseFloat(detalle.Impuesto8);
        var impuesto13T = parseFloat(detalle.Impuesto13);


        impuestoI1 += impuesto1T;
        impuestoI2 += impuesto2T;
        impuestoI4 += impuesto4T;
        impuestoI8 += impuesto8T;
        impuestoI13 += impuesto13T;


        $("#subtotalI").text(formatoDecimal(subtotalI.toFixed(2)));
        $("#descuentoI").text(formatoDecimal(descuentosI.toFixed(2)));
        $("#impuestoI").text(formatoDecimal(impuestosI.toFixed(2)));
        $("#totalI").text(formatoDecimal(totalComprobanteI.toFixed(2)));


        $("#impuesto1I").text(formatoDecimal(parseFloat(impuestoI1).toFixed(2)));
        $("#impuesto2I").text(formatoDecimal(parseFloat(impuestoI2).toFixed(2)));
        $("#impuesto4I").text(formatoDecimal(parseFloat(impuestoI4).toFixed(2)));
        $("#impuesto8I").text(formatoDecimal(parseFloat(impuestoI8).toFixed(2)));
        $("#impuesto13I").text(formatoDecimal(parseFloat(impuestoI13).toFixed(2)));


        Productos.push(detalle);
        LimpiarDatosI();
        RellenaTablaI();
    }
    function LimpiarDatosI() {

        $("#NomPro").val("");

        $("#PrecUniI").val(0);
        $("#descI").val(0);
        $("#TipoImpuesto").val("0").trigger('change');
        $("#idTipoGasto").val("NULL").trigger('change');
        $("#ImpuestoMonto").val(0);

    }

    function RellenaTablaI() {
        var texto = '';

        $("#tbodyI").html('');

        for (var i = 0; i < Productos.length; i++) {
            texto += '<tr>';

            texto += '<td align="left" style="padding-top:15px;">  <p style="font-size:13px;">' + Productos[i].NomPro + '</p></td>';

            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].PrecioUnitario) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].MontoDescuento) + '</p></td>';
            texto += '<td align="right" style="padding-top:15px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].ImpuestoMonto) + '</p></td>';
            texto += '<td align="right" style="padding-top:13px;">  <p style="font-size:13px;">' + formatoDecimal(Productos[i].MontoTotalLinea) + '</p></td>';
            texto += '<td align="center" style="padding-top:13px;">    <a style="margin-left: -1%; position: inherit !important;" onclick = "javascript: EliminaProductoI(' + i + ')" title="Eliminar" class="fa fa-trash icono"></a> ';
            texto += '</tr>'
        }
        $("#tbodyI").html(texto);
    }

    function EliminaProductoI(campo) {


                var subtotalT = 0;
                var descuentoT = 0;
                var impuestoT = 0;
        var totalT = 0;
                subtotalT = parseFloat(Productos[campo].PrecioUnitario);
                descuentoT = parseFloat(Productos[campo].MontoDescuento);
                impuestoT = parseFloat(Productos[campo].ImpuestoMonto);

                totalT = parseFloat(Productos[campo].MontoTotalLinea);

                subtotalI -= subtotalT;
                descuentosI -= descuentoT;
                impuestosI -= impuestoT;

                totalComprobanteI -= totalT;

                var impuesto1T = parseFloat(Productos[campo].Impuesto1);
                var impuesto2T = parseFloat(Productos[campo].Impuesto2);
                var impuesto4T = parseFloat(Productos[campo].Impuesto4);
                var impuesto8T = parseFloat(Productos[campo].Impuesto8);
                var impuesto13T = parseFloat(Productos[campo].Impuesto13);


                impuestoI1 -= impuesto1T;
                impuestoI2 -= impuesto2T;
                impuestoI4 -= impuesto4T;
                impuestoI8 -= impuesto8T;
                impuestoI13 -= impuesto13T;


                $("#subtotalI").text(formatoDecimal(subtotalI.toFixed(2)));
                $("#descuentoI").text(formatoDecimal(descuentosI.toFixed(2)));
                $("#impuestoI").text(formatoDecimal(impuestosI.toFixed(2)));
                $("#totalI").text(formatoDecimal(totalComprobanteI.toFixed(2)));


                $("#impuesto1I").text(formatoDecimal(parseFloat(impuestoI1).toFixed(2)));
                $("#impuesto2I").text(formatoDecimal(parseFloat(impuestoI2).toFixed(2)));
                $("#impuesto4I").text(formatoDecimal(parseFloat(impuestoI4).toFixed(2)));
                $("#impuesto8I").text(formatoDecimal(parseFloat(impuestoI8).toFixed(2)));
                $("#impuesto13I").text(formatoDecimal(parseFloat(impuestoI13).toFixed(2)));

                Productos.splice(campo, 1);
                RellenaTablaI();


    }



    function mask() {
        switch ($("#idCliente").val()) {
            case "01":
                {
                    $("#CodCliente").inputmask({ "mask": "9-9999-9999" });
                    break;
                }
            case "02":
                {
                    $("#CodCliente").inputmask({ "mask": "9-999-999999" });
                    break;
                }
            case "03":
                {
                    $("#CodCliente").inputmask({ "mask": "999999999999" });
                    break;
                }
            case "04":
                {
                    $("#CodCliente").inputmask({ "mask": "9999999999" });
                    break;
                }
            default:
                {
                    break;
                }
        }
    }
    function mask2() {
        switch ($("input:radio[name=idProveedor]:checked").val()) {
            case "01":
                {
                    $("#CodProveedor").inputmask({ "mask": "9-9999-9999" });
                    break;
                }
            case "02":
                {
                    $("#CodProveedor").inputmask({ "mask": "9-999-999999" });
                    break;
                }
            case "03":
                {
                    $("#CodProveedor").inputmask({ "mask": "999999999999" });
                    break;
                }
            case "04":
                {
                    $("#CodProveedor").inputmask({ "mask": "9999999999" });
                    break;
                }
            default:
                {
                    break;
                }
        }
    }

              function GenerarI()
              {
                  var button = document.getElementById('buttonSpin');
                  if (typeof (button.getAttribute('data-loading')) === 'string') {
                      button.removeAttribute('data-loading');
                  }
                  else {
                      button.setAttribute('data-loading', '');
                  }

                 var checkbox1 = document.getElementById("simp");
                  var checkbox2 = document.getElementById("ext");
                  var checkbox3 = document.getElementById("var");
                  var checkbox4 = document.getElementById("nrec");
                 var EncCompras =
                    {
                        ClaveHacienda: $("#NumFactura").val(),
                        ConsecutivoHacienda: $("#NumFactura").val(),
                        TipoIdentificacionCliente: "0",
                        NumFactura: $("#NumFactura").val(),
                        CodProveedor: $("#CodProveedor").val(),
                        NomProveedor: $("#NomProveedor").val(),
                        FecFactura: $("#FecFactura").val(),
                        CodigoActividadEconomica: "0" ,
                        CodMoneda: $("#CodMoneda").val(),
                        CodCliente: "0",
                        NomCliente: "0",
                        TotalVenta: $("#subtotalI").text(),
                        TotalImpuesto: $("#impuestoI").text(),
                        TotalDescuentos: $("#descuentoI").text(),
                        Impuesto1: $("#impuesto1I").text() ,
                        Impuesto2: $("#impuesto2I").text()  ,
                        Impuesto4: $("#impuesto4I").text(),
                        Impuesto8: $("#impuesto8I").text(),
                        Impuesto13: $("#impuesto13I").text(),
                        TotalComprobante: $("#totalI").text(),
                        ImagenBase64: (ImageBae64 === '' ? '' : ImageBae64.toString().replace('data:image/jpeg;base64,', '').replace('data:image/png;base64,', '')),
                        RegimenSimplificado: checkbox1.checked,
                     FacturaExterior: checkbox2.checked,
                     GastosVarios: checkbox3.checked,
                     FacturaNoRecibida: false//checkbox4.checked
                    };

                    var DetCompras = Productos;
                    var recibido = {
                            EncCompras,
                            DetCompras
                        };

                        var recibidos = JSON.stringify(recibido);
                  if (ValidarFactura()) {
                      $("#FaltaDatos").css("display", "none");
                      $.ajax({
                          type: 'POST',

                          url: '@Url.Page("Editar", "Insertar")',
                          datatype: "application/json",
                          data: { recibidos: recibidos.toString() },
                          headers: {
                              RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                          },
                          success: function (json) {

                              console.log(json);
                              if (json.success == true) {
                                  button.removeAttribute('data-loading');
                                  $("#ErrorFactura").css("display", "none");
                                  //Aqui se meteria en el detalle
                                  var detalle = {
                                      id: json.resp,
                                      Proveedor: EncCompras.NomProveedor,
                                      CHacienda: EncCompras.NumFactura,
                                      //    idTipoGasto: $("#idTipoGasto").val(),
                                      Fecha: EncCompras.FecFactura,
                                      SubTotal: parseFloat(EncCompras.TotalVenta.replace(",", "")),
                                      Descuento: parseFloat(EncCompras.TotalDescuentos.replace(",", "")),
                                      Impuesto: parseFloat(EncCompras.TotalImpuesto.replace(",", "")),
                                      Total: 0,
                                      Impuesto1: parseFloat(EncCompras.Impuesto1.replace(",", "")),
                                      Impuesto2: parseFloat(EncCompras.Impuesto2.replace(",", "")),
                                      Impuesto4: parseFloat(EncCompras.Impuesto4.replace(",", "")),
                                      Impuesto8: parseFloat(EncCompras.Impuesto8.replace(",", "")),
                                      Impuesto13: parseFloat(EncCompras.Impuesto13.replace(",", "")),
                                      idTipoGasto: Productos[0].idTipoGasto,
                                      TotalOtrosCargos: 0,
                                      Comentario: ""
                                  };

                                  console.log(EncCompras);
                                  console.log(detalle);
                                  var subtotalT = 0;
                                  var descuentoT = 0;
                                  var impuestoT = 0;
                                  var totalT = 0;
                                  subtotalT = parseFloat(detalle.SubTotal);
                                  descuentoT = parseFloat(detalle.Descuento);
                                  impuestoT = parseFloat(detalle.Impuesto);
                                  detalle.Total = (subtotalT - descuentoT) + impuestoT
                                  ProdCadena.push(detalle);
                                  totalT = parseFloat(detalle.Total);
                                  var impuesto1T = parseFloat(detalle.Impuesto1);
                                  var impuesto2T = parseFloat(detalle.Impuesto2);
                                  var impuesto4T = parseFloat(detalle.Impuesto4);
                                  var impuesto8T = parseFloat(detalle.Impuesto8);
                                  var impuesto13T = parseFloat(detalle.Impuesto13);




                                  subtotal += subtotalT;
                                  descuentos += descuentoT;
                                  impuestos += impuestoT;

                                  totalComprobante += totalT;
                                  impuesto1 += impuesto1T;
                                  impuesto2 += impuesto2T;
                                  impuesto4 += impuesto4T;
                                  impuesto8 += impuesto8T;
                                  impuesto13 += impuesto13T;

                                  $("#subtotal").text(formatoDecimal(parseFloat(subtotal).toFixed(2)));
                                  $("#descuento").text(formatoDecimal(parseFloat(descuentos).toFixed(2)));
                                  $("#impuesto").text(formatoDecimal(parseFloat(impuestos).toFixed(2)));
                                  $("#total").text(formatoDecimal(parseFloat(totalComprobante).toFixed(2)));

                                  $("#impuesto1").text(formatoDecimal(parseFloat(impuesto1).toFixed(2)));
                                  $("#impuesto2").text(formatoDecimal(parseFloat(impuesto2).toFixed(2)));
                                  $("#impuesto4").text(formatoDecimal(parseFloat(impuesto4).toFixed(2)));
                                  $("#impuesto8").text(formatoDecimal(parseFloat(impuesto8).toFixed(2)));
                                  $("#impuesto13").text(formatoDecimal(parseFloat(impuesto13).toFixed(2)));
                                  LimpiarDatos();

                                  RellenaTabla();
                                  LimpiarDatosGenerales();

                                  $("#ModalInclusion").modal("hide");

                              } else {
                                  $("#ErrorFactura").text(json.resp);
                                  $("#ErrorFactura").css("display", "block");
                                  button.removeAttribute('data-loading');

                              }
                          },

                          beforeSend: function (xhr) {


                          },
                          complete: function () {

                          },
                          error: function (error) {
                              button.removeAttribute('data-loading');
                              $("#ErrorFactura").css("display", "block");


                          }
                      });
                  } else {
                      $("#FaltaDatos").css("display", "block");
                      button.removeAttribute('data-loading');
                  }
    }

    function LimpiarDatosGenerales() {
        $("#NumFactura").val("");
        $("#CodProveedor").val("");
        $("#NomProveedor").val("");
        $("#FecFactura").val("");
        $("#subtotalI").text("0");
        $("#impuestoI").text("0");
        $("#descuentoI").text("0");
        $("#impuesto1I").text("0");
        $("#impuesto2I").text("0");
        $("#impuesto4I").text("0");
        $("#impuesto8I").text("0");
        $("#impuesto13I").text("0");
        $("#totalI").text("0");
        ImagenBase64 = "";
        Productos = [];

        subtotalT = 0;
        descuentoT = 0;
         impuestoT = 0;
        totalT = 0;

         impuesto1T = 0;
         impuesto2T = 0;
         impuesto4T = 0;
         impuesto8T = 0;
        impuesto13T = 0;

         subtotalI = 0;
         impuestosI = 0;
         descuentosI = 0;
         totalComprobanteI = 0;

         impuestoI1 = 0;
         impuestoI2 = 0;
         impuestoI4 = 0;
         impuestoI8 = 0;
        impuestoI13 = 0;
        document.getElementById('imgPrincipalG').src = "/img/cm.jpg";
        ImageBae64 = "";
        LimpiarDatosI();
        RellenaTablaI();
    }
    function ValidarFactura() {
        if ($("#NumFactura").val() == "") {
            return false;
        } else if ($("#CodProveedor").val() == "") {
            return false;
        } else if ($("#NomProveedor").val() == "") {
            return false;
        } else if ($("#FecFactura").val() == "") {
            return false;
        } else if (Productos.length == 0) {
            return false;
        } else if (ImageBae64 == "") {
            return false;
        }
        else {
            return true;
        }
    }

    async function EnviarFC() {
        AgregarProductosI();
        GenerarI();

    }
</script>